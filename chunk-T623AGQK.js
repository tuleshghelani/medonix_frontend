import"./chunk-5P6E35H2.js";import{a as Ce,b as Me,d as Oe,e as xe,g as ye,h as Se}from"./chunk-QQS45VC6.js";import{$ as d,A as se,Ab as me,C as A,Ca as N,D as w,Da as ce,Db as $,Eb as pe,Fb as he,Gb as B,H as C,Ha as S,I as v,Ja as F,Lb as ge,Mb as fe,Nb as U,Ob as Pe,Pa as T,Pb as Y,Qa as D,R as s,Ra as z,S as u,Sa as L,Sb as Q,Tb as be,Ua as le,Va as de,Wb as x,Xa as k,Xb as _e,Yb as K,Z as g,_a as j,a as ie,ba as M,ea as n,f as oe,fa as i,ga as l,ja as y,ma as p,na as f,rc as H,sb as V,sc as W,ta as a,tb as _,tc as ve,u as re,ua as O,ub as q,uc as J,va as I,vb as G,vc as X,wb as ue,wc as Fe,x as ae,y as E,zb as R}from"./chunk-4KO3NHKN.js";var ee=(()=>{class o{constructor(e){this.http=e,this.apiUrl=`${_e.apiUrl}/api/purchases`}searchPurchases(e){return this.http.post(`${this.apiUrl}/searchPurchase`,e)}createPurchase(e){return this.http.post(`${this.apiUrl}/create`,e)}updatePurchase(e){return this.http.post(`${this.apiUrl}/create`,e)}deletePurchase(e){return this.http.delete(`${this.apiUrl}/${e}`)}getPurchaseDetails(e){return this.http.post(`${this.apiUrl}/detail`,{id:e})}static{this.\u0275fac=function(t){return new(t||o)(se(j))}}static{this.\u0275prov=ae({token:o,factory:o.\u0275fac,providedIn:"root"})}}return o})();var qe=()=>({label:"All Customers",value:""});function Ge(o,h){if(o&1){let e=y();n(0,"tr")(1,"td"),a(2),i(),n(3,"td"),a(4),i(),n(5,"td"),a(6),i(),n(7,"td"),a(8),S(9,"date"),i(),n(10,"td"),a(11),i(),n(12,"td",26)(13,"button",27),p("click",function(){let r=C(e).$implicit,c=f();return v(c.editPurchase(r.id))}),l(14,"i",28),i(),n(15,"button",29),p("click",function(){let r=C(e).$implicit,c=f();return v(c.deletePurchase(r.id))}),l(16,"i",30),i()()()}if(o&2){let e,t=h.$implicit,r=h.index,c=f();s(2),O(c.startIndex+r+1),s(2),O(t.invoiceNumber),s(2),O(t.customerName),s(2),O(F(9,5,t.purchaseDate,"dd-MM-yyyy")),s(3),O((e=t.totalPurchaseAmount)!==null&&e!==void 0?e:0)}}function Re(o,h){if(o&1){let e=y();n(0,"app-pagination",31),p("pageChange",function(r){C(e);let c=f();return v(c.onPageChange(r))})("pageSizeChange",function(r){C(e);let c=f();return v(c.onPageSizeChange(r))}),i()}if(o&2){let e=f();d("currentPage",e.currentPage)("pageSize",e.pageSize)("totalElements",e.totalElements)("pageSizeOptions",e.pageSizeOptions)}}function $e(o,h){if(o&1){let e=y();n(0,"app-sale-modal",32),p("saleCreated",function(){C(e);let r=f();return v(r.loadPurchases())}),i()}if(o&2){let e=f();d("purchase",e.selectedPurchase)}}var Ie=(()=>{class o{constructor(e,t,r,c,m,P,b,te,Ae,we){this.purchaseService=e,this.customerService=t,this.fb=r,this.snackbar=c,this.dialog=m,this.modalService=P,this.dateUtils=b,this.cacheService=te,this.encryptionService=Ae,this.router=we,this.purchases=[],this.isLoading=!1,this.currentPage=0,this.pageSize=10,this.pageSizeOptions=[5,10,25,50,100],this.totalPages=0,this.totalElements=0,this.startIndex=0,this.endIndex=0,this.selectedPurchase=null,this.products=[],this.isLoadingProducts=!1,this.customers=[],this.isLoadingCustomers=!1,this.initializeForm()}ngOnInit(){this.loadPurchases(),this.loadCustomers()}initializeForm(){this.searchForm=this.fb.group({search:[""],customerId:[""],startDate:[""],endDate:[""],batchNumber:[""]})}loadPurchases(){this.isLoading=!0;let e=ie({currentPage:this.currentPage,perPageRecord:this.pageSize,startDate:this.searchForm.value.startDate?this.dateUtils.formatDate(this.searchForm.value.startDate):"",endDate:this.searchForm.value.endDate?this.dateUtils.formatDate(this.searchForm.value.endDate):""},this.searchForm.value);this.purchaseService.searchPurchases(e).subscribe({next:t=>{this.purchases=t.content,this.totalPages=t.totalPages,this.totalElements=t.totalElements,this.startIndex=this.currentPage*this.pageSize,this.endIndex=Math.min((this.currentPage+1)*this.pageSize,this.totalElements),this.isLoading=!1},error:t=>{this.snackbar.error(t.message||"Failed to load purchases"),this.isLoading=!1}})}onSearch(){this.currentPage=0,this.loadPurchases()}onPageChange(e){this.currentPage=e,this.loadPurchases()}onPageSizeChange(e){this.pageSize=e,this.currentPage=0,this.loadPurchases()}openSaleModal(e){this.selectedPurchase=e,this.modalService.open("sale")}deletePurchase(e){confirm("Are you sure you want to delete this purchase? This action cannot be undone.")&&(this.isLoading=!0,this.purchaseService.deletePurchase(e).subscribe({next:()=>{this.snackbar.success("Purchase deleted successfully"),this.loadPurchases()},error:t=>{this.snackbar.error(t?.error?.message||"Failed to delete purchase"),this.isLoading=!1}}))}loadCustomers(){this.isLoadingCustomers=!0,this.customerService.getCustomers({status:"A"}).subscribe({next:e=>{e.success&&(this.customers=e.data),this.isLoadingCustomers=!1},error:e=>{this.snackbar.error("Failed to load customers"),this.isLoadingCustomers=!1}})}refreshCustomers(){this.isLoadingCustomers=!0,this.customerService.refreshCustomers().subscribe({next:e=>{e.success&&(this.customers=e.data,this.snackbar.success("Customers refreshed successfully")),this.isLoadingCustomers=!1},error:e=>{this.snackbar.error("Failed to refresh customers"),this.isLoadingCustomers=!1}})}resetForm(){this.searchForm.reset(),this.currentPage=0,this.loadPurchases()}editPurchase(e){localStorage.setItem("purchaseId",this.encryptionService.encrypt(e.toString())),this.router.navigate(["/purchase/create"])}clearLocalStorage(){localStorage.removeItem("purchaseId"),this.router.navigate(["/purchase/create"])}static{this.\u0275fac=function(t){return new(t||o)(u(ee),u(X),u(U),u(H),u(Oe),u(ye),u(Fe),u(ve),u(K),u(Q))}}static{this.\u0275cmp=A({type:o,selectors:[["app-purchase"]],standalone:!0,features:[N],decls:51,vars:11,consts:[[1,"purchase-container"],[3,"show"],[1,"search-section","card"],[3,"ngSubmit","formGroup"],[1,"search-controls"],[1,"form-group"],["type","text","formControlName","search","placeholder","Search by invoice number...",1,"form-control"],["type","text","formControlName","batchNumber","placeholder","Search by Batch Number...",1,"form-control"],[1,"product-select-group"],["formControlName","customerId","labelKey","name","valueKey","id",3,"options","defaultOption","searchPlaceholder"],["type","button","title","Refresh Customers",1,"btn","btn-sm","btn-primary","refresh",2,"margin-top","3px",3,"click","disabled"],[1,"fas",3,"ngClass"],["type","date","formControlName","startDate","placeholder","Start Date",1,"form-control"],["type","date","formControlName","endDate","placeholder","End Date",1,"form-control"],[1,"button-group"],["type","submit",1,"search-btn","btn","btn-sm","btn-primary"],[1,"fas","fa-search"],["type","button",1,"search-btn","btn","btn-sm","btn-secondary",3,"click"],[1,"fas","fa-undo"],[1,"btn","btn-sm","btn-primary","mb-2",3,"click"],[1,"purchases-list","card"],[1,"table-responsive"],[1,"table"],[4,"ngFor","ngForOf"],[3,"currentPage","pageSize","totalElements","pageSizeOptions","pageChange","pageSizeChange",4,"ngIf"],[3,"purchase","saleCreated",4,"ngIf"],[1,"actions"],["title","Edit Purchase",1,"btn-icon","edit",3,"click"],[1,"fas","fa-eye"],["title","Delete Purchase",1,"btn-icon","delete",3,"click"],[1,"fas","fa-trash"],[3,"pageChange","pageSizeChange","currentPage","pageSize","totalElements","pageSizeOptions"],[3,"saleCreated","purchase"]],template:function(t,r){t&1&&(n(0,"div",0),l(1,"app-loader",1),n(2,"div",2)(3,"h2"),a(4,"Search Purchases"),i(),n(5,"form",3),p("ngSubmit",function(){return r.onSearch()}),n(6,"div",4)(7,"div",5),l(8,"input",6)(9,"input",7),i(),n(10,"div",5)(11,"div",8),l(12,"app-searchable-select",9),n(13,"button",10),p("click",function(){return r.refreshCustomers()}),l(14,"i",11),i()()(),n(15,"div",5),l(16,"input",12),i(),n(17,"div",5),l(18,"input",13),i(),n(19,"div",14)(20,"button",15),l(21,"i",16),a(22," Search "),i(),n(23,"button",17),p("click",function(){return r.resetForm()}),l(24,"i",18),a(25," Reset "),i()()()()(),n(26,"button",19),p("click",function(){return r.clearLocalStorage()}),a(27,"Add Purchase"),i(),n(28,"div",20)(29,"h2"),a(30,"Purchases"),i(),n(31,"div",21)(32,"table",22)(33,"thead")(34,"tr")(35,"th"),a(36,"No"),i(),n(37,"th"),a(38,"Invoice No."),i(),n(39,"th"),a(40,"Customer Name"),i(),n(41,"th"),a(42,"Purchase Date"),i(),n(43,"th"),a(44,"Total Purchase Amount"),i(),n(45,"th"),a(46,"Actions"),i()()(),n(47,"tbody"),g(48,Ge,17,8,"tr",23),i()()(),g(49,Re,1,4,"app-pagination",24),i()(),g(50,$e,1,1,"app-sale-modal",25)),t&2&&(s(),d("show",r.isLoading),s(4),d("formGroup",r.searchForm),s(7),d("options",r.customers)("defaultOption",ce(10,qe))("searchPlaceholder","Search customers..."),s(),d("disabled",r.isLoadingCustomers),s(),d("ngClass",r.isLoadingCustomers?"fa-spinner fa-spin":"fa-sync-alt"),s(34),d("ngForOf",r.purchases),s(),d("ngIf",r.totalPages>0),s(),d("ngIf",r.selectedPurchase))},dependencies:[k,D,z,L,le,Y,R,V,q,G,$,B,Pe,x,xe,Se,W,J,Ce],styles:[".purchase-container[_ngcontent-%COMP%]{padding:2rem;position:relative;min-height:200px;background-color:var(--background)}.purchase-container[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]{background:#fff;border-radius:0;box-shadow:0 2px 4px #0000001a;margin-bottom:20px;padding:20px}.purchase-container[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{margin-bottom:20px;color:var(--text-primary);font-size:1.5rem}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;align-items:flex-start}@media (max-width: 768px){.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]{grid-template-columns:1fr}}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]{margin:0}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]   .form-control[_ngcontent-%COMP%]{height:40px}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]   .product-select-group[_ngcontent-%COMP%]{display:flex;gap:.5rem}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]   .product-select-group[_ngcontent-%COMP%]   app-searchable-select[_ngcontent-%COMP%]{flex:1}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]   .product-select-group[_ngcontent-%COMP%]   .btn-icon[_ngcontent-%COMP%]{width:42px;padding:0;display:flex;align-items:center;justify-content:center;border:1px solid var(--border-color);border-radius:var(--border-radius);background:var(--primary)}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]   .product-select-group[_ngcontent-%COMP%]   .btn-icon[_ngcontent-%COMP%]:hover:not(:disabled){background:var(--primary)}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]   .product-select-group[_ngcontent-%COMP%]   .btn-icon[_ngcontent-%COMP%]:disabled{opacity:.6;cursor:not-allowed}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]{display:flex;gap:.5rem}@media (max-width: 768px){.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]{grid-column:1/-1}}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{flex:1;height:42px;display:flex;align-items:center;justify-content:center;gap:.5rem}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{font-size:1rem}.purchase-container[_ngcontent-%COMP%]   .purchases-list[_ngcontent-%COMP%]   .table-responsive[_ngcontent-%COMP%]{overflow-x:auto}.purchase-container[_ngcontent-%COMP%]   .purchases-list[_ngcontent-%COMP%]   .table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{white-space:nowrap}.purchase-container[_ngcontent-%COMP%]   .purchases-list[_ngcontent-%COMP%]   .table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{vertical-align:middle}.purchase-container[_ngcontent-%COMP%]   .table-controls[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}.purchase-container[_ngcontent-%COMP%]   .table-controls[_ngcontent-%COMP%]   .page-size-selector[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem}.purchase-container[_ngcontent-%COMP%]   .table-controls[_ngcontent-%COMP%]   .page-size-selector[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{color:var(--text-secondary);white-space:nowrap}.purchase-container[_ngcontent-%COMP%]   .table-controls[_ngcontent-%COMP%]   .page-size-selector[_ngcontent-%COMP%]   select.form-control[_ngcontent-%COMP%]{width:auto;min-width:80px;padding:.5rem;margin-bottom:0}@media (max-width: 768px){.purchase-container[_ngcontent-%COMP%]{padding:1rem}.purchase-container[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]{flex-direction:column;gap:1rem}.purchase-container[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%], .purchase-container[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{width:100%}}@media (max-width: 576px){.table-controls[_ngcontent-%COMP%]{flex-direction:column;gap:1rem;align-items:flex-start}.table-controls[_ngcontent-%COMP%]   .page-size-selector[_ngcontent-%COMP%]{width:100%}.table-controls[_ngcontent-%COMP%]   .page-size-selector[_ngcontent-%COMP%]   select.form-control[_ngcontent-%COMP%]{flex:1}}.actions[_ngcontent-%COMP%]{display:flex;gap:.5rem;justify-content:flex-start}.actions[_ngcontent-%COMP%]   .btn-icon[_ngcontent-%COMP%]{background:none;border:none;padding:8px;cursor:pointer;border-radius:6px;transition:all .2s ease;display:flex;align-items:center;justify-content:center}.actions[_ngcontent-%COMP%]   .btn-icon.sale[_ngcontent-%COMP%]{color:var(--primary);background-color:#fd78231a}.actions[_ngcontent-%COMP%]   .btn-icon.sale[_ngcontent-%COMP%]:hover:not(:disabled){background-color:var(--primary);color:#fff;transform:translateY(-1px)}.actions[_ngcontent-%COMP%]   .btn-icon.sale[_ngcontent-%COMP%]:disabled{color:var(--text-secondary);background-color:#0000000d;cursor:not-allowed}.actions[_ngcontent-%COMP%]   .btn-icon.delete[_ngcontent-%COMP%]{color:#dc3545;background-color:#dc35451a}.actions[_ngcontent-%COMP%]   .btn-icon.delete[_ngcontent-%COMP%]:hover{background-color:#dc3545;color:#fff;transform:translateY(-1px)}.actions[_ngcontent-%COMP%]   .btn-icon[_ngcontent-%COMP%]:active{transform:translateY(0)}.actions[_ngcontent-%COMP%]   .btn-icon[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{font-size:16px}@media (max-width: 768px){.actions[_ngcontent-%COMP%]   .btn-icon[_ngcontent-%COMP%]{padding:6px}.actions[_ngcontent-%COMP%]   .btn-icon[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{font-size:14px}}  .custom-snackbar.success{background-color:var(--accent2)}  .custom-snackbar.error{background-color:#dc3545}  .custom-snackbar .snackbar-message{display:flex;align-items:center;gap:.5rem;color:#fff}  .custom-snackbar .snackbar-message i{font-size:1.2rem}.loading-overlay[_ngcontent-%COMP%]{position:absolute;inset:0;background:#fffc;display:flex;justify-content:center;align-items:center;z-index:1000}.loading-overlay[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{font-size:2rem;color:var(--primary)}.product-select-group[_ngcontent-%COMP%]{display:flex;gap:.5rem;align-items:flex-start}.product-select-group[_ngcontent-%COMP%]   app-searchable-select[_ngcontent-%COMP%]{flex:1}.product-select-group[_ngcontent-%COMP%]   .btn-icon.refresh[_ngcontent-%COMP%]{background-color:var(--background);color:#fff;margin-top:3px;width:42px;height:42px;border-radius:6px;transition:all .2s ease}.product-select-group[_ngcontent-%COMP%]   .btn-icon.refresh[_ngcontent-%COMP%]:hover:not(:disabled){background-color:var(--primary);color:#fff;transform:translateY(-1px)}.product-select-group[_ngcontent-%COMP%]   .btn-icon.refresh[_ngcontent-%COMP%]:disabled{opacity:.7;cursor:not-allowed}.product-select-group[_ngcontent-%COMP%]   .btn-icon.refresh[_ngcontent-%COMP%]:active{transform:translateY(0)}"]})}}return o})();function Be(o,h){o&1&&(n(0,"div",40),a(1," Customer is required "),i())}function Ue(o,h){o&1&&(n(0,"div",40),a(1," Purchase date is required "),i())}function Ye(o,h){o&1&&(n(0,"div",40),a(1," Invoice number is required "),i())}function Qe(o,h){o&1&&(n(0,"div",40),a(1," Please select a product "),i())}function Ke(o,h){o&1&&(n(0,"div",40),a(1," Quantity must be 1 or greater "),i())}function He(o,h){o&1&&(n(0,"div",40),a(1," Double quotes are not allowed "),i())}function We(o,h){o&1&&(n(0,"div",40),a(1," Unit price must be greater than 0 "),i())}function Je(o,h){if(o&1){let e=y();n(0,"tr",41)(1,"td")(2,"div",42),l(3,"app-searchable-select",43),g(4,Qe,2,0,"div",18),i()(),n(5,"td")(6,"div",42),l(7,"input",44),g(8,Ke,2,0,"div",18),i()(),n(9,"td")(10,"div",42),l(11,"input",45),g(12,He,2,0,"div",18),i()(),n(13,"td")(14,"div",42)(15,"div",46),l(16,"input",47),i(),g(17,We,2,0,"div",18),i()(),n(18,"td")(19,"div",46),l(20,"input",48),i()(),n(21,"td")(22,"div",46),l(23,"input",49),i()(),n(24,"td")(25,"div",42),l(26,"input",50),i()(),n(27,"td")(28,"button",51),p("click",function(){let r=C(e).index,c=f();return v(c.removeProduct(r))}),l(29,"i",52),i()()()}if(o&2){let e,t=h.index,r=f();d("formGroupName",t),s(3),M("is-invalid",r.isProductFieldInvalid(t,"productId")),d("focusWidthPx",400)("options",r.products)("placeholder","Select Product")("searchPlaceholder","Search products..."),s(),d("ngIf",r.isProductFieldInvalid(t,"productId")),s(3),M("is-invalid",r.isProductFieldInvalid(t,"quantity")),s(),d("ngIf",r.isProductFieldInvalid(t,"quantity")),s(3),M("is-invalid",r.isProductFieldInvalid(t,"batchNumber")),s(),d("ngIf",(e=r.productsFormArray.at(t).get("batchNumber"))==null||e.errors==null?null:e.errors.doubleQuotes),s(4),M("is-invalid",r.isProductFieldInvalid(t,"unitPrice")),s(),d("ngIf",r.isProductFieldInvalid(t,"unitPrice")),s(3),d("value",r.getFormattedPrice(t)),s(3),d("value",r.getFormattedTaxAmount(t)),s(5),d("disabled",r.productsFormArray.length===1)}}function Xe(o,h){o&1&&l(0,"app-loader")}var ne=(()=>{class o{get productsFormArray(){return this.purchaseForm.get("products")}constructor(e,t,r,c,m,P,b,te){this.fb=e,this.productService=t,this.customerService=r,this.purchaseService=c,this.snackbar=m,this.http=P,this.router=b,this.encryptionService=te,this.products=[],this.customers=[],this.loading=!1,this.isLoadingProducts=!1,this.isLoadingCustomers=!1,this.isEdit=!1,this.destroy$=new oe,this.productSubscriptions=[],this.initForm()}ngOnInit(){this.loadProducts(),this.loadCustomers();let e=localStorage.getItem("purchaseId");if(e){let t=this.encryptionService.decrypt(e);t&&this.fetchPurchaseDetails(Number(t))}}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete(),this.productSubscriptions.forEach(e=>e?.unsubscribe())}initForm(){this.purchaseForm=this.fb.group({id:[null],customerId:["",_.required],purchaseDate:[T(new Date,"yyyy-MM-dd","en"),_.required],invoiceNumber:["",_.required],products:this.fb.array([])}),this.addProduct()}createProductFormGroup(){return this.fb.group({productId:["",_.required],quantity:["",[_.required,_.min(1)]],batchNumber:["",[this.noDoubleQuotesValidator()]],unitPrice:["",[_.required,_.min(.01)]],price:[{value:0,disabled:!0}],taxPercentage:[{value:0,disabled:!0}],taxAmount:[{value:0,disabled:!0}],remarks:[null,[]]})}addProduct(){let e=this.createProductFormGroup();this.setupProductCalculations(e,this.productsFormArray.length),this.productsFormArray.push(e)}removeProduct(e){this.productsFormArray.length!==1&&(this.productSubscriptions[e]&&(this.productSubscriptions[e].unsubscribe(),this.productSubscriptions.splice(e,1)),this.productsFormArray.removeAt(e),this.productsFormArray.controls.forEach((t,r)=>{this.productSubscriptions[r]&&this.productSubscriptions[r].unsubscribe(),this.setupProductCalculations(t,r)}),this.calculateTotalAmount())}setupProductCalculations(e,t){let r=e.get("productId")?.valueChanges.pipe(re(this.destroy$)).subscribe(m=>{if(m){let P=this.products.find(b=>b.id===m);if(P){let b=P.taxPercentage||0;e.patchValue({taxPercentage:b},{emitEvent:!1}),this.calculateProductPrice(t)}}}),c=e.valueChanges.pipe(re(this.destroy$)).subscribe(()=>{this.calculateProductPrice(t)});this.productSubscriptions[t]=c}calculateProductPrice(e){let t=this.productsFormArray.at(e);if(!t)return;let r=Number(t.get("quantity")?.value||0),c=Number(t.get("unitPrice")?.value||0),m=Number(t.get("taxPercentage")?.value||0),P=Number((r*c).toFixed(2)),b=Number((P*m/100).toFixed(2));t.patchValue({price:P,taxAmount:b},{emitEvent:!1}),this.calculateTotalAmount()}getTotalAmount(){return this.productsFormArray.controls.reduce((e,t)=>e+(t.get("price").value||0),0)}getTotalTaxAmount(){return this.productsFormArray.controls.reduce((e,t)=>e+(t.get("taxAmount").value||0),0)}loadProducts(){this.isLoadingProducts=!0,this.productService.getProducts({status:"A"}).subscribe({next:e=>{e.success&&(this.products=e.data),this.isLoadingProducts=!1},error:e=>{this.snackbar.error("Failed to load products"),this.isLoadingProducts=!1}})}refreshProducts(){this.isLoadingProducts=!0,this.productService.refreshProducts().subscribe({next:e=>{e.success&&(this.products=e.data,this.snackbar.success("Products refreshed successfully")),this.isLoadingProducts=!1},error:e=>{this.snackbar.error("Failed to refresh products"),this.isLoadingProducts=!1}})}loadCustomers(){this.isLoadingCustomers=!0,this.customerService.getCustomers({status:"A"}).subscribe({next:e=>{e.success&&(this.customers=e.data),this.isLoadingCustomers=!1},error:e=>{this.snackbar.error("Failed to load customers"),this.isLoadingCustomers=!1}})}refreshCustomers(){this.isLoadingCustomers=!0,this.customerService.refreshCustomers().subscribe({next:e=>{e.success&&(this.customers=e.data),this.snackbar.success("Customers refreshed successfully"),this.isLoadingCustomers=!1},error:e=>{this.snackbar.error("Failed to load customers"),this.isLoadingCustomers=!1}})}isFieldInvalid(e){let t=this.purchaseForm.get(e);return t?t.invalid&&t.touched:!1}isProductFieldInvalid(e,t){let r=this.productsFormArray.at(e).get(t);if(!r)return!1;if(r.invalid&&(r.dirty||r.touched)){let m=r.errors;if(m&&(m.required||m.min&&t==="quantity"||m.min&&t==="unitPrice"||m.min||m.max||m.min))return!0}return!1}resetForm(){this.isEdit=!1,this.purchaseForm.patchValue({id:null}),this.initForm()}onSubmit(){if(this.markFormGroupTouched(this.purchaseForm),this.purchaseForm.valid){this.loading=!0;let e=this.preparePurchaseData();(this.isEdit?this.purchaseService.updatePurchase(e):this.purchaseService.createPurchase(e)).subscribe({next:r=>{r?.success&&(this.snackbar.success(`Purchase ${this.isEdit?"updated":"created"} successfully`),localStorage.removeItem("purchaseId"),this.router.navigate(["/purchase"])),this.loading=!1},error:r=>{this.snackbar.error(r?.error?.message||`Failed to ${this.isEdit?"update":"create"} purchase`),this.loading=!1}})}else{let e=document.querySelector(".is-invalid");e&&e.scrollIntoView({behavior:"smooth",block:"center"})}}preparePurchaseData(){let e=this.purchaseForm.value,t={purchaseDate:T(e.purchaseDate,"dd-MM-yyyy","en"),customerId:e.customerId,invoiceNumber:e.invoiceNumber,price:this.getTotalAmount(),taxAmount:this.getTotalTaxAmount(),products:e.products.map((r,c)=>({productId:r.productId,quantity:r.quantity,batchNumber:r.batchNumber,unitPrice:r.unitPrice,price:this.productsFormArray.at(c).get("price")?.value,taxPercentage:this.productsFormArray.at(c).get("taxPercentage")?.value,taxAmount:this.productsFormArray.at(c).get("taxAmount")?.value,remarks:r.remarks}))};return this.isEdit&&e.id&&(t.id=e.id),t}markFormGroupTouched(e){Object.values(e.controls).forEach(t=>{t instanceof ue||t instanceof fe?this.markFormGroupTouched(t):(t.markAsTouched(),t.markAsDirty())})}calculateTotalAmount(){let e=this.productsFormArray.controls.reduce((r,c)=>r+(c.get("price").value||0),0),t=this.productsFormArray.controls.reduce((r,c)=>r+(c.get("taxAmount").value||0),0);this.purchaseForm.patchValue({price:e,taxAmount:t,totalAmount:e+t},{emitEvent:!1})}noDoubleQuotesValidator(){return e=>e.value&&e.value.includes('"')?{doubleQuotes:!0}:null}getFormattedPrice(e){let t=this.productsFormArray.at(e).get("price")?.value;return t?t.toFixed(2):"0.00"}getFormattedTaxAmount(e){let t=this.productsFormArray.at(e).get("taxAmount")?.value;return t?t.toFixed(2):"0.00"}fetchPurchaseDetails(e){this.purchaseService.getPurchaseDetails(e).subscribe({next:t=>{console.log("response : ",t),t.id&&(console.log("response.data : ",t.id),this.isEdit=!0,this.populateForm(t))},error:t=>{this.snackbar.error(t?.error?.message||"Failed to load purchase details")}})}populateForm(e){this.purchaseForm.patchValue({customerId:e.customerId,id:e.id,purchaseDate:T(new Date(e.purchaseDate),"yyyy-MM-dd","en"),invoiceNumber:e.invoiceNumber}),this.productsFormArray.clear(),e.items.forEach((t,r)=>{let c=this.createProductFormGroup();this.setupProductCalculations(c,r),c.patchValue({productId:t.productId,quantity:t.quantity,unitPrice:t.unitPrice,price:t.price,taxPercentage:t.taxPercentage,taxAmount:t.taxAmount,batchNumber:t.batchNumber,remarks:t.remarks}),this.productsFormArray.push(c)}),this.isEdit=!0}static{this.\u0275fac=function(t){return new(t||o)(u(U),u(Me),u(X),u(ee),u(H),u(j),u(Q),u(K))}}static{this.\u0275cmp=A({type:o,selectors:[["app-add-purchase"]],standalone:!0,features:[N],decls:101,vars:34,consts:[[1,"add-purchase-container"],["routerLink","/purchase",1,"btn","btn-sm","btn-secondary","back-btn"],[1,"fas","fa-arrow-left"],[1,"form-card"],[1,"card-header"],[1,"form-title"],[1,"fas","fa-cart-plus"],[1,"purchase-form",3,"ngSubmit","formGroup"],[1,"header-section"],[1,"form-row"],[1,"form-group"],["for","customerId"],[1,"fas","fa-user"],[1,"required"],[1,"select-group"],["formControlName","customerId","labelKey","name","valueKey","id",3,"options","placeholder","searchPlaceholder"],["type","button","title","Refresh Customers",1,"btn","btn-sm","btn-primary","refresh","mt-2",3,"click","disabled"],[1,"fas",3,"ngClass"],["class","invalid-feedback",4,"ngIf"],["for","purchaseDate"],[1,"fas","fa-calendar"],["type","date","id","purchaseDate","formControlName","purchaseDate",1,"form-control"],["for","invoiceNumber"],[1,"fas","fa-file-invoice"],["type","text","id","invoiceNumber","formControlName","invoiceNumber",1,"form-control"],["formArrayName","products",1,"products-section"],[1,"products-header"],[1,"fas","fa-boxes"],["type","button",1,"btn","btn-sm","btn-primary",3,"click"],[1,"fas","fa-plus"],[1,"table-responsive"],[1,"table","products-table"],[3,"formGroupName",4,"ngFor","ngForOf"],[1,"purchase-summary"],[1,"summary-item"],[1,"form-actions"],["type","button",1,"btn","btn-sm","btn-secondary",3,"click","disabled"],[1,"fas","fa-undo"],["type","submit",1,"btn","btn-sm","btn-primary",3,"disabled"],[4,"ngIf"],[1,"invalid-feedback"],[3,"formGroupName"],[1,"form-field-container"],["formControlName","productId","labelKey","name","valueKey","id",3,"focusWidthPx","options","placeholder","searchPlaceholder"],["type","number","formControlName","quantity","placeholder","Qty","min","1",1,"form-control"],["type","text","formControlName","batchNumber","placeholder","Batch Number",1,"form-control"],[1,"input-group"],["type","number","formControlName","unitPrice","placeholder","Price","min","0.01","step","0.01",1,"form-control"],["type","number","formControlName","price","readonly","",1,"form-control",3,"value"],["type","number","formControlName","taxAmount","readonly","",1,"form-control",3,"value"],["type","text","formControlName","remarks","placeholder","Remarks",1,"form-control"],["type","button","title","Remove Product",1,"btn","btn-sm","btn-danger",3,"click","disabled"],[1,"fas","fa-trash"]],template:function(t,r){t&1&&(n(0,"div",0)(1,"button",1),l(2,"i",2),a(3," Back to Purchases "),i(),n(4,"div",3)(5,"div",4)(6,"h2",5),l(7,"i",6),a(8," Add New Purchase "),i()(),n(9,"form",7),p("ngSubmit",function(){return r.onSubmit()}),n(10,"div",8)(11,"div",9)(12,"div",10)(13,"label",11),l(14,"i",12),a(15," Select Customer "),n(16,"span",13),a(17,"*"),i()(),n(18,"div",14),l(19,"app-searchable-select",15),n(20,"button",16),p("click",function(){return r.refreshCustomers()}),l(21,"i",17),i()(),g(22,Be,2,0,"div",18),i(),n(23,"div",10)(24,"label",19),l(25,"i",20),a(26," Purchase Date "),n(27,"span",13),a(28,"*"),i()(),l(29,"input",21),g(30,Ue,2,0,"div",18),i(),n(31,"div",10)(32,"label",22),l(33,"i",23),a(34," Invoice Number "),n(35,"span",13),a(36,"*"),i()(),l(37,"input",24),g(38,Ye,2,0,"div",18),i()()(),n(39,"div",25)(40,"div",26)(41,"h3"),l(42,"i",27),a(43," Products"),i(),n(44,"button",28),p("click",function(){return r.addProduct()}),l(45,"i",29),a(46," Add Product "),i()(),n(47,"div",30)(48,"table",31)(49,"thead")(50,"tr")(51,"th"),a(52,"Product Name"),i(),n(53,"th"),a(54,"Quantity"),i(),n(55,"th"),a(56,"Batch Number"),i(),n(57,"th"),a(58,"Rate"),i(),n(59,"th"),a(60,"Price"),i(),n(61,"th"),a(62,"Tax Amount"),i(),n(63,"th"),a(64,"Remarks"),i(),n(65,"th"),a(66,"Actions"),i()()(),n(67,"tbody"),g(68,Je,30,20,"tr",32),i()()()(),n(69,"div",33)(70,"div",34)(71,"span"),a(72,"Total Products:"),i(),n(73,"strong"),a(74),i()(),n(75,"div",34)(76,"span"),a(77,"Total Price:"),i(),n(78,"strong"),a(79),S(80,"number"),i()(),n(81,"div",34)(82,"span"),a(83,"Total Tax Amount:"),i(),n(84,"strong"),a(85),S(86,"number"),i()(),n(87,"div",34)(88,"span"),a(89,"Grand Total:"),i(),n(90,"strong"),a(91),S(92,"number"),i()()(),n(93,"div",35)(94,"button",36),p("click",function(){return r.resetForm()}),l(95,"i",37),a(96," Reset "),i(),n(97,"button",38),l(98,"i",17),a(99),i()()()()(),g(100,Xe,1,0,"app-loader",39)),t&2&&(s(9),d("formGroup",r.purchaseForm),s(10),M("is-invalid",r.isFieldInvalid("customerId")),d("options",r.customers)("placeholder","Select Customer")("searchPlaceholder","Search customers..."),s(),d("disabled",r.isLoadingCustomers),s(),d("ngClass",r.isLoadingCustomers?"fa-spinner fa-spin":"fa-sync-alt"),s(),d("ngIf",r.isFieldInvalid("customerId")),s(7),M("is-invalid",r.isFieldInvalid("purchaseDate")),s(),d("ngIf",r.isFieldInvalid("purchaseDate")),s(7),M("is-invalid",r.isFieldInvalid("invoiceNumber")),s(),d("ngIf",r.isFieldInvalid("invoiceNumber")),s(30),d("ngForOf",r.productsFormArray.controls),s(6),O(r.productsFormArray.length),s(5),I("\u20B9",F(80,25,r.getTotalAmount(),"1.2-2"),""),s(6),I("\u20B9",F(86,28,r.getTotalTaxAmount(),"1.2-2"),""),s(6),I("\u20B9",F(92,31,r.getTotalAmount()+r.getTotalTaxAmount(),"1.2-2"),""),s(3),d("disabled",r.loading),s(3),d("disabled",r.purchaseForm.invalid||r.loading),s(),d("ngClass",r.loading?"fa-spinner fa-spin":"fa-save"),s(),I(" ",r.loading?"Saving...":"Save Purchase"," "),s(),d("ngIf",r.loading))},dependencies:[k,D,z,L,de,Y,R,V,me,q,G,ge,$,B,pe,he,x,be,W,J],styles:[".add-purchase-container[_ngcontent-%COMP%]{padding:2rem;margin:0 auto}@media (max-width: 768px){.add-purchase-container[_ngcontent-%COMP%]{padding:1rem}}.select-group[_ngcontent-%COMP%]{position:relative}.select-group[_ngcontent-%COMP%]   app-searchable-select[_ngcontent-%COMP%]{display:block}.select-group[_ngcontent-%COMP%]   app-searchable-select.custom-width[_ngcontent-%COMP%]{position:absolute;z-index:1000;left:0}.select-group[_ngcontent-%COMP%]   app-searchable-select[_ngcontent-%COMP%]:focus-within{z-index:1000}.form-control[_ngcontent-%COMP%]{height:40px}.back-btn[_ngcontent-%COMP%]{margin-bottom:1rem}.form-card[_ngcontent-%COMP%]{background:#fff;border-radius:var(--border-radius);box-shadow:var(--card-shadow);overflow:hidden}.card-header[_ngcontent-%COMP%]{background-color:var(--primary);padding:1.5rem}.card-header[_ngcontent-%COMP%]   .form-title[_ngcontent-%COMP%]{color:#fff;margin:0;font-size:1.5rem;font-weight:500;display:flex;align-items:center;gap:.5rem}.purchase-form[_ngcontent-%COMP%]{padding:2rem}@media (max-width: 768px){.purchase-form[_ngcontent-%COMP%]{padding:1rem}}.header-section[_ngcontent-%COMP%]{background-color:var(--background-light);border-radius:var(--border-radius);padding:1.5rem;margin-bottom:2rem;position:relative}.header-section[_ngcontent-%COMP%]   .form-row[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1.5rem}@media (max-width: 768px){.header-section[_ngcontent-%COMP%]   .form-row[_ngcontent-%COMP%]{grid-template-columns:1fr}}.products-section[_ngcontent-%COMP%]{background-color:#fff;border-radius:var(--border-radius);padding:1.5rem;margin-top:2rem;border:1px solid var(--primary)}.products-section[_ngcontent-%COMP%]   .products-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem}.products-section[_ngcontent-%COMP%]   .products-header[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0;color:var(--text-primary);font-size:1.25rem;display:flex;align-items:center;gap:.5rem}.products-section[_ngcontent-%COMP%]   .products-header[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{color:var(--primary)}.product-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:2fr 1fr 1fr 1fr 1fr 1fr auto;gap:1rem;align-items:start}@media (max-width: 1200px){.product-grid[_ngcontent-%COMP%]{grid-template-columns:repeat(3,1fr)}}@media (max-width: 768px){.product-grid[_ngcontent-%COMP%]{grid-template-columns:1fr}}.remove-product[_ngcontent-%COMP%]{background-color:var(--danger-light);color:var(--danger);border:none;width:36px;height:36px;border-radius:var(--border-radius);display:flex;align-items:center;justify-content:center;transition:all .3s ease}.remove-product[_ngcontent-%COMP%]:hover:not(:disabled){background-color:var(--danger);color:#fff;transform:translateY(-1px)}.remove-product[_ngcontent-%COMP%]:disabled{opacity:.5;cursor:not-allowed}@media (max-width: 768px){.remove-product[_ngcontent-%COMP%]{position:absolute;top:1rem;right:1rem}}.form-group[_ngcontent-%COMP%]{margin-bottom:1rem;position:relative}.form-group[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem;color:var(--text-primary);font-weight:500}.form-group[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{color:var(--primary)}.form-group[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]   .required[_ngcontent-%COMP%]{color:var(--danger);margin-left:4px}.input-group[_ngcontent-%COMP%]{display:flex;align-items:stretch}.input-group[_ngcontent-%COMP%]   .input-group-text[_ngcontent-%COMP%]{background-color:var(--background);border:1px solid var(--border-color);border-right:none;border-radius:var(--border-radius) 0 0 var(--border-radius);height:38px;color:var(--text-secondary);min-width:40px;display:flex;align-items:center;justify-content:center}.input-group[_ngcontent-%COMP%]   .form-control[_ngcontent-%COMP%]{border-radius:0 var(--border-radius) var(--border-radius) 0;flex:1}.purchase-summary[_ngcontent-%COMP%]{background-color:var(--background-light);border-radius:var(--border-radius);padding:1.5rem;margin-top:2rem;display:flex;justify-content:flex-end;gap:2rem;flex-wrap:wrap}.purchase-summary[_ngcontent-%COMP%]   .summary-item[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.75rem}.purchase-summary[_ngcontent-%COMP%]   .summary-item[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{color:var(--text-secondary);font-size:.875rem}.purchase-summary[_ngcontent-%COMP%]   .summary-item[_ngcontent-%COMP%]   strong[_ngcontent-%COMP%]{color:var(--text-primary);font-size:1.25rem;font-weight:600}.form-actions[_ngcontent-%COMP%]{display:flex;justify-content:space-between;gap:1rem;margin-top:2rem;padding-top:1.5rem;border-top:1px solid var(--border-color)}@media (max-width: 576px){.form-actions[_ngcontent-%COMP%]{flex-direction:column}.form-actions[_ngcontent-%COMP%]   .btn[_ngcontent-%COMP%]{width:100%}}.table-responsive[_ngcontent-%COMP%]{margin:0 -1.5rem;padding:0 1.5rem;overflow-x:auto;min-height:400px;-webkit-overflow-scrolling:touch}@media (max-width: 768px){.table-responsive[_ngcontent-%COMP%]{margin:0 -1rem;padding:0 1rem}}.products-table[_ngcontent-%COMP%]{width:100%;margin-bottom:0;background:#fff;border-collapse:separate;border-spacing:0}.products-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{background-color:var(--background-light);color:var(--text-primary);font-weight:600;padding:1rem;white-space:nowrap;border-bottom:2px solid var(--border-color)}.products-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{padding:.75rem 1rem;vertical-align:middle;border-bottom:1px solid var(--border-color)}.products-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]   .form-control[_ngcontent-%COMP%]{min-width:80px}.products-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]:first-child   .form-control[_ngcontent-%COMP%]{min-width:200px}.products-table[_ngcontent-%COMP%]   .input-group[_ngcontent-%COMP%]{flex-wrap:nowrap}.products-table[_ngcontent-%COMP%]   .btn-icon[_ngcontent-%COMP%]{margin:0 auto}@media (max-width: 768px){.products-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%], .products-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{padding:.5rem}}.form-field-container[_ngcontent-%COMP%]{position:relative;margin-bottom:1rem}.form-field-container[_ngcontent-%COMP%]   .form-control.is-invalid[_ngcontent-%COMP%], .form-field-container[_ngcontent-%COMP%]   .input-group.is-invalid[_ngcontent-%COMP%]{border-color:var(--danger);background-image:url(data:image/svg+xml,...)}.products-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{padding-bottom:1.5rem;vertical-align:top}.invalid-feedback[_ngcontent-%COMP%]{color:var(--danger);font-size:.75rem;margin-top:.25rem;animation:_ngcontent-%COMP%_fadeIn .3s ease-in}@keyframes _ngcontent-%COMP%_fadeIn{0%{opacity:0;transform:translateY(-5px)}to{opacity:1;transform:translateY(0)}}"]})}}return o})();var Ze=[{path:"",component:Ie},{path:"create",component:ne},{path:"edit/:id",component:ne}],Ee=(()=>{class o{static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275mod=w({type:o})}static{this.\u0275inj=E({imports:[x.forChild(Ze),x]})}}return o})();var wt=(()=>{class o{static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275mod=w({type:o})}static{this.\u0275inj=E({imports:[k,Ee]})}}return o})();export{wt as PurchaseModule};
