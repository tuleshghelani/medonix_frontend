import"./chunk-SVBUHBIG.js";import{b as Ht,c as Jt,d as Xt}from"./chunk-WYYFELHO.js";import{a as Wt}from"./chunk-GC4KDOX7.js";import{a as ht,b as At}from"./chunk-44VES7CY.js";import{b as It,c as pt,d as gt}from"./chunk-PGE6QRUW.js";import{$b as Y,A as $t,Ab as Ut,C as D,D as vt,Db as z,Eb as at,Fa as yt,Fb as kt,Ga as Ot,H as C,Hb as Q,I as v,Ib as ct,Jb as st,Ka as E,Kb as j,Ma as I,Na as W,Ob as lt,Pa as St,Pb as dt,Rb as Gt,Sa as H,Sb as $,Ta as J,Tb as Yt,U as c,Ua as T,Ub as ut,V as P,Va as R,Vb as Et,Xa as X,Xb as tt,Ya as Z,Yb as mt,_a as ot,a as bt,aa as f,ac as Vt,b as qt,ba as Bt,bb as wt,bc as B,ca as d,e as zt,ea as F,f as N,ha as i,ia as r,j as _t,ja as p,ka as xt,la as Mt,ma as A,o as ft,pa as b,q as Qt,qa as g,u as M,va as K,wa as o,wb as V,wc as U,x as jt,xa as y,xb as w,xc as et,y as Ct,ya as O,yb as L,yc as Kt,zb as q,zc as nt}from"./chunk-RL35WT5O.js";var G=(()=>{class a{constructor(t){this.http=t,this.apiUrl=`${Vt.apiUrl}/api/purchases`,this.purchaseReturnApiUrl=`${Vt.apiUrl}/api/purchase-returns`}searchPurchases(t){return this.http.post(`${this.apiUrl}/searchPurchase`,t)}createPurchase(t){return this.http.post(`${this.apiUrl}/create`,t)}updatePurchase(t){return this.http.post(`${this.apiUrl}/create`,t)}deletePurchase(t){return this.http.delete(`${this.apiUrl}/${t}`)}getPurchaseDetails(t,e=!1){return this.http.post(`${this.apiUrl}/detail`,{id:t,isPurchaseReturn:e})}updateQcPass(t){return this.http.post(`${this.apiUrl}/update-qc-pass`,t)}createPurchaseReturn(t){return this.http.post(`${this.purchaseReturnApiUrl}/create`,t)}getPurchaseReturnDetail(t){return this.http.post(`${this.purchaseReturnApiUrl}/detail`,{id:t})}searchPurchaseReturn(t){return this.http.post(`${this.purchaseReturnApiUrl}/searchPurchaseReturn`,t)}deletePurchaseReturn(t){return this.http.post(`${this.purchaseReturnApiUrl}/delete`,{id:t})}generatePdf(t){return this.http.post(`${this.apiUrl}/generate-pdf`,{id:t},{responseType:"blob",observe:"response"}).pipe(_t(e=>{let s=e.headers.get("Content-Disposition")?.split("filename=")[1]?.replace(/"/g,"")||"purchase.pdf";return{blob:new Blob([e.body],{type:"application/pdf"}),filename:s}}))}generatePurchaseReturnPdf(t){return this.http.post(`${this.purchaseReturnApiUrl}/generate-pdf`,{id:t},{responseType:"blob",observe:"response"}).pipe(_t(e=>{let s=e.headers.get("Content-Disposition")?.split("filename=")[1]?.replace(/"/g,"")||"purchase-return.pdf";return{blob:new Blob([e.body],{type:"application/pdf"}),filename:s}}))}exportExcel(t){return this.http.post(`${this.apiUrl}/export-excel`,t,{responseType:"blob",observe:"response"}).pipe(_t(e=>{let s=e.headers.get("Content-Disposition")?.split("filename=")[1]?.replace(/"/g,"")||`purchase_export_${t.startDate}_${t.endDate}.xlsx`;return{blob:new Blob([e.body],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),filename:s}}))}exportPurchaseReturnExcel(t){return this.http.post(`${this.purchaseReturnApiUrl}/export-excel`,t,{responseType:"blob",observe:"response"}).pipe(_t(e=>{let s=e.headers.get("Content-Disposition")?.split("filename=")[1]?.replace(/"/g,"")||`purchase_return_export_${t.startDate}_${t.endDate}.xlsx`;return{blob:new Blob([e.body],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),filename:s}}))}static{this.\u0275fac=function(e){return new(e||a)($t(wt))}}static{this.\u0275prov=jt({token:a,factory:a.\u0275fac,providedIn:"root"})}}return a})();var de=()=>({label:"All Customers",value:""});function ue(a,h){if(a&1){let t=A();i(0,"div",6)(1,"div",32),p(2,"app-searchable-select",33),i(3,"button",34),b("click",function(){C(t);let n=g();return v(n.refreshCustomers())}),p(4,"i",35),r()()()}if(a&2){let t=g();c(2),d("options",t.customers)("defaultOption",Ot(5,de))("searchPlaceholder","Search customers..."),c(),d("disabled",t.isLoadingCustomers),c(),d("ngClass",t.isLoadingCustomers?"fa-spinner fa-spin":"fa-sync-alt")}}function me(a,h){if(a&1){let t=A();i(0,"button",36),b("click",function(){C(t);let n=g();return v(n.exportExcel())}),p(1,"i",37),o(2," Export "),r()}if(a&2){let t=g();d("disabled",t.isExportButtonDisabled())}}function pe(a,h){if(a&1){let t=A();i(0,"div",38)(1,"button",39),b("click",function(){C(t);let n=g();return v(n.clearLocalStorage())}),p(2,"i",40),o(3," Add Purchase "),r()()}}function ge(a,h){a&1&&(i(0,"th",27),o(1,"Actions"),r())}function he(a,h){if(a&1){let t=A();i(0,"td",50)(1,"button",51),b("click",function(){C(t);let n=g().$implicit,s=g();return v(s.editPurchase(n.id))})("touchstart",function(n){return C(t),v(n.stopPropagation())}),p(2,"i",52),r(),i(3,"button",53),b("click",function(){C(t);let n=g().$implicit,s=g();return v(s.generatePdf(n.id,n.invoiceNumber))})("touchstart",function(n){return C(t),v(n.stopPropagation())}),p(4,"i",54),r(),i(5,"button",55),b("click",function(){C(t);let n=g().$implicit,s=g();return v(s.openReturn(n.id))})("touchstart",function(n){return C(t),v(n.stopPropagation())}),p(6,"i",56),r(),i(7,"button",57),b("click",function(){C(t);let n=g().$implicit,s=g();return v(s.openQc(n.id))})("touchstart",function(n){return C(t),v(n.stopPropagation())}),p(8,"i",58),r(),i(9,"button",59),b("click",function(){C(t);let n=g().$implicit,s=g();return v(s.deletePurchase(n.id))})("touchstart",function(n){return C(t),v(n.stopPropagation())}),p(10,"i",60),r()()}}function _e(a,h){if(a&1&&(i(0,"tr",41)(1,"td",42),o(2),r(),i(3,"td",43)(4,"strong"),o(5),r()(),i(6,"td",44),o(7),r(),i(8,"td",45),o(9),E(10,"date"),r(),i(11,"td",46)(12,"strong"),o(13),r()(),i(14,"td",47)(15,"span",48),o(16),r()(),f(17,he,11,0,"td",49),r()),a&2){let t,e=h.$implicit,n=h.index,s=g();c(2),y(s.startIndex+n+1),c(3),y(e.invoiceNumber),c(2),y(e.customerName),c(2),y(I(10,12,e.purchaseDate,"dd-MM-yyyy")),c(4),y((t=e.totalPurchaseAmount)!==null&&t!==void 0?t:0),c(2),F("pass",e.isQcPass)("pending",!e.isQcPass),Bt("aria-label",e.isQcPass?"QC Pass":"QC Pending"),c(),O(" ",e.isQcPass?"Pass":"Pending"," "),c(),d("ngIf",s.canManagePurchases)}}function fe(a,h){if(a&1){let t=A();i(0,"app-pagination",61),b("pageChange",function(n){C(t);let s=g();return v(s.onPageChange(n))})("pageSizeChange",function(n){C(t);let s=g();return v(s.onPageSizeChange(n))}),r()}if(a&2){let t=g();d("currentPage",t.currentPage)("pageSize",t.pageSize)("totalElements",t.totalElements)("pageSizeOptions",t.pageSizeOptions)}}function Pe(a,h){if(a&1){let t=A();i(0,"app-sale-modal",62),b("saleCreated",function(){C(t);let n=g();return v(n.loadPurchases())}),r()}if(a&2){let t=g();d("purchase",t.selectedPurchase)}}var te=(()=>{class a{constructor(t,e,n,s,l,u,m,_,x,S,k,it){this.purchaseService=t,this.customerService=e,this.fb=n,this.snackbar=s,this.dialog=l,this.modalService=u,this.dateUtils=m,this.cacheService=_,this.encryptionService=x,this.router=S,this.authService=k,this.cdr=it,this.purchases=[],this.isLoading=!1,this.currentPage=0,this.pageSize=10,this.pageSizeOptions=[5,10,25,50,100],this.totalPages=0,this.totalElements=0,this.startIndex=0,this.endIndex=0,this.selectedPurchase=null,this.products=[],this.isLoadingProducts=!1,this.customers=[],this.isLoadingCustomers=!1,this.canManagePurchases=!1,this.destroy$=new N,this.initializeForm()}ngOnInit(){this.canManagePurchases=this.authService.isAdmin()||this.authService.isStaffAdmin(),this.loadPurchases(),this.canManagePurchases&&this.loadCustomers()}initializeForm(){this.searchForm=this.fb.group({search:[""],customerId:[""],startDate:[""],endDate:[""],batchNumber:[""]})}loadPurchases(){this.isLoading=!0;let t=bt({currentPage:this.currentPage,perPageRecord:this.pageSize,startDate:this.searchForm.value.startDate?this.dateUtils.formatDate(this.searchForm.value.startDate):"",endDate:this.searchForm.value.endDate?this.dateUtils.formatDate(this.searchForm.value.endDate):""},this.searchForm.value);this.purchaseService.searchPurchases(t).pipe(M(this.destroy$)).subscribe({next:e=>{this.purchases=e.content,this.totalPages=e.totalPages,this.totalElements=e.totalElements,this.startIndex=this.currentPage*this.pageSize,this.endIndex=Math.min((this.currentPage+1)*this.pageSize,this.totalElements),this.isLoading=!1,this.cdr.markForCheck()},error:e=>{this.snackbar.error(e.message||"Failed to load purchases"),this.isLoading=!1,this.cdr.markForCheck()}})}onSearch(){this.currentPage=0,this.loadPurchases()}onPageChange(t){this.currentPage=t,this.loadPurchases()}onPageSizeChange(t){this.pageSize=t,this.currentPage=0,this.loadPurchases()}openSaleModal(t){this.selectedPurchase=t,this.modalService.open("sale")}deletePurchase(t){confirm("Are you sure you want to delete this purchase? This action cannot be undone.")&&(this.isLoading=!0,this.purchaseService.deletePurchase(t).pipe(M(this.destroy$)).subscribe({next:()=>{this.snackbar.success("Purchase deleted successfully"),this.loadPurchases()},error:e=>{this.snackbar.error(e?.error?.message||"Failed to delete purchase"),this.isLoading=!1,this.cdr.markForCheck()}}))}loadCustomers(){this.canManagePurchases&&(this.isLoadingCustomers=!0,this.customerService.getCustomers({status:"A"}).pipe(M(this.destroy$)).subscribe({next:t=>{t.success&&(this.customers=t.data),this.isLoadingCustomers=!1,this.cdr.markForCheck()},error:t=>{this.snackbar.error("Failed to load customers"),this.isLoadingCustomers=!1,this.cdr.markForCheck()}}))}refreshCustomers(){this.canManagePurchases&&(this.isLoadingCustomers=!0,this.customerService.refreshCustomers().pipe(M(this.destroy$)).subscribe({next:t=>{t.success&&(this.customers=t.data,this.snackbar.success("Customers refreshed successfully")),this.isLoadingCustomers=!1,this.cdr.markForCheck()},error:t=>{this.snackbar.error("Failed to refresh customers"),this.isLoadingCustomers=!1,this.cdr.markForCheck()}}))}resetForm(){this.searchForm.reset(),this.currentPage=0,this.loadPurchases()}editPurchase(t){localStorage.setItem("purchaseId",this.encryptionService.encrypt(t.toString())),this.router.navigate(["/purchase/create"])}clearLocalStorage(){localStorage.removeItem("purchaseId"),this.router.navigate(["/purchase/create"])}openReturn(t){let e=this.encryptionService.encrypt(t.toString());this.router.navigate(["/purchase/return",e])}openQc(t){let e=this.encryptionService.encrypt(t.toString());this.router.navigate(["/purchase/qc",e])}generatePdf(t,e){this.purchaseService.generatePdf(t).pipe(M(this.destroy$)).subscribe({next:({blob:n,filename:s})=>{let l="purchase-"+(e?`${e}.pdf`:s),u=window.URL.createObjectURL(n),m=document.createElement("a");m.href=u,m.download=l,document.body.appendChild(m),m.click(),document.body.removeChild(m),window.URL.revokeObjectURL(u),this.snackbar.success("PDF downloaded successfully")},error:n=>{this.snackbar.error(n?.error?.message||"Failed to generate PDF")}})}isExportButtonDisabled(){let t=this.searchForm.get("startDate")?.value,e=this.searchForm.get("endDate")?.value;return!t||!e}exportExcel(){let t=this.searchForm.get("startDate")?.value,e=this.searchForm.get("endDate")?.value;if(!t||!e){this.snackbar.error("Please select both start date and end date to export");return}let n=this.dateUtils.formatDateDDMMYYYY(t),s=this.dateUtils.formatDateDDMMYYYY(e);this.isLoading=!0,this.purchaseService.exportExcel({startDate:n,endDate:s}).pipe(M(this.destroy$)).subscribe({next:({blob:l,filename:u})=>{let m=window.URL.createObjectURL(l),_=document.createElement("a");_.href=m,_.download=u||`purchase_export_${n}_${s}.xlsx`,document.body.appendChild(_),_.click(),document.body.removeChild(_),window.URL.revokeObjectURL(m),this.snackbar.success("Excel file downloaded successfully"),this.isLoading=!1,this.cdr.markForCheck()},error:l=>{this.snackbar.error(l?.error?.message||"Failed to export Excel file"),this.isLoading=!1,this.cdr.markForCheck()}})}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete()}static{this.\u0275fac=function(e){return new(e||a)(P(G),P(ht),P($),P(U),P(Ht),P(Wt),P(At),P(Kt),P(B),P(tt),P(It),P(St))}}static{this.\u0275cmp=D({type:a,selectors:[["app-purchase"]],standalone:!0,features:[yt],decls:56,vars:9,consts:[[1,"purchase-container"],[3,"show"],["aria-labelledby","search-purchases-heading",1,"search-section","card"],["id","search-purchases-heading"],["role","search","aria-label","Purchase search form",3,"ngSubmit","formGroup"],[1,"search-controls"],[1,"form-group"],["for","invoice-search",1,"sr-only"],["id","invoice-search","type","text","formControlName","search","placeholder","Search by invoice number...","aria-label","Search by invoice number",1,"form-control"],["for","batch-search",1,"sr-only"],["id","batch-search","type","text","formControlName","batchNumber","placeholder","Search by Batch Number...","aria-label","Search by batch number",1,"form-control"],["class","form-group",4,"ngIf"],["for","start-date",1,"sr-only"],["id","start-date","type","date","formControlName","startDate","placeholder","Start Date","aria-label","Start date",1,"form-control",3,"touchstart"],["for","end-date",1,"sr-only"],["id","end-date","type","date","formControlName","endDate","placeholder","End Date","aria-label","End date",1,"form-control",3,"touchstart"],[1,"button-group"],["type","submit",1,"search-btn","btn","btn-sm","btn-primary"],[1,"fas","fa-search"],["type","button",1,"search-btn","btn","btn-sm","btn-secondary",3,"click"],[1,"fas","fa-undo"],["type","button","class","search-btn btn btn-sm btn-success export-btn","title","Export purchases to Excel",3,"disabled","click",4,"ngIf"],["class","action-header",4,"ngIf"],["aria-labelledby","purchases-heading",1,"purchases-list","card"],["id","purchases-heading"],[1,"table-responsive"],["role","table","aria-label","Purchases list",1,"table"],["scope","col"],["scope","col",4,"ngIf"],["role","row",4,"ngFor","ngForOf"],[3,"currentPage","pageSize","totalElements","pageSizeOptions","pageChange","pageSizeChange",4,"ngIf"],[3,"purchase","saleCreated",4,"ngIf"],[1,"product-select-group"],["formControlName","customerId","labelKey","name","valueKey","id",3,"options","defaultOption","searchPlaceholder"],["type","button","title","Refresh Customers",1,"btn","btn-sm","btn-primary","refresh",2,"margin-top","3px",3,"click","disabled"],[1,"fas",3,"ngClass"],["type","button","title","Export purchases to Excel",1,"search-btn","btn","btn-sm","btn-success","export-btn",3,"click","disabled"],[1,"fas","fa-file-excel"],[1,"action-header"],["aria-label","Add new purchase",1,"btn","btn-sm","btn-primary","mb-2",3,"click"],["aria-hidden","true",1,"fas","fa-plus"],["role","row"],["data-label","No"],["data-label","Invoice No."],["data-label","Customer Name"],["data-label","Purchase Date"],["data-label","Total Purchase Amount"],["data-label","QC Status"],[1,"status-chip"],["class","actions","data-label","Actions",4,"ngIf"],["data-label","Actions",1,"actions"],["aria-label","View purchase details",1,"btn-icon","edit",3,"click","touchstart"],["aria-hidden","true",1,"fas","fa-eye"],["aria-label","Export purchase as PDF",1,"btn-icon","pdf",3,"click","touchstart"],["aria-hidden","true",1,"fas","fa-file-pdf"],["aria-label","Add purchase return",1,"btn-icon","add-return",3,"click","touchstart"],["aria-hidden","true",1,"fas","fa-undo"],["aria-label","Purchase quality check",1,"btn-icon","qc",3,"click","touchstart"],["aria-hidden","true",1,"fas","fa-clipboard-check"],["aria-label","Delete purchase",1,"btn-icon","delete",3,"click","touchstart"],["aria-hidden","true",1,"fas","fa-trash"],[3,"pageChange","pageSizeChange","currentPage","pageSize","totalElements","pageSizeOptions"],[3,"saleCreated","purchase"]],template:function(e,n){e&1&&(i(0,"div",0),p(1,"app-loader",1),i(2,"section",2)(3,"h2",3),o(4,"Search Purchases"),r(),i(5,"form",4),b("ngSubmit",function(){return n.onSearch()}),i(6,"div",5)(7,"div",6)(8,"label",7),o(9,"Search by invoice number"),r(),p(10,"input",8),i(11,"label",9),o(12,"Search by batch number"),r(),p(13,"input",10),r(),f(14,ue,5,6,"div",11),i(15,"div",6)(16,"label",12),o(17,"Start date"),r(),i(18,"input",13),b("touchstart",function(l){return l.stopPropagation()}),r()(),i(19,"div",6)(20,"label",14),o(21,"End date"),r(),i(22,"input",15),b("touchstart",function(l){return l.stopPropagation()}),r()(),i(23,"div",16)(24,"button",17),p(25,"i",18),o(26," Search "),r(),i(27,"button",19),b("click",function(){return n.resetForm()}),p(28,"i",20),o(29," Reset "),r(),f(30,me,3,1,"button",21),r()()()(),f(31,pe,4,0,"div",22),i(32,"section",23)(33,"h2",24),o(34,"Purchases"),r(),i(35,"div",25)(36,"table",26)(37,"thead")(38,"tr")(39,"th",27),o(40,"No"),r(),i(41,"th",27),o(42,"Invoice No."),r(),i(43,"th",27),o(44,"Customer Name"),r(),i(45,"th",27),o(46,"Purchase Date"),r(),i(47,"th",27),o(48,"Total Purchase Amount"),r(),i(49,"th",27),o(50,"QC Status"),r(),f(51,ge,2,0,"th",28),r()(),i(52,"tbody"),f(53,_e,18,15,"tr",29),r()()(),f(54,fe,1,4,"app-pagination",30),r()(),f(55,Pe,1,1,"app-sale-modal",31)),e&2&&(c(),d("show",n.isLoading),c(4),d("formGroup",n.searchForm),c(9),d("ngIf",n.canManagePurchases),c(16),d("ngIf",n.canManagePurchases),c(),d("ngIf",n.canManagePurchases),c(20),d("ngIf",n.canManagePurchases),c(2),d("ngForOf",n.purchases),c(),d("ngIf",n.totalPages>0),c(),d("ngIf",n.selectedPurchase))},dependencies:[ot,J,T,R,X,ut,z,V,L,q,Q,j,Yt,Y,Jt,Xt,et,nt,pt],styles:[".purchase-container[_ngcontent-%COMP%]{padding:2rem;position:relative;min-height:200px;background-color:var(--background)}.purchase-container[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]{background:#fff;border-radius:0;box-shadow:0 2px 4px #0000001a;margin-bottom:20px;padding:20px}.purchase-container[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{margin-bottom:20px;color:var(--text-primary);font-size:1.5rem;font-weight:600}.purchase-container[_ngcontent-%COMP%]   .action-header[_ngcontent-%COMP%]{margin-bottom:1rem}.purchase-container[_ngcontent-%COMP%]   .action-header[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{touch-action:manipulation;-webkit-tap-highlight-color:transparent}.purchase-container[_ngcontent-%COMP%]   .sr-only[_ngcontent-%COMP%]{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border-width:0}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;align-items:flex-start}@media (max-width: 768px){.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]{grid-template-columns:1fr}}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]{margin:0}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]   .form-control[_ngcontent-%COMP%]{height:40px}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]   .product-select-group[_ngcontent-%COMP%]{display:flex;gap:.5rem}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]   .product-select-group[_ngcontent-%COMP%]   app-searchable-select[_ngcontent-%COMP%]{flex:1}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]   .product-select-group[_ngcontent-%COMP%]   .btn-icon[_ngcontent-%COMP%]{width:42px;padding:0;display:flex;align-items:center;justify-content:center;border:1px solid var(--border-color);border-radius:var(--border-radius);background:var(--primary)}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]   .product-select-group[_ngcontent-%COMP%]   .btn-icon[_ngcontent-%COMP%]:hover:not(:disabled){background:var(--primary)}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]   .product-select-group[_ngcontent-%COMP%]   .btn-icon[_ngcontent-%COMP%]:disabled{opacity:.6;cursor:not-allowed}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]{display:flex;gap:.5rem;flex-wrap:wrap}@media (max-width: 768px){.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]{grid-column:1/-1}}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{flex:1;min-width:120px;height:42px;display:flex;align-items:center;justify-content:center;gap:.5rem;transition:all .2s ease;touch-action:manipulation;-webkit-tap-highlight-color:transparent;cursor:pointer}@media (max-width: 576px){.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{min-width:100%;flex:1 1 100%}}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{font-size:1rem}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]   button.export-btn[_ngcontent-%COMP%]{background-color:#28a745;color:#fff;border:1px solid #28a745;font-weight:500}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]   button.export-btn[_ngcontent-%COMP%]:hover:not(:disabled){background-color:#218838;border-color:#1e7e34;transform:translateY(-1px);box-shadow:0 2px 4px #28a7454d}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]   button.export-btn[_ngcontent-%COMP%]:active:not(:disabled), .purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]   button.export-btn[_ngcontent-%COMP%]:focus:not(:disabled){outline:2px solid rgba(40,167,69,.5);outline-offset:2px;transform:translateY(0)}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]   button.export-btn[_ngcontent-%COMP%]:disabled{background-color:#6c757d;border-color:#6c757d;opacity:.6;cursor:not-allowed;transform:none}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]   button.export-btn[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{color:#fff}.purchase-container[_ngcontent-%COMP%]   .purchases-list[_ngcontent-%COMP%]   .table-responsive[_ngcontent-%COMP%]{overflow-x:auto;-webkit-overflow-scrolling:touch}.purchase-container[_ngcontent-%COMP%]   .purchases-list[_ngcontent-%COMP%]   .table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{white-space:nowrap;font-weight:600}.purchase-container[_ngcontent-%COMP%]   .purchases-list[_ngcontent-%COMP%]   .table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{vertical-align:middle}@media (max-width: 768px){.purchase-container[_ngcontent-%COMP%]   .purchases-list[_ngcontent-%COMP%]   .table[_ngcontent-%COMP%]   thead[_ngcontent-%COMP%]{display:none}.purchase-container[_ngcontent-%COMP%]   .purchases-list[_ngcontent-%COMP%]   .table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]{display:block;margin-bottom:1rem;border:1px solid #dee2e6;border-radius:4px;padding:.5rem}.purchase-container[_ngcontent-%COMP%]   .purchases-list[_ngcontent-%COMP%]   .table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;padding:.5rem;border:none;border-bottom:1px solid #f0f0f0}.purchase-container[_ngcontent-%COMP%]   .purchases-list[_ngcontent-%COMP%]   .table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]:before{content:attr(data-label);font-weight:600;color:var(--text-primary)}.purchase-container[_ngcontent-%COMP%]   .purchases-list[_ngcontent-%COMP%]   .table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]:last-child{border-bottom:none}.purchase-container[_ngcontent-%COMP%]   .purchases-list[_ngcontent-%COMP%]   .table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   td.actions[_ngcontent-%COMP%]{justify-content:flex-start;flex-wrap:wrap;gap:.5rem}.purchase-container[_ngcontent-%COMP%]   .purchases-list[_ngcontent-%COMP%]   .table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   td.actions[_ngcontent-%COMP%]:before{display:none}}.purchase-container[_ngcontent-%COMP%]   .table-controls[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}.purchase-container[_ngcontent-%COMP%]   .table-controls[_ngcontent-%COMP%]   .page-size-selector[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem}.purchase-container[_ngcontent-%COMP%]   .table-controls[_ngcontent-%COMP%]   .page-size-selector[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{color:var(--text-secondary);white-space:nowrap}.purchase-container[_ngcontent-%COMP%]   .table-controls[_ngcontent-%COMP%]   .page-size-selector[_ngcontent-%COMP%]   select.form-control[_ngcontent-%COMP%]{width:auto;min-width:80px;padding:.5rem;margin-bottom:0}@media (max-width: 768px){.purchase-container[_ngcontent-%COMP%]{padding:1rem}.purchase-container[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]{flex-direction:column;gap:1rem}.purchase-container[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]{width:100%}.purchase-container[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]   input[type=date][_ngcontent-%COMP%]{touch-action:manipulation;-webkit-appearance:none}.purchase-container[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{width:100%}.purchase-container[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]{padding:1rem}}@media (max-width: 576px){.purchase-container[_ngcontent-%COMP%]{padding:.75rem}.purchase-container[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{font-size:1.25rem}}@media (max-width: 576px){.table-controls[_ngcontent-%COMP%]{flex-direction:column;gap:1rem;align-items:flex-start}.table-controls[_ngcontent-%COMP%]   .page-size-selector[_ngcontent-%COMP%]{width:100%}.table-controls[_ngcontent-%COMP%]   .page-size-selector[_ngcontent-%COMP%]   select.form-control[_ngcontent-%COMP%]{flex:1}}.actions[_ngcontent-%COMP%]{display:flex;gap:.5rem;justify-content:flex-start;flex-wrap:wrap}.actions[_ngcontent-%COMP%]   .btn-icon[_ngcontent-%COMP%]{background:none;border:none;padding:8px;cursor:pointer;border-radius:6px;transition:all .2s ease;display:flex;align-items:center;justify-content:center;touch-action:manipulation;-webkit-tap-highlight-color:transparent;min-width:36px;min-height:36px}.actions[_ngcontent-%COMP%]   .btn-icon.edit[_ngcontent-%COMP%]{color:var(--primary);background-color:#1458811a}.actions[_ngcontent-%COMP%]   .btn-icon.edit[_ngcontent-%COMP%]:hover:not(:disabled){background-color:var(--primary);color:#fff;transform:translateY(-1px)}.actions[_ngcontent-%COMP%]   .btn-icon.edit[_ngcontent-%COMP%]:disabled{color:var(--text-secondary);background-color:#0000000d;cursor:not-allowed}.actions[_ngcontent-%COMP%]   .btn-icon.pdf[_ngcontent-%COMP%]{color:#dc3545;background-color:#dc35451a}.actions[_ngcontent-%COMP%]   .btn-icon.pdf[_ngcontent-%COMP%]:hover:not(:disabled){background-color:#dc3545;color:#fff;transform:translateY(-1px)}.actions[_ngcontent-%COMP%]   .btn-icon.pdf[_ngcontent-%COMP%]:disabled{color:var(--text-secondary);background-color:#0000000d;cursor:not-allowed}.actions[_ngcontent-%COMP%]   .btn-icon.add-return[_ngcontent-%COMP%]{color:#ff9800;background-color:#ff98001a}.actions[_ngcontent-%COMP%]   .btn-icon.add-return[_ngcontent-%COMP%]:hover:not(:disabled){background-color:#ff9800;color:#fff;transform:translateY(-1px)}.actions[_ngcontent-%COMP%]   .btn-icon.add-return[_ngcontent-%COMP%]:disabled{color:var(--text-secondary);background-color:#0000000d;cursor:not-allowed}.actions[_ngcontent-%COMP%]   .btn-icon.qc[_ngcontent-%COMP%]{color:#28a745;background-color:#28a7451a}.actions[_ngcontent-%COMP%]   .btn-icon.qc[_ngcontent-%COMP%]:hover:not(:disabled){background-color:#28a745;color:#fff;transform:translateY(-1px)}.actions[_ngcontent-%COMP%]   .btn-icon.qc[_ngcontent-%COMP%]:disabled{color:var(--text-secondary);background-color:#0000000d;cursor:not-allowed}.actions[_ngcontent-%COMP%]   .btn-icon.sale[_ngcontent-%COMP%]{color:var(--primary);background-color:#fd78231a}.actions[_ngcontent-%COMP%]   .btn-icon.sale[_ngcontent-%COMP%]:hover:not(:disabled){background-color:var(--primary);color:#fff;transform:translateY(-1px)}.actions[_ngcontent-%COMP%]   .btn-icon.sale[_ngcontent-%COMP%]:disabled{color:var(--text-secondary);background-color:#0000000d;cursor:not-allowed}.actions[_ngcontent-%COMP%]   .btn-icon.delete[_ngcontent-%COMP%]{color:#dc3545;background-color:#dc35451a}.actions[_ngcontent-%COMP%]   .btn-icon.delete[_ngcontent-%COMP%]:hover{background-color:#dc3545;color:#fff;transform:translateY(-1px)}.actions[_ngcontent-%COMP%]   .btn-icon[_ngcontent-%COMP%]:active{transform:translateY(0)}.actions[_ngcontent-%COMP%]   .btn-icon[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{font-size:16px}@media (max-width: 768px){.actions[_ngcontent-%COMP%]   .btn-icon[_ngcontent-%COMP%]{padding:6px}.actions[_ngcontent-%COMP%]   .btn-icon[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{font-size:14px}}.status-chip[_ngcontent-%COMP%]{display:inline-flex;align-items:center;justify-content:center;padding:.25rem .75rem;border-radius:999px;font-size:.8rem;font-weight:600;letter-spacing:.02em;text-transform:uppercase;white-space:nowrap}.status-chip.pass[_ngcontent-%COMP%]{background-color:#28a74526;color:#28a745}.status-chip.pending[_ngcontent-%COMP%]{background-color:#ffc10726;color:#ffc107}  .custom-snackbar.success{background-color:var(--accent2)}  .custom-snackbar.error{background-color:#dc3545}  .custom-snackbar .snackbar-message{display:flex;align-items:center;gap:.5rem;color:#fff}  .custom-snackbar .snackbar-message i{font-size:1.2rem}.loading-overlay[_ngcontent-%COMP%]{position:absolute;inset:0;background:#fffc;display:flex;justify-content:center;align-items:center;z-index:1000}.loading-overlay[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{font-size:2rem;color:var(--primary)}.product-select-group[_ngcontent-%COMP%]{display:flex;gap:.5rem;align-items:flex-start}.product-select-group[_ngcontent-%COMP%]   app-searchable-select[_ngcontent-%COMP%]{flex:1}.product-select-group[_ngcontent-%COMP%]   .btn-icon.refresh[_ngcontent-%COMP%]{background-color:var(--background);color:#fff;margin-top:3px;width:42px;height:42px;border-radius:6px;transition:all .2s ease}.product-select-group[_ngcontent-%COMP%]   .btn-icon.refresh[_ngcontent-%COMP%]:hover:not(:disabled){background-color:var(--primary);color:#fff;transform:translateY(-1px)}.product-select-group[_ngcontent-%COMP%]   .btn-icon.refresh[_ngcontent-%COMP%]:disabled{opacity:.7;cursor:not-allowed}.product-select-group[_ngcontent-%COMP%]   .btn-icon.refresh[_ngcontent-%COMP%]:active{transform:translateY(0)}"],changeDetection:0})}}return a})();function be(a,h){a&1&&(i(0,"div",47),o(1," Customer is required "),r())}function Ce(a,h){a&1&&(i(0,"div",47),o(1," Purchase date is required "),r())}function ve(a,h){a&1&&(i(0,"div",47),o(1," Invoice number is required "),r())}function xe(a,h){a&1&&(i(0,"div",47),o(1," Packaging and forwarding charges is required and must be 0 or greater "),r())}function Me(a,h){a&1&&(i(0,"div",47),o(1," Please select a product "),r())}function ye(a,h){a&1&&(i(0,"div",47),o(1," Quantity must be 1 or greater "),r())}function Oe(a,h){a&1&&(i(0,"div",47),o(1," Double quotes are not allowed "),r())}function Se(a,h){a&1&&(i(0,"div",47),o(1," Unit price must be greater than 0 "),r())}function we(a,h){if(a&1&&(i(0,"div",27)(1,"span",28),o(2,"%"),r(),p(3,"input",66),r()),a&2){let t=g().index,e=g();c(3),F("is-invalid",e.isProductFieldInvalid(t,"discountPercentage"))}}function ke(a,h){a&1&&(i(0,"div",27),p(1,"input",67),i(2,"span",68),o(3,"-"),r()())}function Ee(a,h){a&1&&(i(0,"div",47),o(1," Discount percentage must be between 0 and 100 "),r())}function Ie(a,h){if(a&1&&(i(0,"div",27)(1,"span",28),o(2,"\u20B9"),r(),p(3,"input",69),r()),a&2){let t=g().index,e=g();c(3),F("is-invalid",e.isProductFieldInvalid(t,"discountAmount"))}}function Ae(a,h){if(a&1&&(i(0,"div",27)(1,"span",28),o(2,"\u20B9"),r(),p(3,"input",70),r()),a&2){let t=g().index,e=g();c(3),d("value",e.getFormattedDiscountAmount(t))}}function Fe(a,h){a&1&&(i(0,"div",47),o(1," Discount amount cannot exceed subtotal "),r())}function Ne(a,h){if(a&1){let t=A();i(0,"tr",48)(1,"td")(2,"div",49)(3,"div",14),p(4,"app-searchable-select",50),i(5,"button",51),b("click",function(){C(t);let n=g();return v(n.refreshProducts())}),p(6,"i",17),r()(),f(7,Me,2,0,"div",18),r()(),i(8,"td")(9,"div",49),p(10,"input",52),f(11,ye,2,0,"div",18),r()(),i(12,"td")(13,"div",49),p(14,"input",53),f(15,Oe,2,0,"div",18),r()(),i(16,"td")(17,"div",49)(18,"div",27),p(19,"input",54),r(),f(20,Se,2,0,"div",18),r()(),i(21,"td")(22,"div",27),p(23,"input",55),r()(),i(24,"td")(25,"div",49)(26,"div",56)(27,"div",57)(28,"input",58),b("change",function(){let n=C(t).index,s=g();return v(s.onDiscountTypeChange(n))}),r(),i(29,"label",59),o(30,"%"),r()(),i(31,"div",57)(32,"input",58),b("change",function(){let n=C(t).index,s=g();return v(s.onDiscountTypeChange(n))}),r(),i(33,"label",59),o(34,"\u20B9"),r()()()()(),i(35,"td")(36,"div",49),f(37,we,4,2,"div",60)(38,ke,4,0,"div",60)(39,Ee,2,0,"div",18),r()(),i(40,"td")(41,"div",49),f(42,Ie,4,2,"div",60)(43,Ae,4,1,"div",60)(44,Fe,2,0,"div",18),r()(),i(45,"td")(46,"div",27),p(47,"input",61),r()(),i(48,"td")(49,"div",27),p(50,"input",62),r()(),i(51,"td")(52,"div",49),p(53,"input",63),r()(),i(54,"td")(55,"button",64),b("click",function(){let n=C(t).index,s=g();return v(s.removeProduct(n))}),p(56,"i",65),r()()()}if(a&2){let t,e,n,s,l,u=h.index,m=g();d("formGroupName",u),c(4),F("is-invalid",m.isProductFieldInvalid(u,"productId")),d("focusWidthPx",600)("options",m.products)("placeholder","Select Product")("searchPlaceholder","Search products..."),c(),d("disabled",m.isLoadingProducts),c(),d("ngClass",m.isLoadingProducts?"fa-spinner fa-spin":"fa-sync-alt"),c(),d("ngIf",m.isProductFieldInvalid(u,"productId")),c(3),F("is-invalid",m.isProductFieldInvalid(u,"quantity")),c(),d("ngIf",m.isProductFieldInvalid(u,"quantity")),c(3),F("is-invalid",m.isProductFieldInvalid(u,"batchNumber")),c(),d("ngIf",(t=m.productsFormArray.at(u).get("batchNumber"))==null||t.errors==null?null:t.errors.doubleQuotes),c(4),F("is-invalid",m.isProductFieldInvalid(u,"unitPrice")),c(),d("ngIf",m.isProductFieldInvalid(u,"unitPrice")),c(3),d("value",m.getFormattedPrice(u)),c(5),d("value","percentage")("id","discountTypePercentage"+u),c(),d("for","discountTypePercentage"+u),c(3),d("value","amount")("id","discountTypeAmount"+u),c(),d("for","discountTypeAmount"+u),c(4),d("ngIf",((e=m.productsFormArray.at(u).get("discountType"))==null?null:e.value)==="percentage"),c(),d("ngIf",((n=m.productsFormArray.at(u).get("discountType"))==null?null:n.value)!=="percentage"),c(),d("ngIf",m.isProductFieldInvalid(u,"discountPercentage")),c(3),d("ngIf",((s=m.productsFormArray.at(u).get("discountType"))==null?null:s.value)==="amount"),c(),d("ngIf",((l=m.productsFormArray.at(u).get("discountType"))==null?null:l.value)!=="amount"),c(),d("ngIf",m.isProductFieldInvalid(u,"discountAmount")),c(3),d("value",m.getFormattedDiscountPrice(u)),c(3),d("value",m.getFormattedTaxAmount(u)),c(5),d("disabled",m.productsFormArray.length===1)}}function De(a,h){if(a&1&&(i(0,"div",39)(1,"span"),o(2,"Total Discount:"),r(),i(3,"strong",71),o(4),E(5,"number"),r()()),a&2){let t=g();c(4),O("-\u20B9",I(5,1,t.totalDiscountAmount,"1.2-2"),"")}}function Te(a,h){a&1&&p(0,"app-loader")}var Lt=(()=>{class a{get productsFormArray(){return this.purchaseForm.get("products")}trackByProductIndex(t,e){return e}constructor(t,e,n,s,l,u,m,_,x){this.fb=t,this.productService=e,this.customerService=n,this.purchaseService=s,this.snackbar=l,this.http=u,this.router=m,this.encryptionService=_,this.cdr=x,this.products=[],this.customers=[],this.loading=!1,this.isLoadingProducts=!1,this.isLoadingCustomers=!1,this.isEdit=!1,this.destroy$=new N,this.productSubscriptions=[],this.totalAmount=0,this.totalDiscountAmount=0,this.totalTaxAmount=0,this.grandTotal=0,this.productMap=new Map,this.initForm()}ngOnInit(){this.loadProducts(),this.loadCustomers();let t=localStorage.getItem("purchaseId");if(t){let e=this.encryptionService.decrypt(t);e&&this.fetchPurchaseDetails(Number(e))}}ngOnDestroy(){this.productSubscriptions.forEach(t=>{t&&!t.closed&&t.unsubscribe()}),this.productSubscriptions=[],this.destroy$.next(),this.destroy$.complete(),this.products=[],this.customers=[],this.productMap.clear(),this.purchaseForm&&this.purchaseForm.reset()}initForm(){this.purchaseForm=this.fb.group({id:[null],customerId:["",w.required],purchaseDate:[H(new Date,"yyyy-MM-dd","en"),w.required],invoiceNumber:["",w.required],packagingAndForwadingCharges:[0,[w.required,w.min(0)]],products:this.fb.array([])}),this.purchaseForm.get("packagingAndForwadingCharges")?.valueChanges.pipe(M(this.destroy$),ft(150)).subscribe(()=>{let t=Number(this.purchaseForm.get("packagingAndForwadingCharges")?.value||0);this.cdr.markForCheck()}),this.addProduct()}createProductFormGroup(){return this.fb.group({id:[null],productId:["",w.required],quantity:["",[w.required,w.min(1)]],batchNumber:["",[this.noDoubleQuotesValidator()]],unitPrice:["",[w.required,w.min(.01)]],price:[{value:0,disabled:!0}],discountType:["percentage"],discountPercentage:[0,[w.min(0),w.max(100)]],discountAmount:[0,[w.min(0)]],discountPrice:[{value:0,disabled:!0}],taxPercentage:[{value:0,disabled:!0}],taxAmount:[{value:0,disabled:!0}],remarks:[null,[]]})}addProduct(){let t=this.createProductFormGroup(),e=this.setupProductCalculations(t);this.productSubscriptions.push(e),this.productsFormArray.push(t)}removeProduct(t){this.productsFormArray.length!==1&&(this.productSubscriptions[t]&&(this.productSubscriptions[t].unsubscribe(),this.productSubscriptions.splice(t,1)),this.productsFormArray.removeAt(t),this.calculateTotalAmount())}setupProductCalculations(t){let e=new zt,n=t.get("productId")?.valueChanges.pipe(M(this.destroy$),Qt()).subscribe(l=>{if(l){let u=this.productMap.get(l);if(u){let m=u.taxPercentage||0,_=u.purchaseAmount||0;t.patchValue({taxPercentage:m,unitPrice:_},{emitEvent:!1}),this.calculateProductPrice(t)}}});n&&e.add(n);let s=t.valueChanges.pipe(M(this.destroy$),ft(150)).subscribe(()=>{this.calculateProductPrice(t)});return e.add(s),e}calculateProductPrice(t){if(!t)return;let e=Number(t.get("quantity")?.value||0),n=Number(t.get("unitPrice")?.value||0),s=Number(t.get("taxPercentage")?.value||0),l=t.get("discountType")?.value||"percentage",u=Number(t.get("discountPercentage")?.value||0),m=Number(t.get("discountAmount")?.value||0),_=Number((e*n).toFixed(2)),x=0;if(l==="percentage"&&u>0){let ae=Math.min(u,100);x=Number((_*(ae/100)).toFixed(2)),u>100&&t.patchValue({discountPercentage:100},{emitEvent:!1})}else l==="amount"&&m>0&&(x=Math.min(m,_),m>_&&t.patchValue({discountAmount:_},{emitEvent:!1}));let S=Number((_-x).toFixed(2)),k=Number((S*s/100).toFixed(2)),it=Number((S+k).toFixed(2));t.patchValue({price:_,discountAmount:x,discountPrice:S,taxAmount:k},{emitEvent:!1}),this.calculateTotalAmount()}getTotalAmount(){return this.productsFormArray.controls.reduce((t,e)=>t+(e.get("price").value||0),0)}getTotalTaxAmount(){return this.productsFormArray.controls.reduce((t,e)=>t+(e.get("taxAmount").value||0),0)}getGrandTotal(){let t=Number(this.purchaseForm.get("packagingAndForwadingCharges")?.value||0);return this.getTotalFinalPrice()+t}getTotalFinalPrice(){return this.productsFormArray.controls.reduce((t,e)=>{let n=Number(e.get("discountPrice")?.value||e.get("price")?.value||0),s=Number(e.get("taxAmount")?.value||0);return t+(n+s)},0)}getTotalDiscountAmount(){return this.productsFormArray.controls.reduce((t,e)=>t+Number(e.get("discountAmount")?.value||0),0)}onDiscountTypeChange(t){let e=this.productsFormArray.at(t);e.get("discountType")?.value==="percentage"?e.patchValue({discountAmount:0},{emitEvent:!1}):e.patchValue({discountPercentage:0},{emitEvent:!1}),this.calculateProductPrice(e)}validateDiscount(t){let e=this.productsFormArray.at(t),n=Number(e.get("quantity")?.value||0),s=Number(e.get("unitPrice")?.value||0),l=n*s,u=e.get("discountType")?.value,m=Number(e.get("discountPercentage")?.value||0),_=Number(e.get("discountAmount")?.value||0);if(u==="percentage"){if(m<0||m>100)return!1}else if(u==="amount"){if(_<0)return!1;if(_>l)return e.patchValue({discountAmount:l},{emitEvent:!1}),this.calculateProductPrice(e),!1}return!0}transformProductsWithDisplayName(t){return t.map(e=>qt(bt({},e),{displayName:e.materialName?`${e.name} (${e.materialName})`:e.name}))}loadProducts(){this.isLoadingProducts=!0,this.productService.getProducts({status:"A"}).pipe(M(this.destroy$)).subscribe({next:t=>{t.success&&(this.products=this.transformProductsWithDisplayName(t.data),this.buildProductMap()),this.isLoadingProducts=!1,this.cdr.markForCheck()},error:t=>{this.snackbar.error("Failed to load products"),this.isLoadingProducts=!1,this.cdr.markForCheck()}})}buildProductMap(){this.productMap.clear();for(let t of this.products)this.productMap.set(t.id,t)}refreshProducts(){this.isLoadingProducts=!0,this.productService.refreshProducts().pipe(M(this.destroy$)).subscribe({next:t=>{t.success&&(this.products=this.transformProductsWithDisplayName(t.data),this.buildProductMap(),this.snackbar.success("Products refreshed successfully")),this.isLoadingProducts=!1,this.cdr.markForCheck()},error:t=>{this.snackbar.error("Failed to refresh products"),this.isLoadingProducts=!1,this.cdr.markForCheck()}})}loadCustomers(){this.isLoadingCustomers=!0,this.customerService.getCustomers({status:"A"}).pipe(M(this.destroy$)).subscribe({next:t=>{t.success&&(this.customers=t.data),this.isLoadingCustomers=!1,this.cdr.markForCheck()},error:t=>{this.snackbar.error("Failed to load customers"),this.isLoadingCustomers=!1,this.cdr.markForCheck()}})}refreshCustomers(){this.isLoadingCustomers=!0,this.customerService.refreshCustomers().pipe(M(this.destroy$)).subscribe({next:t=>{t.success&&(this.customers=t.data),this.snackbar.success("Customers refreshed successfully"),this.isLoadingCustomers=!1,this.cdr.markForCheck()},error:t=>{this.snackbar.error("Failed to load customers"),this.isLoadingCustomers=!1,this.cdr.markForCheck()}})}isFieldInvalid(t){let e=this.purchaseForm.get(t);return e?e.invalid&&e.touched:!1}isProductFieldInvalid(t,e){let n=this.productsFormArray.at(t).get(e);if(!n)return!1;if(n.invalid&&(n.dirty||n.touched)){let l=n.errors;if(l&&(l.required||l.min&&(e==="quantity"||e==="unitPrice"||e==="discountAmount")||l.max&&e==="discountPercentage"||l.min||l.max))return!0}if(e==="discountAmount"){let l=this.productsFormArray.at(t),u=Number(l.get("quantity")?.value||0),m=Number(l.get("unitPrice")?.value||0),_=u*m;if(Number(n.value||0)>_)return!0}return!1}resetForm(){this.isEdit=!1,this.purchaseForm.patchValue({id:null}),this.initForm()}onSubmit(){if(this.markFormGroupTouched(this.purchaseForm),this.purchaseForm.valid){this.loading=!0;let t=this.preparePurchaseData();(this.isEdit?this.purchaseService.updatePurchase(t):this.purchaseService.createPurchase(t)).pipe(M(this.destroy$)).subscribe({next:n=>{n?.success&&(this.snackbar.success(`Purchase ${this.isEdit?"updated":"created"} successfully`),localStorage.removeItem("purchaseId"),this.router.navigate(["/purchase"])),this.loading=!1},error:n=>{this.snackbar.error(n?.error?.message||`Failed to ${this.isEdit?"update":"create"} purchase`),this.loading=!1}})}else{let t=document.querySelector(".is-invalid");t&&t.scrollIntoView({behavior:"smooth",block:"center"})}}preparePurchaseData(){let t=this.purchaseForm.value,e={purchaseDate:H(t.purchaseDate,"dd-MM-yyyy","en"),customerId:t.customerId,invoiceNumber:t.invoiceNumber,price:this.getTotalAmount(),discountAmount:this.getTotalDiscountAmount(),taxAmount:this.getTotalTaxAmount(),packagingAndForwadingCharges:Number(t.packagingAndForwadingCharges||0),products:t.products.map((n,s)=>{let l=this.productsFormArray.at(s).get("id")?.value,u=this.productsFormArray.at(s).get("price")?.value||0,m=Number(this.productsFormArray.at(s).get("discountPercentage")?.value||0),_=Number(this.productsFormArray.at(s).get("discountAmount")?.value||0),x=Number(this.productsFormArray.at(s).get("discountPrice")?.value||u),S=this.productsFormArray.at(s).get("taxAmount")?.value||0,k={productId:n.productId,quantity:n.quantity,batchNumber:n.batchNumber,unitPrice:n.unitPrice,price:u,discountPercentage:m,discountAmount:_,taxPercentage:this.productsFormArray.at(s).get("taxPercentage")?.value,taxAmount:S,finalPrice:x+S,remarks:n.remarks};return this.isEdit&&l&&(k.id=l),k})};return this.isEdit&&t.id&&(e.id=t.id),e}markFormGroupTouched(t){Object.values(t.controls).forEach(e=>{e instanceof Ut||e instanceof Gt?this.markFormGroupTouched(e):(e.markAsTouched(),e.markAsDirty())})}calculateTotalAmount(){this.totalAmount=this.productsFormArray.controls.reduce((e,n)=>e+(n.get("price").value||0),0),this.totalDiscountAmount=this.productsFormArray.controls.reduce((e,n)=>e+Number(n.get("discountAmount")?.value||0),0),this.totalTaxAmount=this.productsFormArray.controls.reduce((e,n)=>e+(n.get("taxAmount").value||0),0);let t=Number(this.purchaseForm.get("packagingAndForwadingCharges")?.value||0);this.grandTotal=this.getTotalFinalPrice()+t,this.purchaseForm.patchValue({price:this.totalAmount,taxAmount:this.totalTaxAmount},{emitEvent:!1}),this.cdr.markForCheck()}noDoubleQuotesValidator(){return t=>t.value&&t.value.includes('"')?{doubleQuotes:!0}:null}getFormattedPrice(t){let e=this.productsFormArray.at(t).get("price")?.value;return e?e.toFixed(2):"0.00"}getFormattedTaxAmount(t){let e=this.productsFormArray.at(t).get("taxAmount")?.value;return e?e.toFixed(2):"0.00"}getFormattedDiscountAmount(t){let e=this.productsFormArray.at(t).get("discountAmount")?.value;return e?e.toFixed(2):"0.00"}getFormattedDiscountPrice(t){let e=this.productsFormArray.at(t).get("discountPrice")?.value,n=this.productsFormArray.at(t).get("price")?.value;return e?e.toFixed(2):n?n.toFixed(2):"0.00"}fetchPurchaseDetails(t){this.purchaseService.getPurchaseDetails(t).pipe(M(this.destroy$)).subscribe({next:e=>{e.id&&(this.isEdit=!0,this.populateForm(e))},error:e=>{this.snackbar.error(e?.error?.message||"Failed to load purchase details")}})}populateForm(t){this.productSubscriptions.forEach(e=>{e&&!e.closed&&e.unsubscribe()}),this.productSubscriptions=[],this.purchaseForm.patchValue({customerId:t.customerId,id:t.id,purchaseDate:H(new Date(t.purchaseDate),"yyyy-MM-dd","en"),invoiceNumber:t.invoiceNumber,packagingAndForwadingCharges:t.packagingAndForwadingCharges||0}),this.productsFormArray.clear(),t.items.forEach(e=>{let n=this.createProductFormGroup(),s=this.setupProductCalculations(n);this.productSubscriptions.push(s);let l=e.discountPercentage||0,u=e.discountAmount||0,m=l>0?"percentage":u>0?"amount":"percentage";n.patchValue({id:e.id,productId:e.productId,quantity:e.quantity,unitPrice:e.unitPrice,price:e.price||0,discountType:m,discountPercentage:l,discountAmount:u,discountPrice:e.discountPrice||(e.price||0)-(u||0),taxPercentage:e.taxPercentage||0,taxAmount:e.taxAmount||0,batchNumber:e.batchNumber||"",remarks:e.remarks||""},{emitEvent:!1}),this.productsFormArray.push(n)}),this.calculateTotalAmount(),this.isEdit=!0}static{this.\u0275fac=function(e){return new(e||a)(P($),P(gt),P(ht),P(G),P(U),P(wt),P(tt),P(B),P(St))}}static{this.\u0275cmp=D({type:a,selectors:[["app-add-purchase"]],standalone:!0,features:[yt],decls:136,vars:46,consts:[[1,"add-purchase-container"],["routerLink","/purchase",1,"btn","btn-sm","btn-secondary","back-btn"],[1,"fas","fa-arrow-left"],[1,"form-card"],[1,"card-header"],[1,"form-title"],[1,"fas","fa-cart-plus"],[1,"purchase-form",3,"ngSubmit","formGroup"],[1,"header-section"],[1,"form-row"],[1,"form-group"],["for","customerId"],[1,"fas","fa-user"],[1,"required"],[1,"select-group"],["formControlName","customerId","labelKey","name","valueKey","id",3,"options","placeholder","searchPlaceholder"],["type","button","title","Refresh Customers",1,"btn","btn-sm","btn-primary","refresh",3,"click","disabled"],[1,"fas",3,"ngClass"],["class","invalid-feedback",4,"ngIf"],["for","purchaseDate"],[1,"fas","fa-calendar"],["type","date","id","purchaseDate","formControlName","purchaseDate",1,"form-control"],["for","invoiceNumber"],[1,"fas","fa-file-invoice"],["type","text","id","invoiceNumber","formControlName","invoiceNumber",1,"form-control"],["for","packagingAndForwadingCharges"],[1,"fas","fa-box"],[1,"input-group"],[1,"input-group-text"],["type","number","id","packagingAndForwadingCharges","formControlName","packagingAndForwadingCharges","min","0","step","0.01","placeholder","Enter packaging and forwarding charges",1,"form-control"],["formArrayName","products",1,"products-section"],[1,"products-header"],[1,"fas","fa-boxes"],["type","button",1,"btn","btn-sm","btn-primary",3,"click"],[1,"fas","fa-plus"],[1,"table-responsive"],[1,"table","products-table"],[3,"formGroupName",4,"ngFor","ngForOf"],[1,"purchase-summary"],[1,"summary-item"],["class","summary-item",4,"ngIf"],[1,"summary-item","total"],[1,"form-actions"],["type","button",1,"btn","btn-sm","btn-secondary",3,"click","disabled"],[1,"fas","fa-undo"],["type","submit",1,"btn","btn-sm","btn-primary",3,"disabled"],[4,"ngIf"],[1,"invalid-feedback"],[3,"formGroupName"],[1,"form-field-container"],["formControlName","productId","labelKey","displayName","valueKey","id",3,"focusWidthPx","options","placeholder","searchPlaceholder"],["type","button","title","Refresh Products",1,"btn","btn-sm","btn-primary","refresh",3,"click","disabled"],["type","number","formControlName","quantity","placeholder","Qty","min","1",1,"form-control"],["type","text","formControlName","batchNumber","placeholder","Batch Number",1,"form-control"],["type","number","formControlName","unitPrice","placeholder","Price","min","0.01","step","0.01",1,"form-control"],["type","number","formControlName","price","readonly","","title","Subtotal (before discount)",1,"form-control",3,"value"],[1,"discount-type-selector"],[1,"form-check","form-check-inline"],["type","radio","formControlName","discountType",1,"form-check-input",3,"change","value","id"],[1,"form-check-label",3,"for"],["class","input-group",4,"ngIf"],["type","number","formControlName","discountPrice","readonly","","title","Price after discount",1,"form-control","discount-price-display",3,"value"],["type","number","formControlName","taxAmount","readonly","","title","Tax calculated on discounted price",1,"form-control",3,"value"],["type","text","formControlName","remarks","placeholder","Remarks",1,"form-control"],["type","button","title","Remove Product",1,"btn","btn-sm","btn-danger",3,"click","disabled"],[1,"fas","fa-trash"],["type","number","formControlName","discountPercentage","placeholder","0.00","min","0","max","100","step","0.01",1,"form-control"],["type","number","formControlName","discountPercentage","readonly","","value","0",1,"form-control",2,"display","none"],[1,"form-control",2,"background-color","#f8f9fa","color","#6c757d"],["type","number","formControlName","discountAmount","placeholder","0.00","min","0","step","0.01",1,"form-control"],["type","number","formControlName","discountAmount","readonly","","title","Calculated discount amount",1,"form-control","discount-amount-display",3,"value"],[1,"discount-amount"]],template:function(e,n){if(e&1&&(i(0,"div",0)(1,"button",1),p(2,"i",2),o(3," Back to Purchases "),r(),i(4,"div",3)(5,"div",4)(6,"h2",5),p(7,"i",6),o(8," Add New Purchase "),r()(),i(9,"form",7),b("ngSubmit",function(){return n.onSubmit()}),i(10,"div",8)(11,"div",9)(12,"div",10)(13,"label",11),p(14,"i",12),o(15," Select Customer "),i(16,"span",13),o(17,"*"),r()(),i(18,"div",14),p(19,"app-searchable-select",15),i(20,"button",16),b("click",function(){return n.refreshCustomers()}),p(21,"i",17),r()(),f(22,be,2,0,"div",18),r(),i(23,"div",10)(24,"label",19),p(25,"i",20),o(26," Purchase Date "),i(27,"span",13),o(28,"*"),r()(),p(29,"input",21),f(30,Ce,2,0,"div",18),r(),i(31,"div",10)(32,"label",22),p(33,"i",23),o(34," Invoice Number "),i(35,"span",13),o(36,"*"),r()(),p(37,"input",24),f(38,ve,2,0,"div",18),r(),i(39,"div",10)(40,"label",25),p(41,"i",26),o(42," Packaging & Forwarding Charges "),i(43,"span",13),o(44,"*"),r()(),i(45,"div",27)(46,"span",28),o(47,"\u20B9"),r(),p(48,"input",29),r(),f(49,xe,2,0,"div",18),r()()(),i(50,"div",30)(51,"div",31)(52,"h3"),p(53,"i",32),o(54," Products"),r(),i(55,"button",33),b("click",function(){return n.addProduct()}),p(56,"i",34),o(57," Add Product "),r()(),i(58,"div",35)(59,"table",36)(60,"thead")(61,"tr")(62,"th"),o(63,"Product Name"),r(),i(64,"th"),o(65,"Quantity"),r(),i(66,"th"),o(67,"Batch Number"),r(),i(68,"th"),o(69,"Rate"),r(),i(70,"th"),o(71,"Subtotal"),r(),i(72,"th"),o(73,"Discount Type"),r(),i(74,"th"),o(75,"Discount %"),r(),i(76,"th"),o(77,"Discount Amount"),r(),i(78,"th"),o(79,"After Discount"),r(),i(80,"th"),o(81,"Tax Amount"),r(),i(82,"th"),o(83,"Remarks"),r(),i(84,"th"),o(85,"Actions"),r()()(),i(86,"tbody"),f(87,Ne,57,35,"tr",37),r()()()(),i(88,"button",33),b("click",function(){return n.addProduct()}),p(89,"i",34),o(90," Add Product "),r(),i(91,"div",38)(92,"div",39)(93,"span"),o(94,"Total Products:"),r(),i(95,"strong"),o(96),r()(),i(97,"div",39)(98,"span"),o(99,"Subtotal:"),r(),i(100,"strong"),o(101),E(102,"number"),r()(),f(103,De,6,4,"div",40),i(104,"div",39)(105,"span"),o(106,"Tax Amount:"),r(),i(107,"strong"),o(108),E(109,"number"),r()(),i(110,"div",39)(111,"span"),o(112,"Total After Discount & Tax:"),r(),i(113,"strong"),o(114),E(115,"number"),r()(),i(116,"div",39)(117,"span"),o(118,"Packaging & Forwarding Charges:"),r(),i(119,"strong"),o(120),E(121,"number"),r()(),i(122,"div",41)(123,"span"),o(124,"Grand Total:"),r(),i(125,"strong"),o(126),E(127,"number"),r()()(),i(128,"div",42)(129,"button",43),b("click",function(){return n.resetForm()}),p(130,"i",44),o(131," Reset "),r(),i(132,"button",45),p(133,"i",17),o(134),r()()()()(),f(135,Te,1,0,"app-loader",46)),e&2){let s;c(9),d("formGroup",n.purchaseForm),c(10),F("is-invalid",n.isFieldInvalid("customerId")),d("options",n.customers)("placeholder","Select Customer")("searchPlaceholder","Search customers..."),c(),d("disabled",n.isLoadingCustomers),c(),d("ngClass",n.isLoadingCustomers?"fa-spinner fa-spin":"fa-sync-alt"),c(),d("ngIf",n.isFieldInvalid("customerId")),c(7),F("is-invalid",n.isFieldInvalid("purchaseDate")),c(),d("ngIf",n.isFieldInvalid("purchaseDate")),c(7),F("is-invalid",n.isFieldInvalid("invoiceNumber")),c(),d("ngIf",n.isFieldInvalid("invoiceNumber")),c(10),F("is-invalid",n.isFieldInvalid("packagingAndForwadingCharges")),c(),d("ngIf",n.isFieldInvalid("packagingAndForwadingCharges")),c(38),d("ngForOf",n.productsFormArray.controls),c(9),y(n.productsFormArray.length),c(5),O("\u20B9",I(102,31,n.totalAmount,"1.2-2"),""),c(2),d("ngIf",n.totalDiscountAmount>0),c(5),O("\u20B9",I(109,34,n.totalTaxAmount,"1.2-2"),""),c(6),O("\u20B9",I(115,37,n.getTotalFinalPrice(),"1.2-2"),""),c(6),O("\u20B9",I(121,40,((s=n.purchaseForm.get("packagingAndForwadingCharges"))==null?null:s.value)||0,"1.2-2"),""),c(6),O("\u20B9",I(127,43,n.grandTotal,"1.2-2"),""),c(3),d("disabled",n.loading),c(3),d("disabled",n.purchaseForm.invalid||n.loading),c(),d("ngClass",n.loading?"fa-spinner fa-spin":"fa-save"),c(),O(" ",n.loading?"Saving...":"Save Purchase"," "),c(),d("ngIf",n.loading)}},dependencies:[ot,J,T,R,Z,ut,z,V,at,kt,L,q,dt,lt,Q,j,ct,st,Y,mt,et,nt],styles:[".add-purchase-container[_ngcontent-%COMP%]{padding:2rem;margin:0 auto}@media (max-width: 768px){.add-purchase-container[_ngcontent-%COMP%]{padding:1rem}}.select-group[_ngcontent-%COMP%]{position:relative;display:flex;align-items:center;gap:.5rem;width:100%;overflow:visible}.select-group[_ngcontent-%COMP%]   app-searchable-select[_ngcontent-%COMP%]{display:block;flex:1;position:relative;z-index:100;overflow:visible}.select-group[_ngcontent-%COMP%]   app-searchable-select.custom-width[_ngcontent-%COMP%]{position:absolute;z-index:1000;left:0}.select-group[_ngcontent-%COMP%]   app-searchable-select[_ngcontent-%COMP%]:focus-within{z-index:1000;position:relative}.select-group[_ngcontent-%COMP%]   app-searchable-select[_ngcontent-%COMP%]:focus-within     .select-dropdown{z-index:1001!important;position:absolute!important}.select-group[_ngcontent-%COMP%]   app-searchable-select[_ngcontent-%COMP%]     .select-dropdown{z-index:1001!important;position:absolute!important}.select-group[_ngcontent-%COMP%]   .refresh[_ngcontent-%COMP%]{flex-shrink:0;margin-top:0;height:40px;min-width:40px;display:flex;align-items:center;justify-content:center;position:relative;z-index:1;border:1px solid var(--supporting);border-radius:8px;background:#fff;transition:all .3s ease;color:var(--primary);touch-action:manipulation}.select-group[_ngcontent-%COMP%]   .refresh[_ngcontent-%COMP%]:hover:not(:disabled){background:var(--primary);color:#fff}.select-group[_ngcontent-%COMP%]   .refresh[_ngcontent-%COMP%]:disabled{opacity:.6;cursor:not-allowed}.select-group[_ngcontent-%COMP%]   .refresh[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{font-size:1rem}.form-control[_ngcontent-%COMP%]{height:40px}.back-btn[_ngcontent-%COMP%]{margin-bottom:1rem}.form-card[_ngcontent-%COMP%]{background:#fff;border-radius:var(--border-radius);box-shadow:var(--card-shadow);overflow:hidden}.card-header[_ngcontent-%COMP%]{background-color:var(--primary);padding:1.5rem}.card-header[_ngcontent-%COMP%]   .form-title[_ngcontent-%COMP%]{color:#fff;margin:0;font-size:1.5rem;font-weight:500;display:flex;align-items:center;gap:.5rem}.purchase-form[_ngcontent-%COMP%]{padding:2rem}@media (max-width: 768px){.purchase-form[_ngcontent-%COMP%]{padding:1rem}}.header-section[_ngcontent-%COMP%]{background-color:var(--background-light);border-radius:var(--border-radius);padding:1.5rem;margin-bottom:2rem;position:relative}.header-section[_ngcontent-%COMP%]   .form-row[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1.5rem}@media (max-width: 768px){.header-section[_ngcontent-%COMP%]   .form-row[_ngcontent-%COMP%]{grid-template-columns:1fr}}.products-section[_ngcontent-%COMP%]{background-color:#fff;border-radius:var(--border-radius);padding:1.5rem;margin-top:2rem;border:1px solid var(--primary)}.products-section[_ngcontent-%COMP%]   .products-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem}.products-section[_ngcontent-%COMP%]   .products-header[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0;color:var(--text-primary);font-size:1.25rem;display:flex;align-items:center;gap:.5rem}.products-section[_ngcontent-%COMP%]   .products-header[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{color:var(--primary)}.product-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:2fr 1fr 1fr 1fr 1fr 1fr auto;gap:1rem;align-items:start}@media (max-width: 1200px){.product-grid[_ngcontent-%COMP%]{grid-template-columns:repeat(3,1fr)}}@media (max-width: 768px){.product-grid[_ngcontent-%COMP%]{grid-template-columns:1fr}}.remove-product[_ngcontent-%COMP%]{background-color:var(--danger-light);color:var(--danger);border:none;width:36px;height:36px;border-radius:var(--border-radius);display:flex;align-items:center;justify-content:center;transition:all .3s ease}.remove-product[_ngcontent-%COMP%]:hover:not(:disabled){background-color:var(--danger);color:#fff;transform:translateY(-1px)}.remove-product[_ngcontent-%COMP%]:disabled{opacity:.5;cursor:not-allowed}@media (max-width: 768px){.remove-product[_ngcontent-%COMP%]{position:absolute;top:1rem;right:1rem}}.form-group[_ngcontent-%COMP%]{margin-bottom:1rem;position:relative}.form-group[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem;color:var(--text-primary);font-weight:500}.form-group[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{color:var(--primary)}.form-group[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]   .required[_ngcontent-%COMP%]{color:var(--danger);margin-left:4px}.input-group[_ngcontent-%COMP%]{display:flex;align-items:stretch}.input-group[_ngcontent-%COMP%]   .input-group-text[_ngcontent-%COMP%]{background-color:var(--background);border:1px solid var(--border-color);border-right:none;border-radius:var(--border-radius) 0 0 var(--border-radius);height:38px;color:var(--text-secondary);min-width:40px;display:flex;align-items:center;justify-content:center}.input-group[_ngcontent-%COMP%]   .form-control[_ngcontent-%COMP%]{border-radius:0 var(--border-radius) var(--border-radius) 0;flex:1}.purchase-summary[_ngcontent-%COMP%]{background-color:var(--background-light);border-radius:var(--border-radius);padding:1.5rem;margin-top:2rem;display:flex;justify-content:flex-end;gap:2rem;flex-wrap:wrap}.purchase-summary[_ngcontent-%COMP%]   .summary-item[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.75rem}.purchase-summary[_ngcontent-%COMP%]   .summary-item[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{color:var(--text-secondary);font-size:.875rem}.purchase-summary[_ngcontent-%COMP%]   .summary-item[_ngcontent-%COMP%]   strong[_ngcontent-%COMP%]{color:var(--text-primary);font-size:1.25rem;font-weight:600}.purchase-summary[_ngcontent-%COMP%]   .summary-item[_ngcontent-%COMP%]   strong.discount-amount[_ngcontent-%COMP%]{color:#28a745}.purchase-summary[_ngcontent-%COMP%]   .summary-item.total[_ngcontent-%COMP%]   strong[_ngcontent-%COMP%]{font-size:1.5rem;color:var(--primary)}@media (max-width: 768px){.purchase-summary[_ngcontent-%COMP%]{flex-direction:column;align-items:flex-end;gap:1rem}}.form-actions[_ngcontent-%COMP%]{display:flex;justify-content:space-between;gap:1rem;margin-top:2rem;padding-top:1.5rem;border-top:1px solid var(--border-color)}@media (max-width: 576px){.form-actions[_ngcontent-%COMP%]{flex-direction:column}.form-actions[_ngcontent-%COMP%]   .btn[_ngcontent-%COMP%]{width:100%}}.table-responsive[_ngcontent-%COMP%]{margin:0 -1.5rem;padding:0 1.5rem;overflow-x:auto;min-height:400px;-webkit-overflow-scrolling:touch}@media (max-width: 768px){.table-responsive[_ngcontent-%COMP%]{margin:0 -1rem;padding:0 1rem}}.products-table[_ngcontent-%COMP%]{width:100%;margin-bottom:0;background:#fff;border-collapse:separate;border-spacing:0}.products-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{background-color:var(--background-light);color:var(--text-primary);font-weight:600;padding:1rem;white-space:nowrap;border-bottom:2px solid var(--border-color);font-size:.875rem}.products-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]:first-child{width:20%;min-width:250px}.products-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]:nth-child(4){width:8%;max-width:100px}.products-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]:nth-child(6), .products-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]:nth-child(7), .products-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]:nth-child(8), .products-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]:nth-child(9){width:8%;min-width:100px}.products-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{padding:.75rem 1rem;vertical-align:middle;border-bottom:1px solid var(--border-color)}.products-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]   .form-control[_ngcontent-%COMP%]{min-width:80px;font-size:.875rem}.products-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]:first-child{width:20%;min-width:250px}.products-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]:first-child   .form-control[_ngcontent-%COMP%]{min-width:250px}.products-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]:nth-child(4){width:8%;max-width:100px}.products-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]:nth-child(4)   .form-control[_ngcontent-%COMP%]{min-width:80px;max-width:100px}.products-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]:nth-child(6), .products-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]:nth-child(7), .products-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]:nth-child(8), .products-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]:nth-child(9){width:8%;min-width:100px}.products-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]:nth-child(6)   .form-control[_ngcontent-%COMP%], .products-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]:nth-child(7)   .form-control[_ngcontent-%COMP%], .products-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]:nth-child(8)   .form-control[_ngcontent-%COMP%], .products-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]:nth-child(9)   .form-control[_ngcontent-%COMP%]{min-width:90px}.products-table[_ngcontent-%COMP%]   .input-group[_ngcontent-%COMP%]{flex-wrap:nowrap}.products-table[_ngcontent-%COMP%]   .btn-icon[_ngcontent-%COMP%]{margin:0 auto}@media (max-width: 768px){.products-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%], .products-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{padding:.5rem}}.form-field-container[_ngcontent-%COMP%]{position:relative;margin-bottom:1rem;overflow:visible}.form-field-container[_ngcontent-%COMP%]   .form-control.is-invalid[_ngcontent-%COMP%], .form-field-container[_ngcontent-%COMP%]   .input-group.is-invalid[_ngcontent-%COMP%]{border-color:var(--danger);background-image:url(data:image/svg+xml,...)}.products-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{padding-bottom:1.5rem;vertical-align:top}.invalid-feedback[_ngcontent-%COMP%]{color:var(--danger);font-size:.75rem;margin-top:.25rem;animation:_ngcontent-%COMP%_fadeIn .3s ease-in}@keyframes _ngcontent-%COMP%_fadeIn{0%{opacity:0;transform:translateY(-5px)}to{opacity:1;transform:translateY(0)}}.discount-type-selector[_ngcontent-%COMP%]{display:flex;gap:.5rem;align-items:center}.discount-type-selector[_ngcontent-%COMP%]   .form-check[_ngcontent-%COMP%]{margin:0;display:flex;align-items:center;gap:.25rem}.discount-type-selector[_ngcontent-%COMP%]   .form-check[_ngcontent-%COMP%]   .form-check-input[_ngcontent-%COMP%]{margin:0;cursor:pointer}.discount-type-selector[_ngcontent-%COMP%]   .form-check[_ngcontent-%COMP%]   .form-check-label[_ngcontent-%COMP%]{margin:0;cursor:pointer;font-size:.875rem;-webkit-user-select:none;user-select:none}.discount-amount-display[_ngcontent-%COMP%]{color:#28a745;font-weight:500}.discount-price-display[_ngcontent-%COMP%]{color:var(--text-primary);font-weight:500}.discount-amount[_ngcontent-%COMP%]{color:#28a745}"],changeDetection:0})}}return a})();function Re(a,h){if(a&1&&(i(0,"div",14)(1,"div",15)(2,"span"),o(3,"Invoice"),r(),i(4,"strong"),o(5),r()(),i(6,"div",15)(7,"span"),o(8,"Purchase Date"),r(),i(9,"strong"),o(10),E(11,"date"),r()(),i(12,"div",15)(13,"span"),o(14,"Total Amount"),r(),i(15,"strong"),o(16),E(17,"number"),r()()()),a&2){let t=g();c(5),y(t.purchaseDetails.invoiceNumber),c(5),y(I(11,3,t.purchaseDetails.purchaseDate,"dd-MM-yyyy")),c(6),y(I(17,6,t.purchaseDetails.totalAmount,"1.2-2"))}}function Ve(a,h){if(a&1&&(i(0,"div",39),o(1),r()),a&2){let t,e=g().$implicit;c(),O(" QC pass must be between 0 and ",(t=e.get("quantity"))==null?null:t.value," ")}}function Le(a,h){a&1&&(i(0,"span",40),p(1,"i",41),r())}function qe(a,h){if(a&1){let t=A();i(0,"tr",28)(1,"td"),o(2),r(),i(3,"td")(4,"div",29)(5,"div",30),o(6),r()()(),i(7,"td")(8,"span",31),o(9),r()(),i(10,"td")(11,"span",32),o(12),r()(),i(13,"td")(14,"div",33)(15,"input",34),b("blur",function(){let n=C(t).index,s=g(4);return v(s.onQcPassBlur(n))})("keydown",function(n){let s=C(t).index,l=g(4);return v(l.onQcPassKeydown(n,s))}),r(),f(16,Ve,2,1,"div",35),r()(),i(17,"td")(18,"div",36),o(19),r()(),i(20,"td")(21,"div",37)(22,"span",21),o(23),r(),f(24,Le,2,0,"span",38),r()()()}if(a&2){let t,e,n,s,l,u,m=h.$implicit,_=h.index,x=g(4);d("formGroupName",_),c(2),y(_+1),c(4),O(" ",((t=m.get("productName"))==null?null:t.value)||"N/A"," "),c(3),y((e=m.get("quantity"))==null?null:e.value),c(3),y(((n=m.get("batchNumber"))==null?null:n.value)||"-"),c(3),d("max",(s=m.get("quantity"))==null?null:s.value),c(),d("ngIf",x.isQcPassInvalid(_)),c(3),O(" ",((l=m.get("remarks"))==null?null:l.value)||"-"," "),c(3),F("pass",x.isItemQcPassed(m))("pending",!x.isItemQcPassed(m)),c(),O(" ",x.isItemQcPassed(m)?"Pass":"Pending"," "),c(),d("ngIf",x.savingItemId===((u=m.get("purchaseItemId"))==null?null:u.value))}}function ze(a,h){if(a&1&&(i(0,"div",24)(1,"div",25)(2,"table",26)(3,"thead")(4,"tr")(5,"th"),o(6,"No"),r(),i(7,"th"),o(8,"Product Name"),r(),i(9,"th"),o(10,"Quantity"),r(),i(11,"th"),o(12,"Batch Number"),r(),i(13,"th"),o(14,"QC Pass"),r(),i(15,"th"),o(16,"Remarks"),r(),i(17,"th"),o(18,"Status"),r()()(),i(19,"tbody"),f(20,qe,25,14,"tr",27),r()()()()),a&2){let t=g(3);c(20),d("ngForOf",t.itemsFormArray.controls)}}function Qe(a,h){a&1&&(i(0,"div",42),p(1,"i",43),i(2,"p"),o(3,"No items found for this purchase."),r()())}function je(a,h){if(a&1){let t=A();i(0,"div",17)(1,"div",18)(2,"div",19)(3,"div",20)(4,"span"),o(5,"Total Items"),r(),i(6,"strong"),o(7),r()(),i(8,"div",20)(9,"span"),o(10,"QC Status"),r(),i(11,"span",21),o(12),r()()()(),i(13,"form",22),b("ngSubmit",function(n){C(t);let s=g(2);return v(s.onFormSubmit(n))}),f(14,ze,21,1,"div",23)(15,Qe,4,0,"ng-template",null,2,W),r()()}if(a&2){let t=K(16),e=g(2);c(7),y(e.itemsFormArray.length),c(4),F("pass",e.isAllQcPassed)("pending",!e.isAllQcPassed),c(),O(" ",e.isAllQcPassed?"All Passed":"Pending"," "),c(),d("formGroup",e.qcForm),c(),d("ngIf",e.itemsFormArray.length>0)("ngIfElse",t)}}function $e(a,h){if(a&1&&(xt(0),f(1,je,17,9,"div",16),Mt()),a&2){let t=g(),e=K(17);c(),d("ngIf",t.purchaseDetails)("ngIfElse",e)}}function Be(a,h){a&1&&(i(0,"div",44),p(1,"i",41),i(2,"span"),o(3,"Loading purchase details..."),r()())}function Ue(a,h){a&1&&(i(0,"div",42),p(1,"i",45),i(2,"p"),o(3,"Purchase details not available."),r()())}var ne=(()=>{class a{constructor(t,e,n,s,l,u){this.fb=t,this.route=e,this.purchaseService=n,this.productService=s,this.snackbar=l,this.encryptionService=u,this.isLoading=!1,this.isSaving=!1,this.products=[],this.savingItemId=null,this.destroy$=new N,this.qcForm=this.fb.group({items:this.fb.array([])})}get itemsFormArray(){return this.qcForm.get("items")}ngOnInit(){let t=this.route.snapshot.paramMap.get("id");if(!t){this.snackbar.error("Invalid purchase id");return}let e=this.encryptionService.decrypt(t),n=e?Number(e):NaN;if(!n||isNaN(n)){this.snackbar.error("Invalid purchase id");return}this.loadProducts(),this.loadPurchaseDetails(n)}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete()}loadProducts(){this.productService.getProducts({status:"A"}).pipe(M(this.destroy$)).subscribe({next:t=>{t?.success&&t.data&&(this.products=t.data.content||t.data),this.mapProductNames()},error:()=>{this.snackbar.error("Failed to load products")}})}loadPurchaseDetails(t){this.isLoading=!0,this.purchaseService.getPurchaseDetails(t).pipe(M(this.destroy$)).subscribe({next:e=>{this.purchaseDetails=e;let n=e.items||[];this.buildItemsForm(n),this.isLoading=!1},error:e=>{this.snackbar.error(e?.error?.message||"Failed to load purchase details"),this.isLoading=!1}})}buildItemsForm(t){this.itemsFormArray.clear(),t.forEach(e=>{let n=this.fb.group({purchaseItemId:[e.id],productId:[e.productId],productName:[null],quantity:[e.quantity],batchNumber:[e.batchNumber],qcPass:[e.qcPass,[w.min(0),w.max(e.quantity)]],remarks:[e.remarks]});this.itemsFormArray.push(n)}),this.mapProductNames()}mapProductNames(){!this.products||this.products.length===0||this.itemsFormArray.controls.forEach(t=>{let e=t.get("productId")?.value;if(e){let n=this.products.find(s=>s.id===e);n&&t.get("productName")?.setValue(n.name,{emitEvent:!1})}})}get isAllQcPassed(){return!this.itemsFormArray||this.itemsFormArray.length===0?!1:this.itemsFormArray.controls.every(t=>{let e=Number(t.get("quantity")?.value||0),s=t.get("qcPass")?.value;if(s===null||s==="")return!1;let l=Number(s);return!isNaN(l)&&l<=e})}isItemQcPassed(t){if(!t)return!1;let e=Number(t.get("quantity")?.value||0),s=t.get("qcPass")?.value;if(s===null||s==="")return!1;let l=Number(s);return!isNaN(l)&&l<=e}isQcPassInvalid(t){let e=this.itemsFormArray.at(t).get("qcPass");return!!(e&&e.invalid&&(e.dirty||e.touched))}onQcPassBlur(t){this.updateQcPass(t)}onQcPassKeydown(t,e){t.key==="Enter"&&(t.preventDefault(),this.updateQcPass(e))}onFormSubmit(t){t.preventDefault()}updateQcPass(t){let e=this.itemsFormArray.at(t),n=e.get("purchaseItemId")?.value,s=Number(e.get("quantity")?.value||0),l=e.get("qcPass"),u=l?.value;if(!n){this.snackbar.error("purchaseItemId is required");return}if(u===null||u===""||u===void 0){if(this.savingItemId===n)return;this.isSaving=!0,this.savingItemId=n,this.purchaseService.updateQcPass({purchaseItemId:n,qcPass:null}).pipe(M(this.destroy$)).subscribe({next:_=>{_?.success?this.snackbar.success(_.message||"QC pass updated successfully"):this.snackbar.error(_?.message||"Failed to update QC pass"),this.isSaving=!1,this.savingItemId=null},error:_=>{let x=_?.error?.message||"Failed to update QC pass";this.snackbar.error(x),this.isSaving=!1,this.savingItemId=null}});return}let m=Number(u);if(isNaN(m)||m<0){this.snackbar.error("QC pass quantity cannot be negative"),l?.setValue(null);return}if(m>s){this.snackbar.error("QC pass quantity cannot exceed ordered quantity"),l?.setValue(s);return}this.savingItemId!==n&&(this.isSaving=!0,this.savingItemId=n,this.purchaseService.updateQcPass({purchaseItemId:n,qcPass:m}).pipe(M(this.destroy$)).subscribe({next:_=>{_?.success?this.snackbar.success(_.message||"QC pass updated successfully"):this.snackbar.error(_?.message||"Failed to update QC pass"),this.isSaving=!1,this.savingItemId=null},error:_=>{let x=_?.error?.message||"Failed to update QC pass";this.snackbar.error(x),this.isSaving=!1,this.savingItemId=null}}))}static{this.\u0275fac=function(e){return new(e||a)(P($),P(Et),P(G),P(gt),P(U),P(B))}}static{this.\u0275cmp=D({type:a,selectors:[["app-qc-purchase"]],decls:18,vars:8,consts:[["loadingTpl",""],["emptyPurchaseTpl",""],["noItemsTpl",""],[1,"qc-purchase-container"],["routerLink","/purchase",1,"btn","btn-sm","btn-secondary","back-btn"],[1,"fas","fa-arrow-left"],[1,"form-card"],[1,"card-header"],[1,"header-main"],[1,"form-title"],[1,"fas","fa-clipboard-check"],[1,"status-chip","header-status"],["class","purchase-meta",4,"ngIf"],[4,"ngIf","ngIfElse"],[1,"purchase-meta"],[1,"meta-item"],["class","qc-content",4,"ngIf","ngIfElse"],[1,"qc-content"],[1,"qc-summary"],[1,"summary-row"],[1,"summary-item"],[1,"status-chip"],["novalidate","",1,"qc-form",3,"ngSubmit","formGroup"],["class","products-section","formArrayName","items",4,"ngIf","ngIfElse"],["formArrayName","items",1,"products-section"],[1,"table-responsive"],[1,"table","products-table"],[3,"formGroupName",4,"ngFor","ngForOf"],[3,"formGroupName"],[1,"product-cell"],[1,"product-name"],[1,"quantity"],[1,"batch"],[1,"form-field-container"],["type","number","formControlName","qcPass","min","0","step","0.01","inputmode","decimal",1,"form-control",3,"blur","keydown","max"],["class","invalid-feedback",4,"ngIf"],[1,"remarks-cell"],[1,"status-cell"],["class","saving-indicator",4,"ngIf"],[1,"invalid-feedback"],[1,"saving-indicator"],[1,"fas","fa-spinner","fa-spin"],[1,"empty-state"],[1,"fas","fa-box-open"],[1,"loading-state"],[1,"fas","fa-file-invoice"]],template:function(e,n){if(e&1&&(i(0,"div",3)(1,"button",4),p(2,"i",5),o(3," Back to Purchases "),r(),i(4,"div",6)(5,"div",7)(6,"div",8)(7,"h2",9),p(8,"i",10),o(9," Purchase QC "),r(),i(10,"span",11),o(11),r()(),f(12,Re,18,9,"div",12),r(),f(13,$e,2,2,"ng-container",13),r()(),f(14,Be,4,0,"ng-template",null,0,W)(16,Ue,4,0,"ng-template",null,1,W)),e&2){let s=K(15);c(10),F("pass",n.isAllQcPassed)("pending",!n.isAllQcPassed),c(),O(" ",n.isAllQcPassed?"All Passed":"Pending"," "),c(),d("ngIf",n.purchaseDetails),c(),d("ngIf",!n.isLoading)("ngIfElse",s)}},dependencies:[T,R,z,V,at,L,q,dt,lt,Q,j,ct,st,mt,Z,X],styles:[".qc-purchase-container[_ngcontent-%COMP%]{padding:2rem;margin:0 auto}@media (max-width: 768px){.qc-purchase-container[_ngcontent-%COMP%]{padding:1rem}}.back-btn[_ngcontent-%COMP%]{margin-bottom:1rem}.form-card[_ngcontent-%COMP%]{background:#fff;border-radius:var(--border-radius);box-shadow:var(--card-shadow);overflow:hidden}.card-header[_ngcontent-%COMP%]{background-color:var(--primary);padding:1.5rem;display:flex;flex-direction:column;gap:.75rem}.card-header[_ngcontent-%COMP%]   .header-main[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:space-between;gap:1rem}.card-header[_ngcontent-%COMP%]   .form-title[_ngcontent-%COMP%]{color:#fff;margin:0;font-size:1.5rem;font-weight:500;display:flex;align-items:center;gap:.5rem}.card-header[_ngcontent-%COMP%]   .form-title[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{color:#fff}.card-header[_ngcontent-%COMP%]   .purchase-meta[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap;gap:1.5rem}.card-header[_ngcontent-%COMP%]   .purchase-meta[_ngcontent-%COMP%]   .meta-item[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.25rem}.card-header[_ngcontent-%COMP%]   .purchase-meta[_ngcontent-%COMP%]   .meta-item[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{color:#fffc;font-size:.85rem}.card-header[_ngcontent-%COMP%]   .purchase-meta[_ngcontent-%COMP%]   .meta-item[_ngcontent-%COMP%]   strong[_ngcontent-%COMP%]{color:#fff;font-size:1rem}.qc-content[_ngcontent-%COMP%]{padding:1.5rem 2rem 2rem}@media (max-width: 768px){.qc-content[_ngcontent-%COMP%]{padding:1rem}}.qc-summary[_ngcontent-%COMP%]{background-color:var(--background-light);border-radius:var(--border-radius);padding:1rem 1.5rem;margin-bottom:1.5rem}.qc-summary[_ngcontent-%COMP%]   .summary-row[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap;gap:1.5rem;align-items:center}.qc-summary[_ngcontent-%COMP%]   .summary-row[_ngcontent-%COMP%]   .summary-item[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.75rem}.qc-summary[_ngcontent-%COMP%]   .summary-row[_ngcontent-%COMP%]   .summary-item[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]:first-child{color:var(--text-secondary);font-size:.9rem}.qc-summary[_ngcontent-%COMP%]   .summary-row[_ngcontent-%COMP%]   .summary-item[_ngcontent-%COMP%]   strong[_ngcontent-%COMP%]{color:var(--text-primary);font-size:1.1rem;font-weight:600}.status-chip[_ngcontent-%COMP%]{display:inline-flex;align-items:center;justify-content:center;padding:.25rem .75rem;border-radius:999px;font-size:.8rem;font-weight:600;letter-spacing:.02em;text-transform:uppercase}.status-chip.header-status[_ngcontent-%COMP%]{background-color:#ffffff26;color:#fff}.status-chip.pass[_ngcontent-%COMP%]{background-color:#28a74526;color:#28a745}.status-chip.pending[_ngcontent-%COMP%]{background-color:#ffc10726;color:#ffc107}.qc-form[_ngcontent-%COMP%]{width:100%}.products-section[_ngcontent-%COMP%]{background-color:#fff;border-radius:var(--border-radius);padding:1.5rem 1.5rem 1rem;border:1px solid var(--primary)}.table-responsive[_ngcontent-%COMP%]{margin:0 -1.5rem;padding:0 1.5rem;overflow-x:auto;min-height:300px;-webkit-overflow-scrolling:touch}@media (max-width: 768px){.table-responsive[_ngcontent-%COMP%]{margin:0 -1rem;padding:0 1rem}}.products-table[_ngcontent-%COMP%]{width:100%;margin-bottom:0;background:#fff;border-collapse:separate;border-spacing:0}.products-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{background-color:var(--background-light);color:var(--text-primary);font-weight:600;padding:.75rem 1rem;white-space:nowrap;border-bottom:2px solid var(--border-color)}.products-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{padding:.75rem 1rem;vertical-align:middle;border-bottom:1px solid var(--border-color)}.products-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]:first-child{white-space:nowrap;width:1%}@media (max-width: 768px){.products-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%], .products-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{padding:.5rem}}.product-cell[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.15rem}.product-cell[_ngcontent-%COMP%]   .product-name[_ngcontent-%COMP%]{font-weight:500;color:var(--text-primary)}.product-cell[_ngcontent-%COMP%]   .product-id[_ngcontent-%COMP%]{font-size:.75rem;color:var(--text-secondary)}.quantity[_ngcontent-%COMP%], .batch[_ngcontent-%COMP%]{font-weight:500;color:var(--text-primary)}.remarks-cell[_ngcontent-%COMP%]{max-width:220px;font-size:.9rem;color:var(--text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.form-field-container[_ngcontent-%COMP%]{position:relative}.form-field-container[_ngcontent-%COMP%]   .form-control[_ngcontent-%COMP%]{height:40px;min-width:120px}.form-field-container[_ngcontent-%COMP%]   .invalid-feedback[_ngcontent-%COMP%]{color:var(--danger);font-size:.75rem;margin-top:.25rem}.status-cell[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem}.status-cell[_ngcontent-%COMP%]   .saving-indicator[_ngcontent-%COMP%]{color:var(--primary);font-size:.9rem}.loading-state[_ngcontent-%COMP%], .empty-state[_ngcontent-%COMP%]{padding:2rem;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:.75rem;color:var(--text-secondary);text-align:center}.loading-state[_ngcontent-%COMP%]   i[_ngcontent-%COMP%], .empty-state[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{font-size:2rem;color:var(--primary)}@media (max-width: 576px){.card-header[_ngcontent-%COMP%]{padding:1.25rem}.card-header[_ngcontent-%COMP%]   .header-main[_ngcontent-%COMP%]{flex-direction:column;align-items:flex-start;gap:.5rem}.products-section[_ngcontent-%COMP%]{padding:1rem 1rem .75rem}.form-field-container[_ngcontent-%COMP%]   .form-control[_ngcontent-%COMP%]{min-width:100px}}"]})}}return a})();function Ge(a,h){if(a&1&&(i(0,"div",13)(1,"div",14)(2,"span"),o(3,"Invoice"),r(),i(4,"strong"),o(5),r()(),i(6,"div",14)(7,"span"),o(8,"Purchase Date"),r(),i(9,"strong"),o(10),E(11,"date"),r()(),i(12,"div",14)(13,"span"),o(14,"Customer"),r(),i(15,"strong"),o(16),r()()()),a&2){let t=g();c(5),y(t.purchaseDetails.invoiceNumber),c(5),y(I(11,3,t.purchaseDetails.purchaseDate,"dd-MM-yyyy")),c(6),y(t.purchaseDetails.customerName)}}function Ye(a,h){a&1&&(i(0,"div",42),o(1," Packaging and forwarding charges is required and must be 0 or greater "),r())}function Ke(a,h){a&1&&(i(0,"div",30),p(1,"input",64),r())}function We(a,h){a&1&&(i(0,"div",30)(1,"span",65),o(2,"-"),r()())}function He(a,h){a&1&&(i(0,"div",30),p(1,"input",66),r())}function Je(a,h){if(a&1&&(i(0,"div",30)(1,"span",31),o(2,"\u20B9"),r(),i(3,"div",67),o(4),r()()),a&2){let t=g().index,e=g(4);c(4),y(e.getFormattedDiscountAmount(t))}}function Xe(a,h){if(a&1&&(i(0,"div",42),o(1),r()),a&2){let t=g().$implicit,e=g(4);c(),O(" Return quantity must be between 0 and ",e.getMaxReturnQuantity(t)," ")}}function Ze(a,h){a&1&&(i(0,"div",42),o(1," Return not allowed: available return quantity is 0 "),r())}function tn(a,h){if(a&1){let t=A();i(0,"tr",47)(1,"td"),o(2),r(),i(3,"td")(4,"div",48)(5,"div",49),o(6),r()()(),i(7,"td")(8,"span",50),o(9),r()(),i(10,"td")(11,"span",51),o(12),r()(),i(13,"td")(14,"span",50),o(15),r()(),i(16,"td")(17,"div",52)(18,"div",30),p(19,"input",53),r()()(),i(20,"td")(21,"div",30),p(22,"input",54),r()(),i(23,"td")(24,"div",52)(25,"div",55)(26,"div",56)(27,"input",57),b("change",function(){let n=C(t).index,s=g(4);return v(s.onDiscountTypeChange(n))}),r(),i(28,"label",58),o(29,"%"),r()(),i(30,"div",56)(31,"input",57),b("change",function(){let n=C(t).index,s=g(4);return v(s.onDiscountTypeChange(n))}),r(),i(32,"label",58),o(33,"\u20B9"),r()()()()(),i(34,"td")(35,"div",52),f(36,Ke,2,0,"div",59)(37,We,3,0,"div",59),r()(),i(38,"td")(39,"div",52),f(40,He,2,0,"div",59)(41,Je,5,1,"div",59),r()(),i(42,"td")(43,"div",30),p(44,"input",60),r()(),i(45,"td")(46,"div",30),p(47,"input",61),r()(),i(48,"td")(49,"div",52),p(50,"input",62),f(51,Xe,2,1,"div",33)(52,Ze,2,0,"div",33),r()(),i(53,"td")(54,"div",52),p(55,"input",63),r()()()}if(a&2){let t,e,n,s,l,u,m,_,x=h.$implicit,S=h.index,k=g(4);d("formGroupName",S),c(2),y(S+1),c(4),O(" ",((t=x.get("productName"))==null?null:t.value)||"N/A"," "),c(3),y((e=x.get("quantity"))==null?null:e.value),c(3),y(((n=x.get("batchNumber"))==null?null:n.value)||"-"),c(3),y((s=(s=x.get("qcPass"))==null?null:s.value)!==null&&s!==void 0?s:0),c(7),d("value",k.getFormattedPrice(S)),c(5),d("value","percentage")("id","discountTypePercentage"+S),c(),d("for","discountTypePercentage"+S),c(3),d("value","amount")("id","discountTypeAmount"+S),c(),d("for","discountTypeAmount"+S),c(4),d("ngIf",((l=k.itemsFormArray.at(S).get("discountType"))==null?null:l.value)==="percentage"),c(),d("ngIf",((u=k.itemsFormArray.at(S).get("discountType"))==null?null:u.value)!=="percentage"),c(3),d("ngIf",((m=k.itemsFormArray.at(S).get("discountType"))==null?null:m.value)==="amount"),c(),d("ngIf",((_=k.itemsFormArray.at(S).get("discountType"))==null?null:_.value)!=="amount"),c(3),d("value",k.getFormattedDiscountPrice(S)),c(3),d("value",k.getFormattedTaxAmount(S)),c(3),d("max",k.getMaxReturnQuantity(x))("disabled",k.getMaxReturnQuantity(x)<=0),c(),d("ngIf",k.isReturnQuantityInvalid(S)),c(),d("ngIf",k.getMaxReturnQuantity(x)<=0)}}function en(a,h){if(a&1&&(i(0,"div",43)(1,"div",44)(2,"table",45)(3,"thead")(4,"tr")(5,"th"),o(6,"No"),r(),i(7,"th"),o(8,"Product Name"),r(),i(9,"th"),o(10,"Quantity"),r(),i(11,"th"),o(12,"Batch Number"),r(),i(13,"th"),o(14,"QC Pass"),r(),i(15,"th"),o(16,"Unit Price"),r(),i(17,"th"),o(18,"Subtotal"),r(),i(19,"th"),o(20,"Discount Type"),r(),i(21,"th"),o(22,"Discount %"),r(),i(23,"th"),o(24,"Discount Amount"),r(),i(25,"th"),o(26,"After Discount"),r(),i(27,"th"),o(28,"Tax Amount"),r(),i(29,"th"),o(30,"Purchase Return Quantity"),r(),i(31,"th"),o(32,"Remarks"),r()()(),i(33,"tbody"),f(34,tn,56,23,"tr",46),r()()()()),a&2){let t=g(3);c(34),d("ngForOf",t.itemsFormArray.controls)}}function nn(a,h){a&1&&(i(0,"div",68),p(1,"i",69),i(2,"p"),o(3,"No items found for this purchase."),r()())}function rn(a,h){if(a&1&&(i(0,"div",36)(1,"span"),o(2,"Total Discount:"),r(),i(3,"strong",70),o(4),E(5,"number"),r()()),a&2){let t=g(3);c(4),O("-\u20B9",I(5,1,t.getTotalDiscountAmount(),"1.2-2"),"")}}function on(a,h){if(a&1){let t=A();i(0,"div",16)(1,"form",17),b("ngSubmit",function(){C(t);let n=g(2);return v(n.onSubmit())}),i(2,"div",18)(3,"div",19)(4,"div",20)(5,"label",21),p(6,"i",22),o(7," Purchase Return Date "),r(),p(8,"input",23),r(),i(9,"div",20)(10,"label",24),p(11,"i",25),o(12," Return Invoice Number "),r(),p(13,"input",26),r(),i(14,"div",20)(15,"label",27),p(16,"i",28),o(17," Packaging & Forwarding Charges "),i(18,"span",29),o(19,"*"),r()(),i(20,"div",30)(21,"span",31),o(22,"\u20B9"),r(),p(23,"input",32),r(),f(24,Ye,2,0,"div",33),r()()(),f(25,en,35,1,"div",34)(26,nn,4,0,"ng-template",null,2,W),i(28,"div",35)(29,"div",36)(30,"span"),o(31,"Total Return Quantity"),r(),i(32,"strong"),o(33),E(34,"number"),r()(),i(35,"div",36)(36,"span"),o(37,"Subtotal:"),r(),i(38,"strong"),o(39),E(40,"number"),r()(),f(41,rn,6,4,"div",37),i(42,"div",36)(43,"span"),o(44,"Tax Amount:"),r(),i(45,"strong"),o(46),E(47,"number"),r()(),i(48,"div",36)(49,"span"),o(50,"Total After Discount & Tax:"),r(),i(51,"strong"),o(52),E(53,"number"),r()(),i(54,"div",36)(55,"span"),o(56,"Packaging & Forwarding Charges:"),r(),i(57,"strong"),o(58),E(59,"number"),r()(),i(60,"div",38)(61,"span"),o(62,"Grand Total:"),r(),i(63,"strong"),o(64),E(65,"number"),r()()(),i(66,"div",39)(67,"button",40),p(68,"i",41),o(69),r()()()()}if(a&2){let t,e,n,s=K(27),l=g(2);c(),d("formGroup",l.returnForm),c(22),F("is-invalid",((t=l.returnForm.get("packagingAndForwadingCharges"))==null?null:t.invalid)&&((t=l.returnForm.get("packagingAndForwadingCharges"))==null?null:t.touched)),c(),d("ngIf",((e=l.returnForm.get("packagingAndForwadingCharges"))==null?null:e.invalid)&&((e=l.returnForm.get("packagingAndForwadingCharges"))==null?null:e.touched)),c(),d("ngIf",l.itemsFormArray.length>0)("ngIfElse",s),c(8),y(I(34,16,l.getTotalReturnQuantity(),"1.2-2")),c(6),O("\u20B9",I(40,19,l.getTotalAmount(),"1.2-2"),""),c(2),d("ngIf",l.getTotalDiscountAmount()>0),c(5),O("\u20B9",I(47,22,l.getTotalTaxAmount(),"1.2-2"),""),c(6),O("\u20B9",I(53,25,l.getTotalFinalPrice(),"1.2-2"),""),c(6),O("\u20B9",I(59,28,((n=l.returnForm.get("packagingAndForwadingCharges"))==null?null:n.value)||0,"1.2-2"),""),c(6),O("\u20B9",I(65,31,l.getGrandTotal(),"1.2-2"),""),c(3),d("disabled",l.returnForm.invalid||l.isSaving),c(),d("ngClass",l.isSaving?"fa-spinner fa-spin":"fa-save"),c(),O(" ",l.isSaving?"Saving...":"Save Purchase Return"," ")}}function an(a,h){if(a&1&&(xt(0),f(1,on,70,34,"div",15),Mt()),a&2){let t=g(),e=K(15);c(),d("ngIf",t.purchaseDetails)("ngIfElse",e)}}function cn(a,h){a&1&&(i(0,"div",71),p(1,"i",72),i(2,"span"),o(3,"Loading purchase details..."),r()())}function sn(a,h){a&1&&(i(0,"div",68),p(1,"i",25),i(2,"p"),o(3,"Purchase details not available."),r()())}var re=(()=>{class a{constructor(t,e,n,s,l,u,m){this.fb=t,this.route=e,this.router=n,this.purchaseService=s,this.productService=l,this.snackbar=u,this.encryptionService=m,this.isLoading=!1,this.isSaving=!1,this.products=[],this.destroy$=new N,this.productMap=new Map,this.returnForm=this.fb.group({purchaseId:[null],customerId:[null],purchaseReturnDate:[H(new Date,"yyyy-MM-dd","en"),w.required],invoiceNumber:[""],packagingAndForwadingCharges:[0,[w.required,w.min(0)]],items:this.fb.array([])})}get itemsFormArray(){return this.returnForm.get("items")}ngOnInit(){let t=this.route.snapshot.paramMap.get("id");if(!t){this.snackbar.error("Invalid purchase id");return}let e=this.encryptionService.decrypt(t),n=e?Number(e):NaN;if(!n||isNaN(n)){this.snackbar.error("Invalid purchase id");return}this.itemsFormArray.valueChanges.pipe(M(this.destroy$),ft(150)).subscribe(()=>this.recalculateAllItemPrices()),this.loadProducts(),this.loadPurchaseDetails(n)}onDiscountTypeChange(t){let e=this.itemsFormArray.at(t);e.get("discountType")?.value==="percentage"?e.patchValue({discountAmount:0},{emitEvent:!1}):e.patchValue({discountPercentage:0},{emitEvent:!1}),this.calculateItemPrice(e)}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete(),this.products=[],this.purchaseDetails=null,this.productMap.clear(),this.returnForm&&this.returnForm.reset()}loadProducts(){this.productService.getProducts({status:"A"}).pipe(M(this.destroy$)).subscribe({next:t=>{t?.success&&t.data&&(this.products=t.data.content||t.data),this.buildProductMap(),this.mapProductNames()},error:()=>{this.snackbar.error("Failed to load products")}})}buildProductMap(){this.productMap.clear();for(let t of this.products)t?.id!=null&&this.productMap.set(t.id,t)}getMaxReturnQuantity(t){let e=Number(t.get("quantity")?.value||0),n=Number(t.get("qcPass")?.value||0),s=e-n;return isNaN(s)||s<0?0:s}loadPurchaseDetails(t){this.isLoading=!0,this.purchaseService.getPurchaseDetails(t,!0).pipe(M(this.destroy$)).subscribe({next:e=>{this.purchaseDetails=e,this.returnForm.patchValue({purchaseId:e.id,customerId:e.customerId,invoiceNumber:e.invoiceNumber?`PR-${e.invoiceNumber}`:"",isPurchaseReturn:!0,packagingAndForwadingCharges:e.packagingAndForwadingCharges||0});let n=e.items||[];this.buildItemsForm(n),e.purchaseReturns&&this.applyExistingPurchaseReturns(e.purchaseReturns),this.isLoading=!1},error:e=>{this.snackbar.error(e?.error?.message||"Failed to load purchase details"),this.isLoading=!1}})}buildItemsForm(t){this.itemsFormArray.clear(),t.forEach(e=>{let n=Number(e.quantity||0),s=Number(e.qcPass||0),l=Math.max(0,n-s),u=this.fb.group({purchaseItemId:[e.id],productId:[e.productId],productName:[null],quantity:[n],batchNumber:[e.batchNumber],qcPass:[s],unitPrice:[e.unitPrice],returnQuantity:[{value:null,disabled:l<=0},[w.min(0),w.max(l)]],remarks:[null],discountType:["percentage"],discountPercentage:[0,[w.min(0),w.max(100)]],discountAmount:[0,[w.min(0)]],discountPrice:[{value:0,disabled:!0}],taxPercentage:[{value:0,disabled:!0}],taxAmount:[{value:0,disabled:!0}],price:[{value:0,disabled:!0}]});this.itemsFormArray.push(u)}),this.mapProductNames()}applyExistingPurchaseReturns(t){if(!t)return;if(t.purchaseReturnDate){let n=H(t.purchaseReturnDate,"yyyy-MM-dd","en");this.returnForm.get("purchaseReturnDate")?.setValue(n)}t.invoiceNumber&&this.returnForm.get("invoiceNumber")?.setValue(t.invoiceNumber),t.packagingAndForwadingCharges!=null&&this.returnForm.get("packagingAndForwadingCharges")?.setValue(t.packagingAndForwadingCharges);let e=new Map;(t.items||[]).forEach(n=>{n&&n.purchaseItemId!=null&&e.set(n.purchaseItemId,n)}),this.itemsFormArray.controls.forEach(n=>{let s=n.get("purchaseItemId")?.value;if(!s)return;let l=e.get(s);if(!l)return;l.quantity!=null&&n.get("returnQuantity")?.setValue(l.quantity,{emitEvent:!1}),l.unitPrice!=null&&n.get("unitPrice")?.setValue(l.unitPrice,{emitEvent:!1}),l.remarks!=null&&n.get("remarks")?.setValue(l.remarks,{emitEvent:!1});let u=l.discountPercentage??0,m=l.discountAmount??0,_=u>0?"percentage":m>0?"amount":"percentage";n.patchValue({discountType:_,discountPercentage:u,discountAmount:m,discountPrice:l.discountPrice??0,taxPercentage:l.taxPercentage??n.get("taxPercentage")?.value??0,taxAmount:l.taxAmount??0},{emitEvent:!1})}),this.recalculateAllItemPrices()}mapProductNames(){if(!this.products||this.products.length===0){this.recalculateAllItemPrices();return}this.itemsFormArray.controls.forEach(t=>{let e=t.get("productId")?.value;if(e){let n=this.productMap.get(e);if(n){t.get("productName")?.setValue(n.name,{emitEvent:!1}),!t.get("unitPrice")?.value&&n.unitPrice!=null&&t.get("unitPrice")?.setValue(n.unitPrice,{emitEvent:!1});let s=n.taxPercentage??0;t.get("taxPercentage")?.setValue(s,{emitEvent:!1})}}}),this.recalculateAllItemPrices()}calculateItemPrice(t){if(!t)return;let e=Number(t.get("returnQuantity")?.value||0),n=Number(t.get("unitPrice")?.value||0),s=Number(t.get("taxPercentage")?.value||0),l=t.get("discountType")?.value||"percentage",u=Number(t.get("discountPercentage")?.value||0),m=Number(t.get("discountAmount")?.value||0),_=Number((n*e).toFixed(2)),x=0;if(l==="percentage"&&u>0){let it=Math.min(u,100);x=Number((_*(it/100)).toFixed(2)),u>100&&t.patchValue({discountPercentage:100},{emitEvent:!1})}else l==="amount"&&m>0&&(x=Math.min(m,_),m>_&&t.patchValue({discountAmount:_},{emitEvent:!1}));let S=Number((_-x).toFixed(2)),k=Number((S*s/100).toFixed(2));t.patchValue({price:_,discountAmount:x,discountPrice:S,taxAmount:k},{emitEvent:!1})}recalculateAllItemPrices(){this.itemsFormArray.controls.forEach(t=>this.calculateItemPrice(t))}isReturnQuantityInvalid(t){let e=this.itemsFormArray.at(t).get("returnQuantity");return!e||e.disabled?!1:!!e.invalid}getTotalReturnQuantity(){return this.itemsFormArray.controls.reduce((t,e)=>{let n=e.get("returnQuantity");if(!n||n.disabled)return t;let s=Number(n.value||0);return t+(isNaN(s)?0:s)},0)}getTotalAmount(){return this.itemsFormArray.controls.reduce((t,e)=>t+(Number(e.get("price")?.value)||0),0)}getTotalDiscountAmount(){return this.itemsFormArray.controls.reduce((t,e)=>t+(Number(e.get("discountAmount")?.value)||0),0)}getTotalTaxAmount(){return this.itemsFormArray.controls.reduce((t,e)=>t+(Number(e.get("taxAmount")?.value)||0),0)}getTotalFinalPrice(){return this.itemsFormArray.controls.reduce((t,e)=>{let n=e,s=Number(n.get("discountPrice")?.value)||Number(n.get("price")?.value)||0,l=Number(n.get("taxAmount")?.value)||0;return t+s+l},0)}getGrandTotal(){let t=Number(this.returnForm.get("packagingAndForwadingCharges")?.value||0);return this.getTotalFinalPrice()+t}getFormattedPrice(t){let e=this.itemsFormArray.at(t)?.get("price")?.value;return e!=null?Number(e).toFixed(2):"0.00"}getFormattedDiscountAmount(t){let e=this.itemsFormArray.at(t)?.get("discountAmount")?.value;return e!=null?Number(e).toFixed(2):"0.00"}getFormattedDiscountPrice(t){let e=this.itemsFormArray.at(t),n=e?.get("discountPrice")?.value,s=e?.get("price")?.value;return n!=null?Number(n).toFixed(2):s!=null?Number(s).toFixed(2):"0.00"}getFormattedTaxAmount(t){let e=this.itemsFormArray.at(t)?.get("taxAmount")?.value;return e!=null?Number(e).toFixed(2):"0.00"}onSubmit(){if(!this.purchaseDetails){this.snackbar.error("Purchase details not loaded");return}if(this.returnForm.invalid){this.returnForm.markAllAsTouched();return}let t=this.returnForm.getRawValue(),e=(t.items||[]).filter(l=>{let u=Number(l.returnQuantity||0);return!isNaN(u)&&u>0}).map(l=>{let u=Number(l.unitPrice||0)*Number(l.returnQuantity||0),m=l.discountType||"percentage",_=Number(l.discountAmount||0),x=m==="percentage"?Number(l.discountPercentage||0):0,S=Number(l.discountPrice)||u-_,k=Number(l.taxAmount||0),it=S+k;return{purchaseItemId:l.purchaseItemId,productId:l.productId,quantity:Number(l.returnQuantity),unitPrice:Number(l.unitPrice||0),price:u,discountPercentage:x,discountAmount:_,taxPercentage:Number(l.taxPercentage||0),taxAmount:k,sgst:0,cgst:0,igst:0,finalPrice:it,remarks:l.remarks??void 0,batchNumber:l.batchNumber||void 0}});if(!e.length){this.snackbar.error("Please enter at least one return quantity greater than 0");return}let s={id:this.purchaseDetails?.purchaseReturns?.id??null,purchaseId:t.purchaseId,customerId:t.customerId,purchaseReturnDate:H(t.purchaseReturnDate,"dd-MM-yyyy","en"),invoiceNumber:t.invoiceNumber,packagingAndForwadingCharges:Number(t.packagingAndForwadingCharges||0),price:this.getTotalAmount(),discountAmount:this.getTotalDiscountAmount(),taxAmount:this.getTotalTaxAmount(),totalAmount:this.getGrandTotal(),products:e};this.isSaving=!0,this.purchaseService.createPurchaseReturn(s).pipe(M(this.destroy$)).subscribe({next:l=>{l?.success?(this.snackbar.success(l.message||"Purchase return created successfully"),this.router.navigate(["purchase/return"])):this.snackbar.error(l?.message||"Failed to create purchase return"),this.isSaving=!1},error:l=>{let u=l?.error?.message||"Failed to create purchase return";this.snackbar.error(u),this.isSaving=!1}})}static{this.\u0275fac=function(e){return new(e||a)(P($),P(Et),P(tt),P(G),P(gt),P(U),P(B))}}static{this.\u0275cmp=D({type:a,selectors:[["app-add-purchase-return"]],decls:16,vars:3,consts:[["loadingTpl",""],["emptyPurchaseTpl",""],["noItemsTpl",""],[1,"add-purchase-container"],["routerLink","/purchase",1,"btn","btn-sm","btn-secondary","back-btn"],[1,"fas","fa-arrow-left"],[1,"form-card"],[1,"card-header"],[1,"header-main"],[1,"form-title"],[1,"fas","fa-undo-alt"],["class","purchase-meta",4,"ngIf"],[4,"ngIf","ngIfElse"],[1,"purchase-meta"],[1,"meta-item"],["class","qc-content",4,"ngIf","ngIfElse"],[1,"qc-content"],["novalidate","",1,"purchase-form",3,"ngSubmit","formGroup"],[1,"header-section"],[1,"form-row"],[1,"form-group"],["for","purchaseReturnDate"],[1,"fas","fa-calendar"],["type","date","id","purchaseReturnDate","formControlName","purchaseReturnDate",1,"form-control"],["for","invoiceNumber"],[1,"fas","fa-file-invoice"],["type","text","id","invoiceNumber","formControlName","invoiceNumber","placeholder","Enter return invoice number","readonly","",1,"form-control"],["for","packagingAndForwadingCharges"],[1,"fas","fa-box"],[1,"required"],[1,"input-group"],[1,"input-group-text"],["type","number","id","packagingAndForwadingCharges","formControlName","packagingAndForwadingCharges","min","0","step","0.01","placeholder","Enter packaging and forwarding charges",1,"form-control"],["class","invalid-feedback",4,"ngIf"],["class","products-section","formArrayName","items",4,"ngIf","ngIfElse"],[1,"purchase-summary"],[1,"summary-item"],["class","summary-item",4,"ngIf"],[1,"summary-item","total"],[1,"form-actions"],["type","submit",1,"btn","btn-sm","btn-primary",3,"disabled"],[1,"fas",3,"ngClass"],[1,"invalid-feedback"],["formArrayName","items",1,"products-section"],[1,"table-responsive"],[1,"table","products-table"],[3,"formGroupName",4,"ngFor","ngForOf"],[3,"formGroupName"],[1,"product-cell"],[1,"product-name"],[1,"quantity"],[1,"batch"],[1,"form-field-container"],["type","number","formControlName","unitPrice","readonly","","min","0","step","0.01","placeholder","0",1,"form-control"],["type","number","formControlName","price","readonly","","title","Subtotal (before discount)",1,"form-control",3,"value"],[1,"discount-type-selector"],[1,"form-check","form-check-inline"],["type","radio","formControlName","discountType",1,"form-check-input",3,"change","value","id"],[1,"form-check-label",3,"for"],["class","input-group",4,"ngIf"],["type","number","formControlName","discountPrice","readonly","","title","Price after discount",1,"form-control","discount-price-display",3,"value"],["type","number","formControlName","taxAmount","readonly","","title","Tax calculated on discounted price",1,"form-control",3,"value"],["type","number","formControlName","returnQuantity","min","0","step","0.01","inputmode","decimal",1,"form-control",3,"max","disabled"],["type","text","formControlName","remarks","placeholder","Remarks",1,"form-control"],["type","number","formControlName","discountPercentage","placeholder","0.00","min","0","max","100","step","0.01",1,"form-control"],[1,"form-control",2,"background-color","#f8f9fa","color","#6c757d"],["type","number","formControlName","discountAmount","placeholder","0.00","min","0","step","0.01",1,"form-control"],["title","Calculated from discount % (read-only)",1,"form-control","discount-amount-display",2,"background-color","#e9ecef","cursor","default","display","flex","align-items","center"],[1,"empty-state"],[1,"fas","fa-box-open"],[1,"discount-amount"],[1,"loading-state"],[1,"fas","fa-spinner","fa-spin"]],template:function(e,n){if(e&1&&(i(0,"div",3)(1,"button",4),p(2,"i",5),o(3," Back to Purchases "),r(),i(4,"div",6)(5,"div",7)(6,"div",8)(7,"h2",9),p(8,"i",10),o(9," Purchase Return "),r(),f(10,Ge,17,6,"div",11),r()(),f(11,an,2,2,"ng-container",12),r()(),f(12,cn,4,0,"ng-template",null,0,W)(14,sn,4,0,"ng-template",null,1,W)),e&2){let s=K(13);c(10),d("ngIf",n.purchaseDetails),c(),d("ngIf",!n.isLoading)("ngIfElse",s)}},dependencies:[J,T,R,z,V,at,kt,L,q,dt,lt,Q,j,ct,st,mt,Z,X],styles:[".add-purchase-container[_ngcontent-%COMP%]{padding:1.5rem 2rem}.back-btn[_ngcontent-%COMP%]{margin-bottom:.75rem}.form-card[_ngcontent-%COMP%]{background:#fff;border-radius:var(--border-radius);box-shadow:var(--card-shadow);overflow:hidden}.card-header[_ngcontent-%COMP%]{background-color:var(--primary);padding:1rem 1.5rem}.card-header[_ngcontent-%COMP%]   .header-main[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:space-between;gap:1rem}.card-header[_ngcontent-%COMP%]   .form-title[_ngcontent-%COMP%]{margin:0;color:#fff;font-size:1.5rem;font-weight:500;display:flex;align-items:center;gap:.5rem}.card-header[_ngcontent-%COMP%]   .form-title[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{color:#fff}.card-header[_ngcontent-%COMP%]   .purchase-meta[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap;gap:1.5rem}.card-header[_ngcontent-%COMP%]   .purchase-meta[_ngcontent-%COMP%]   .meta-item[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.15rem}.card-header[_ngcontent-%COMP%]   .purchase-meta[_ngcontent-%COMP%]   .meta-item[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{font-size:.8rem;color:#ffffffd9}.card-header[_ngcontent-%COMP%]   .purchase-meta[_ngcontent-%COMP%]   .meta-item[_ngcontent-%COMP%]   strong[_ngcontent-%COMP%]{color:#fff;font-size:.98rem}.purchase-form[_ngcontent-%COMP%]{padding:1.5rem 1.5rem 2rem}.header-section[_ngcontent-%COMP%]{background-color:var(--background-light);border-radius:var(--border-radius);padding:1rem 1.25rem;margin-bottom:1.25rem}.header-section[_ngcontent-%COMP%]   .form-row[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1.25rem}.form-group[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{display:inline-flex;align-items:center;gap:.4rem;margin-bottom:.4rem;font-weight:500;color:var(--text-primary)}.form-group[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{color:var(--primary)}.products-section[_ngcontent-%COMP%]{border-radius:var(--border-radius);border:1px solid var(--border-color);padding:1rem .75rem .5rem;background-color:#fff}.table-responsive[_ngcontent-%COMP%]{overflow-x:auto;-webkit-overflow-scrolling:touch}.products-table[_ngcontent-%COMP%]{width:100%;border-collapse:collapse}.products-table[_ngcontent-%COMP%]   thead[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{background-color:var(--background-light);color:#000;padding:.6rem .75rem;font-weight:600;font-size:.9rem;white-space:nowrap}.products-table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{padding:.5rem .75rem;vertical-align:middle;border-top:1px solid var(--border-color)}.product-cell[_ngcontent-%COMP%]   .product-name[_ngcontent-%COMP%]{font-weight:500;color:var(--text-primary)}.quantity[_ngcontent-%COMP%], .batch[_ngcontent-%COMP%]{color:var(--text-primary)}.form-field-container[_ngcontent-%COMP%]   .form-control[_ngcontent-%COMP%]{height:34px}.form-field-container[_ngcontent-%COMP%]   .invalid-feedback[_ngcontent-%COMP%]{margin-top:.15rem;font-size:.75rem;color:var(--danger)}.purchase-summary[_ngcontent-%COMP%]{margin-top:1rem;padding:1rem 1.25rem;background-color:var(--background-light);border-radius:var(--border-radius);display:flex;justify-content:flex-end;gap:1.5rem;flex-wrap:wrap}.purchase-summary[_ngcontent-%COMP%]   .summary-item[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem}.purchase-summary[_ngcontent-%COMP%]   .summary-item[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{font-size:.85rem;color:var(--text-secondary)}.purchase-summary[_ngcontent-%COMP%]   .summary-item[_ngcontent-%COMP%]   strong[_ngcontent-%COMP%]{font-size:1rem;font-weight:600;color:var(--text-primary)}.purchase-summary[_ngcontent-%COMP%]   .summary-item[_ngcontent-%COMP%]   strong.discount-amount[_ngcontent-%COMP%]{color:#28a745}.purchase-summary[_ngcontent-%COMP%]   .summary-item.total[_ngcontent-%COMP%]   strong[_ngcontent-%COMP%]{font-size:1.25rem;color:var(--primary)}.discount-type-selector[_ngcontent-%COMP%]{display:flex;gap:.5rem;align-items:center}.discount-type-selector[_ngcontent-%COMP%]   .form-check[_ngcontent-%COMP%]{margin:0;display:flex;align-items:center;gap:.25rem}.discount-type-selector[_ngcontent-%COMP%]   .form-check[_ngcontent-%COMP%]   .form-check-input[_ngcontent-%COMP%]{margin:0;cursor:pointer}.discount-type-selector[_ngcontent-%COMP%]   .form-check[_ngcontent-%COMP%]   .form-check-label[_ngcontent-%COMP%]{margin:0;cursor:pointer;font-size:.875rem;-webkit-user-select:none;user-select:none}.discount-amount-display[_ngcontent-%COMP%]{color:#28a745;font-weight:500}.discount-price-display[_ngcontent-%COMP%]{color:var(--text-primary);font-weight:500}.form-actions[_ngcontent-%COMP%]{margin-top:.75rem;display:flex;justify-content:flex-start}.form-actions[_ngcontent-%COMP%]   .btn[_ngcontent-%COMP%]{min-width:180px;display:inline-flex;align-items:center;justify-content:center;gap:.4rem}.loading-state[_ngcontent-%COMP%], .empty-state[_ngcontent-%COMP%]{padding:2rem 1rem;text-align:center;color:var(--text-secondary)}.loading-state[_ngcontent-%COMP%]   i[_ngcontent-%COMP%], .empty-state[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{font-size:1.8rem;color:var(--primary);margin-bottom:.5rem}@media (max-width: 768px){.add-purchase-container[_ngcontent-%COMP%]{padding:1rem}.card-header[_ngcontent-%COMP%]   .header-main[_ngcontent-%COMP%]{flex-direction:column;align-items:flex-start}.form-actions[_ngcontent-%COMP%]   .btn[_ngcontent-%COMP%]{width:100%}}"]})}}return a})();var ln=()=>({label:"All Customers",value:""});function dn(a,h){if(a&1){let t=A();i(0,"div",6)(1,"div",30),p(2,"app-searchable-select",31),i(3,"button",32),b("click",function(){C(t);let n=g();return v(n.refreshCustomers())}),p(4,"i",33),r()()()}if(a&2){let t=g();c(2),d("options",t.customers)("defaultOption",Ot(5,ln))("searchPlaceholder","Search customers..."),c(),d("disabled",t.isLoadingCustomers),c(),d("ngClass",t.isLoadingCustomers?"fa-spinner fa-spin":"fa-sync-alt")}}function un(a,h){if(a&1){let t=A();i(0,"button",34),b("click",function(){C(t);let n=g();return v(n.exportExcel())}),p(1,"i",35),o(2," Export "),r()}if(a&2){let t=g();d("disabled",t.isExportButtonDisabled())}}function mn(a,h){a&1&&(i(0,"th",26),o(1,"Actions"),r())}function pn(a,h){if(a&1&&(i(0,"span",46),o(1),E(2,"number"),r()),a&2){let t=g().$implicit;c(),O("-\u20B9",I(2,1,t.discountAmount,"1.2-2"),"")}}function gn(a,h){a&1&&(i(0,"span"),o(1,"-"),r())}function hn(a,h){if(a&1){let t=A();i(0,"td",47)(1,"button",48),b("click",function(){C(t);let n=g().$implicit,s=g();return v(s.generatePdf(n.id,n.invoiceNumber))})("touchstart",function(n){return C(t),v(n.stopPropagation())}),p(2,"i",49),r(),i(3,"button",50),b("click",function(){C(t);let n=g().$implicit,s=g();return v(s.viewDetails(n.purchaseId))})("touchstart",function(n){return C(t),v(n.stopPropagation())}),p(4,"i",51),r(),i(5,"button",52),b("click",function(){C(t);let n=g().$implicit,s=g();return v(s.deletePurchaseReturn(n.id))})("touchstart",function(n){return C(t),v(n.stopPropagation())}),p(6,"i",53),r()()}}function _n(a,h){if(a&1&&(i(0,"tr",36)(1,"td",37),o(2),r(),i(3,"td",38)(4,"strong"),o(5),r()(),i(6,"td",39),o(7),r(),i(8,"td",40),o(9),E(10,"date"),r(),i(11,"td",41),f(12,pn,3,4,"span",42)(13,gn,2,0,"span",43),r(),i(14,"td",44)(15,"strong"),o(16),r()(),f(17,hn,7,0,"td",45),r()),a&2){let t=h.$implicit,e=h.index,n=g();c(2),y(n.startIndex+e+1),c(3),y(t.invoiceNumber),c(2),y(t.customerName),c(2),y(I(10,8,t.purchaseReturnDate,"dd-MM-yyyy")),c(3),d("ngIf",t.discountAmount&&t.discountAmount>0),c(),d("ngIf",!t.discountAmount||t.discountAmount===0),c(3),y(t.totalPurchaseAmount),c(),d("ngIf",n.canManagePurchases)}}function fn(a,h){if(a&1){let t=A();i(0,"app-pagination",54),b("pageChange",function(n){C(t);let s=g();return v(s.onPageChange(n))})("pageSizeChange",function(n){C(t);let s=g();return v(s.onPageSizeChange(n))}),r()}if(a&2){let t=g();d("currentPage",t.currentPage)("pageSize",t.pageSize)("totalElements",t.totalElements)("pageSizeOptions",t.pageSizeOptions)}}var ie=(()=>{class a{constructor(t,e,n,s,l,u,m,_){this.purchaseService=t,this.customerService=e,this.fb=n,this.snackbar=s,this.dateUtils=l,this.encryptionService=u,this.router=m,this.authService=_,this.purchaseReturns=[],this.isLoading=!1,this.currentPage=0,this.pageSize=10,this.pageSizeOptions=[5,10,25,50,100],this.totalPages=0,this.totalElements=0,this.startIndex=0,this.endIndex=0,this.customers=[],this.isLoadingCustomers=!1,this.canManagePurchases=!1,this.clientId=1,this.destroy$=new N,this.initializeForm()}ngOnInit(){this.canManagePurchases=this.authService.isAdmin()||this.authService.isStaffAdmin(),this.loadPurchaseReturns(),this.canManagePurchases&&this.loadCustomers()}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete()}initializeForm(){this.searchForm=this.fb.group({search:[""],batchNumber:[""],customerId:[""],startDate:[""],endDate:[""]})}loadPurchaseReturns(){this.isLoading=!0;let t=this.searchForm.value,e={currentPage:this.currentPage,perPageRecord:this.pageSize,clientId:this.clientId,search:t.search?.trim()||void 0,customerId:this.canManagePurchases&&t.customerId?Number(t.customerId):void 0,startDate:t.startDate?this.dateUtils.formatDate(t.startDate):void 0,endDate:t.endDate?this.dateUtils.formatDate(t.endDate):void 0};Object.keys(e).forEach(n=>{e[n]===void 0&&delete e[n]}),this.purchaseService.searchPurchaseReturn(e).pipe(M(this.destroy$)).subscribe({next:n=>{this.purchaseReturns=n.content||[],this.totalPages=n.totalPages||0,this.totalElements=n.totalElements||0,this.updatePaginationIndexes(),this.isLoading=!1},error:n=>{this.snackbar.error(n?.error?.message||"Failed to load purchase returns"),this.isLoading=!1}})}updatePaginationIndexes(){this.startIndex=this.currentPage*this.pageSize,this.endIndex=Math.min((this.currentPage+1)*this.pageSize,this.totalElements)}onSearch(t){t&&(t.preventDefault(),t.stopPropagation()),this.currentPage=0,this.loadPurchaseReturns()}resetForm(){this.searchForm.reset(),this.currentPage=0,this.loadPurchaseReturns()}onPageChange(t){this.currentPage=t,this.loadPurchaseReturns()}onPageSizeChange(t){this.pageSize=t,this.currentPage=0,this.loadPurchaseReturns()}loadCustomers(){this.canManagePurchases&&(this.isLoadingCustomers=!0,this.customerService.getCustomers({status:"A"}).pipe(M(this.destroy$)).subscribe({next:t=>{t?.success&&t.data&&(this.customers=t.data),this.isLoadingCustomers=!1},error:()=>{this.snackbar.error("Failed to load customers"),this.isLoadingCustomers=!1}}))}refreshCustomers(){this.canManagePurchases&&(this.isLoadingCustomers=!0,this.customerService.refreshCustomers().pipe(M(this.destroy$)).subscribe({next:t=>{t?.success&&t.data&&(this.customers=t.data,this.snackbar.success("Customers refreshed successfully")),this.isLoadingCustomers=!1},error:()=>{this.snackbar.error("Failed to refresh customers"),this.isLoadingCustomers=!1}}))}viewDetails(t){let e=this.encryptionService.encrypt(t.toString());this.router.navigate(["/purchase/return",e])}deletePurchaseReturn(t){confirm("Are you sure you want to delete this purchase return? This action cannot be undone.")&&(this.isLoading=!0,this.purchaseService.deletePurchaseReturn(t).pipe(M(this.destroy$)).subscribe({next:e=>{e?.success?(this.snackbar.success(e.message||"Purchase return deleted successfully"),this.loadPurchaseReturns()):(this.snackbar.error(e?.message||"Failed to delete purchase return"),this.isLoading=!1)},error:e=>{this.snackbar.error(e?.error?.message||"Failed to delete purchase return"),this.isLoading=!1}}))}generatePdf(t,e){this.purchaseService.generatePurchaseReturnPdf(t).pipe(M(this.destroy$)).subscribe({next:({blob:n,filename:s})=>{let l="purchase-return-"+(e?`${e}.pdf`:s),u=window.URL.createObjectURL(n),m=document.createElement("a");m.href=u,m.download=l,document.body.appendChild(m),m.click(),document.body.removeChild(m),window.URL.revokeObjectURL(u),this.snackbar.success("PDF downloaded successfully")},error:n=>{this.snackbar.error(n?.error?.message||"Failed to generate PDF")}})}isExportButtonDisabled(){let t=this.searchForm.get("startDate")?.value,e=this.searchForm.get("endDate")?.value;return!t||!e}exportExcel(){let t=this.searchForm.get("startDate")?.value,e=this.searchForm.get("endDate")?.value;if(!t||!e){this.snackbar.error("Please select both start date and end date to export");return}let n=this.dateUtils.formatDateDDMMYYYY(t),s=this.dateUtils.formatDateDDMMYYYY(e);this.isLoading=!0,this.purchaseService.exportPurchaseReturnExcel({startDate:n,endDate:s}).pipe(M(this.destroy$)).subscribe({next:({blob:l,filename:u})=>{let m=window.URL.createObjectURL(l),_=document.createElement("a");_.href=m,_.download=u||`purchase_return_export_${n}_${s}.xlsx`,document.body.appendChild(_),_.click(),document.body.removeChild(_),window.URL.revokeObjectURL(m),this.snackbar.success("Excel file downloaded successfully"),this.isLoading=!1},error:l=>{this.snackbar.error(l?.error?.message||"Failed to export Excel file"),this.isLoading=!1}})}static{this.\u0275fac=function(e){return new(e||a)(P(G),P(ht),P($),P(U),P(At),P(B),P(tt),P(It))}}static{this.\u0275cmp=D({type:a,selectors:[["app-purchase-return-list"]],decls:54,vars:7,consts:[[1,"purchase-container"],[3,"show"],["aria-labelledby","search-purchase-returns-heading",1,"search-section","card"],["id","search-purchase-returns-heading"],["role","search","aria-label","Purchase return search form",3,"ngSubmit","formGroup"],[1,"search-controls"],[1,"form-group"],["for","invoice-search",1,"sr-only"],["id","invoice-search","type","text","formControlName","search","placeholder","Search by invoice number...","aria-label","Search by invoice number",1,"form-control"],["for","batch-search",1,"sr-only"],["id","batch-search","type","text","formControlName","batchNumber","placeholder","Search by Batch Number...","aria-label","Search by batch number",1,"form-control"],["class","form-group",4,"ngIf"],["for","start-date",1,"sr-only"],["id","start-date","type","date","formControlName","startDate","placeholder","Start Date","aria-label","Start date",1,"form-control",3,"touchstart"],["for","end-date",1,"sr-only"],["id","end-date","type","date","formControlName","endDate","placeholder","End Date","aria-label","End date",1,"form-control",3,"touchstart"],[1,"button-group"],["type","submit",1,"search-btn","btn","btn-sm","btn-primary"],[1,"fas","fa-search"],["type","button",1,"search-btn","btn","btn-sm","btn-secondary",3,"click"],[1,"fas","fa-undo"],["type","button","class","search-btn btn btn-sm btn-success export-btn","title","Export purchase returns to Excel",3,"disabled","click",4,"ngIf"],["aria-labelledby","purchase-returns-heading",1,"purchases-list","card"],["id","purchase-returns-heading"],[1,"table-responsive"],["role","table","aria-label","Purchase returns list",1,"table"],["scope","col"],["scope","col",4,"ngIf"],["role","row",4,"ngFor","ngForOf"],[3,"currentPage","pageSize","totalElements","pageSizeOptions","pageChange","pageSizeChange",4,"ngIf"],[1,"product-select-group"],["formControlName","customerId","labelKey","name","valueKey","id",3,"options","defaultOption","searchPlaceholder"],["type","button","title","Refresh Customers",1,"btn","btn-sm","btn-primary","refresh",2,"margin-top","3px",3,"click","disabled"],[1,"fas",3,"ngClass"],["type","button","title","Export purchase returns to Excel",1,"search-btn","btn","btn-sm","btn-success","export-btn",3,"click","disabled"],[1,"fas","fa-file-excel"],["role","row"],["data-label","No"],["data-label","Invoice No."],["data-label","Customer Name"],["data-label","Purchase Return Date"],["data-label","Discount"],["class","discount-amount",4,"ngIf"],[4,"ngIf"],["data-label","Total Amount"],["class","actions","data-label","Actions",4,"ngIf"],[1,"discount-amount"],["data-label","Actions",1,"actions"],["aria-label","Export purchase return as PDF",1,"btn-icon","pdf",3,"click","touchstart"],["aria-hidden","true",1,"fas","fa-file-pdf"],["aria-label","View purchase return details",1,"btn-icon","edit",3,"click","touchstart"],["aria-hidden","true",1,"fas","fa-eye"],["aria-label","Delete purchase return",1,"btn-icon","delete",3,"click","touchstart"],["aria-hidden","true",1,"fas","fa-trash"],[3,"pageChange","pageSizeChange","currentPage","pageSize","totalElements","pageSizeOptions"]],template:function(e,n){e&1&&(i(0,"div",0),p(1,"app-loader",1),i(2,"section",2)(3,"h2",3),o(4,"Search Purchase Returns"),r(),i(5,"form",4),b("ngSubmit",function(l){return n.onSearch(l)}),i(6,"div",5)(7,"div",6)(8,"label",7),o(9,"Search by invoice number"),r(),p(10,"input",8),i(11,"label",9),o(12,"Search by batch number"),r(),p(13,"input",10),r(),f(14,dn,5,6,"div",11),i(15,"div",6)(16,"label",12),o(17,"Start date"),r(),i(18,"input",13),b("touchstart",function(l){return l.stopPropagation()}),r()(),i(19,"div",6)(20,"label",14),o(21,"End date"),r(),i(22,"input",15),b("touchstart",function(l){return l.stopPropagation()}),r()(),i(23,"div",16)(24,"button",17),p(25,"i",18),o(26," Search "),r(),i(27,"button",19),b("click",function(){return n.resetForm()}),p(28,"i",20),o(29," Reset "),r(),f(30,un,3,1,"button",21),r()()()(),i(31,"section",22)(32,"h2",23),o(33,"Purchase Returns"),r(),i(34,"div",24)(35,"table",25)(36,"thead")(37,"tr")(38,"th",26),o(39,"No"),r(),i(40,"th",26),o(41,"Invoice No."),r(),i(42,"th",26),o(43,"Customer Name"),r(),i(44,"th",26),o(45,"Purchase Return Date"),r(),i(46,"th",26),o(47,"Discount"),r(),i(48,"th",26),o(49,"Total Amount"),r(),f(50,mn,2,0,"th",27),r()(),i(51,"tbody"),f(52,_n,18,11,"tr",28),r()()(),f(53,fn,1,4,"app-pagination",29),r()()),e&2&&(c(),d("show",n.isLoading),c(4),d("formGroup",n.searchForm),c(9),d("ngIf",n.canManagePurchases),c(16),d("ngIf",n.canManagePurchases),c(20),d("ngIf",n.canManagePurchases),c(2),d("ngForOf",n.purchaseReturns),c(),d("ngIf",n.totalPages>0))},dependencies:[J,T,R,z,V,L,q,Q,j,et,nt,pt,Z,X],styles:[".purchase-container[_ngcontent-%COMP%]{padding:2rem;position:relative;min-height:200px;background-color:var(--background)}.purchase-container[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]{background:#fff;border-radius:0;box-shadow:0 2px 4px #0000001a;margin-bottom:20px;padding:20px}.purchase-container[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{margin-bottom:20px;color:var(--text-primary);font-size:1.5rem;font-weight:600}.purchase-container[_ngcontent-%COMP%]   .sr-only[_ngcontent-%COMP%]{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border-width:0}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;align-items:flex-start}@media (max-width: 768px){.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]{grid-template-columns:1fr}}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]{margin:0}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]   .form-control[_ngcontent-%COMP%]{height:40px}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]   .product-select-group[_ngcontent-%COMP%]{display:flex;gap:.5rem}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]   .product-select-group[_ngcontent-%COMP%]   app-searchable-select[_ngcontent-%COMP%]{flex:1}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]   .product-select-group[_ngcontent-%COMP%]   .btn-icon[_ngcontent-%COMP%]{width:42px;padding:0;display:flex;align-items:center;justify-content:center;border:1px solid var(--border-color);border-radius:var(--border-radius);background:var(--primary)}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]   .product-select-group[_ngcontent-%COMP%]   .btn-icon[_ngcontent-%COMP%]:hover:not(:disabled){background:var(--primary)}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]   .product-select-group[_ngcontent-%COMP%]   .btn-icon[_ngcontent-%COMP%]:disabled{opacity:.6;cursor:not-allowed}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]{display:flex;gap:.5rem;flex-wrap:wrap}@media (max-width: 768px){.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]{grid-column:1/-1}}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{flex:1;min-width:120px;height:42px;display:flex;align-items:center;justify-content:center;gap:.5rem;transition:all .2s ease;touch-action:manipulation;-webkit-tap-highlight-color:transparent;cursor:pointer}@media (max-width: 576px){.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{min-width:100%;flex:1 1 100%}}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{font-size:1rem}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]   button.export-btn[_ngcontent-%COMP%]{background-color:#28a745;color:#fff;border:1px solid #28a745;font-weight:500}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]   button.export-btn[_ngcontent-%COMP%]:hover:not(:disabled){background-color:#218838;border-color:#1e7e34;transform:translateY(-1px);box-shadow:0 2px 4px #28a7454d}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]   button.export-btn[_ngcontent-%COMP%]:active:not(:disabled), .purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]   button.export-btn[_ngcontent-%COMP%]:focus:not(:disabled){outline:2px solid rgba(40,167,69,.5);outline-offset:2px;transform:translateY(0)}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]   button.export-btn[_ngcontent-%COMP%]:disabled{background-color:#6c757d;border-color:#6c757d;opacity:.6;cursor:not-allowed;transform:none}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]   button.export-btn[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{color:#fff}.purchase-container[_ngcontent-%COMP%]   .purchases-list[_ngcontent-%COMP%]   .table-responsive[_ngcontent-%COMP%]{overflow-x:auto;-webkit-overflow-scrolling:touch}.purchase-container[_ngcontent-%COMP%]   .purchases-list[_ngcontent-%COMP%]   .table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{white-space:nowrap;font-weight:600}.purchase-container[_ngcontent-%COMP%]   .purchases-list[_ngcontent-%COMP%]   .table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{vertical-align:middle}.purchase-container[_ngcontent-%COMP%]   .purchases-list[_ngcontent-%COMP%]   .table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]   .discount-amount[_ngcontent-%COMP%]{color:#28a745;font-weight:500}@media (max-width: 768px){.purchase-container[_ngcontent-%COMP%]   .purchases-list[_ngcontent-%COMP%]   .table[_ngcontent-%COMP%]   thead[_ngcontent-%COMP%]{display:none}.purchase-container[_ngcontent-%COMP%]   .purchases-list[_ngcontent-%COMP%]   .table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]{display:block;margin-bottom:1rem;border:1px solid #dee2e6;border-radius:4px;padding:.5rem}.purchase-container[_ngcontent-%COMP%]   .purchases-list[_ngcontent-%COMP%]   .table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;padding:.5rem;border:none;border-bottom:1px solid #f0f0f0}.purchase-container[_ngcontent-%COMP%]   .purchases-list[_ngcontent-%COMP%]   .table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]:before{content:attr(data-label);font-weight:600;color:var(--text-primary)}.purchase-container[_ngcontent-%COMP%]   .purchases-list[_ngcontent-%COMP%]   .table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]:last-child{border-bottom:none}.purchase-container[_ngcontent-%COMP%]   .purchases-list[_ngcontent-%COMP%]   .table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   td.actions[_ngcontent-%COMP%]{justify-content:flex-start;flex-wrap:wrap;gap:.5rem}.purchase-container[_ngcontent-%COMP%]   .purchases-list[_ngcontent-%COMP%]   .table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   td.actions[_ngcontent-%COMP%]:before{display:none}}.purchase-container[_ngcontent-%COMP%]   .table-controls[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}.purchase-container[_ngcontent-%COMP%]   .table-controls[_ngcontent-%COMP%]   .page-size-selector[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem}.purchase-container[_ngcontent-%COMP%]   .table-controls[_ngcontent-%COMP%]   .page-size-selector[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{color:var(--text-secondary);white-space:nowrap}.purchase-container[_ngcontent-%COMP%]   .table-controls[_ngcontent-%COMP%]   .page-size-selector[_ngcontent-%COMP%]   select.form-control[_ngcontent-%COMP%]{width:auto;min-width:80px;padding:.5rem;margin-bottom:0}@media (max-width: 768px){.purchase-container[_ngcontent-%COMP%]{padding:1rem}.purchase-container[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]{flex-direction:column;gap:1rem}.purchase-container[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]{width:100%}.purchase-container[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]   input[type=date][_ngcontent-%COMP%]{touch-action:manipulation;-webkit-appearance:none}.purchase-container[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{width:100%}.purchase-container[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]{padding:1rem}}@media (max-width: 576px){.purchase-container[_ngcontent-%COMP%]{padding:.75rem}.purchase-container[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{font-size:1.25rem}}@media (max-width: 576px){.table-controls[_ngcontent-%COMP%]{flex-direction:column;gap:1rem;align-items:flex-start}.table-controls[_ngcontent-%COMP%]   .page-size-selector[_ngcontent-%COMP%]{width:100%}.table-controls[_ngcontent-%COMP%]   .page-size-selector[_ngcontent-%COMP%]   select.form-control[_ngcontent-%COMP%]{flex:1}}.actions[_ngcontent-%COMP%]{display:flex;gap:.5rem;justify-content:flex-start;flex-wrap:wrap}.actions[_ngcontent-%COMP%]   .btn-icon[_ngcontent-%COMP%]{background:none;border:none;padding:8px;cursor:pointer;border-radius:6px;transition:all .2s ease;display:flex;align-items:center;justify-content:center;touch-action:manipulation;-webkit-tap-highlight-color:transparent;min-width:36px;min-height:36px}.actions[_ngcontent-%COMP%]   .btn-icon.edit[_ngcontent-%COMP%]{color:var(--primary);background-color:#1458811a}.actions[_ngcontent-%COMP%]   .btn-icon.edit[_ngcontent-%COMP%]:hover:not(:disabled){background-color:var(--primary);color:#fff;transform:translateY(-1px)}.actions[_ngcontent-%COMP%]   .btn-icon.edit[_ngcontent-%COMP%]:disabled{color:var(--text-secondary);background-color:#0000000d;cursor:not-allowed}.actions[_ngcontent-%COMP%]   .btn-icon.return[_ngcontent-%COMP%]{color:#ff9800;background-color:#ff98001a}.actions[_ngcontent-%COMP%]   .btn-icon.return[_ngcontent-%COMP%]:hover:not(:disabled){background-color:#ff9800;color:#fff;transform:translateY(-1px)}.actions[_ngcontent-%COMP%]   .btn-icon.return[_ngcontent-%COMP%]:disabled{color:var(--text-secondary);background-color:#0000000d;cursor:not-allowed}.actions[_ngcontent-%COMP%]   .btn-icon.sale[_ngcontent-%COMP%]{color:var(--primary);background-color:#fd78231a}.actions[_ngcontent-%COMP%]   .btn-icon.sale[_ngcontent-%COMP%]:hover:not(:disabled){background-color:var(--primary);color:#fff;transform:translateY(-1px)}.actions[_ngcontent-%COMP%]   .btn-icon.sale[_ngcontent-%COMP%]:disabled{color:var(--text-secondary);background-color:#0000000d;cursor:not-allowed}.actions[_ngcontent-%COMP%]   .btn-icon.pdf[_ngcontent-%COMP%]{color:#dc3545;background-color:#dc35451a}.actions[_ngcontent-%COMP%]   .btn-icon.pdf[_ngcontent-%COMP%]:hover:not(:disabled){background-color:#dc3545;color:#fff;transform:translateY(-1px)}.actions[_ngcontent-%COMP%]   .btn-icon.pdf[_ngcontent-%COMP%]:disabled{color:var(--text-secondary);background-color:#0000000d;cursor:not-allowed}.actions[_ngcontent-%COMP%]   .btn-icon.delete[_ngcontent-%COMP%]{color:#dc3545;background-color:#dc35451a}.actions[_ngcontent-%COMP%]   .btn-icon.delete[_ngcontent-%COMP%]:hover{background-color:#dc3545;color:#fff;transform:translateY(-1px)}.actions[_ngcontent-%COMP%]   .btn-icon[_ngcontent-%COMP%]:active{transform:translateY(0)}.actions[_ngcontent-%COMP%]   .btn-icon[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{font-size:16px}@media (max-width: 768px){.actions[_ngcontent-%COMP%]   .btn-icon[_ngcontent-%COMP%]{padding:6px}.actions[_ngcontent-%COMP%]   .btn-icon[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{font-size:14px}}  .custom-snackbar.success{background-color:var(--accent2)}  .custom-snackbar.error{background-color:#dc3545}  .custom-snackbar .snackbar-message{display:flex;align-items:center;gap:.5rem;color:#fff}  .custom-snackbar .snackbar-message i{font-size:1.2rem}.loading-overlay[_ngcontent-%COMP%]{position:absolute;inset:0;background:#fffc;display:flex;justify-content:center;align-items:center;z-index:1000}.loading-overlay[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{font-size:2rem;color:var(--primary)}.product-select-group[_ngcontent-%COMP%]{display:flex;gap:.5rem;align-items:flex-start}.product-select-group[_ngcontent-%COMP%]   app-searchable-select[_ngcontent-%COMP%]{flex:1}.product-select-group[_ngcontent-%COMP%]   .btn-icon.refresh[_ngcontent-%COMP%]{background-color:var(--background);color:#fff;margin-top:3px;width:42px;height:42px;border-radius:6px;transition:all .2s ease}.product-select-group[_ngcontent-%COMP%]   .btn-icon.refresh[_ngcontent-%COMP%]:hover:not(:disabled){background-color:var(--primary);color:#fff;transform:translateY(-1px)}.product-select-group[_ngcontent-%COMP%]   .btn-icon.refresh[_ngcontent-%COMP%]:disabled{opacity:.7;cursor:not-allowed}.product-select-group[_ngcontent-%COMP%]   .btn-icon.refresh[_ngcontent-%COMP%]:active{transform:translateY(0)}"]})}}return a})();var Pn=[{path:"",component:te},{path:"create",component:Lt},{path:"edit/:id",component:Lt},{path:"qc/:id",component:ne},{path:"return/:id",component:re},{path:"return",component:ie}],oe=(()=>{class a{static{this.\u0275fac=function(e){return new(e||a)}}static{this.\u0275mod=vt({type:a})}static{this.\u0275inj=Ct({imports:[Y.forChild(Pn),Y]})}}return a})();var Sr=(()=>{class a{static{this.\u0275fac=function(e){return new(e||a)}}static{this.\u0275mod=vt({type:a})}static{this.\u0275inj=Ct({imports:[ot,ut,Y,oe,et,nt,pt]})}}return a})();export{Sr as PurchaseModule};
