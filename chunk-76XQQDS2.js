import"./chunk-R6Y7KK6I.js";import{b as Ge,c as Be,d as Ye}from"./chunk-TAMVUGMA.js";import{a as Ue}from"./chunk-CEMGVQA6.js";import{a as ue,b as ye}from"./chunk-IYGBZKDQ.js";import{b as Oe,c as le,d as de}from"./chunk-DMFBC6S4.js";import{$ as qe,$a as ve,$b as Q,A as Le,Bb as L,C as A,Cb as re,D as he,Da as Pe,Ea as be,Fb as q,Gb as ie,H as b,Hb as oe,I as C,Ia as k,Ib as z,Ka as I,La as Y,Mb as xe,Na as Ce,Nb as ae,Pb as je,Qa as K,Qb as j,Ra as H,Rb as Qe,S as s,Sa as N,Sb as ce,T as f,Ta as D,Tb as Me,Va as W,Vb as J,Wa as te,Wb as se,Ya as ne,Zb as G,_,_b as Ae,a as De,aa as d,ca as w,e as Re,f as F,fa as i,ga as r,ha as u,ia as fe,j as pe,ja as _e,ka as y,na as P,o as Fe,oa as p,q as Te,ta as B,u as x,ua as o,ub as R,uc as $,va as M,vb as O,vc as X,wa as S,wb as T,wc as $e,x as Ve,xb as V,xc as Z,y as ge,yb as ze}from"./chunk-3WKA5TJN.js";var U=(()=>{class a{constructor(e){this.http=e,this.apiUrl=`${Ae.apiUrl}/api/purchases`,this.purchaseReturnApiUrl=`${Ae.apiUrl}/api/purchase-returns`}searchPurchases(e){return this.http.post(`${this.apiUrl}/searchPurchase`,e)}createPurchase(e){return this.http.post(`${this.apiUrl}/create`,e)}updatePurchase(e){return this.http.post(`${this.apiUrl}/create`,e)}deletePurchase(e){return this.http.delete(`${this.apiUrl}/${e}`)}getPurchaseDetails(e,t=!1){return this.http.post(`${this.apiUrl}/detail`,{id:e,isPurchaseReturn:t})}updateQcPass(e){return this.http.post(`${this.apiUrl}/update-qc-pass`,e)}createPurchaseReturn(e){return this.http.post(`${this.purchaseReturnApiUrl}/create`,e)}getPurchaseReturnDetail(e){return this.http.post(`${this.purchaseReturnApiUrl}/detail`,{id:e})}searchPurchaseReturn(e){return this.http.post(`${this.purchaseReturnApiUrl}/searchPurchaseReturn`,e)}deletePurchaseReturn(e){return this.http.post(`${this.purchaseReturnApiUrl}/delete`,{id:e})}generatePdf(e){return this.http.post(`${this.apiUrl}/generate-pdf`,{id:e},{responseType:"blob",observe:"response"}).pipe(pe(t=>{let c=t.headers.get("Content-Disposition")?.split("filename=")[1]?.replace(/"/g,"")||"purchase.pdf";return{blob:new Blob([t.body],{type:"application/pdf"}),filename:c}}))}generatePurchaseReturnPdf(e){return this.http.post(`${this.purchaseReturnApiUrl}/generate-pdf`,{id:e},{responseType:"blob",observe:"response"}).pipe(pe(t=>{let c=t.headers.get("Content-Disposition")?.split("filename=")[1]?.replace(/"/g,"")||"purchase-return.pdf";return{blob:new Blob([t.body],{type:"application/pdf"}),filename:c}}))}exportExcel(e){return this.http.post(`${this.apiUrl}/export-excel`,e,{responseType:"blob",observe:"response"}).pipe(pe(t=>{let c=t.headers.get("Content-Disposition")?.split("filename=")[1]?.replace(/"/g,"")||`purchase_export_${e.startDate}_${e.endDate}.xlsx`;return{blob:new Blob([t.body],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),filename:c}}))}exportPurchaseReturnExcel(e){return this.http.post(`${this.purchaseReturnApiUrl}/export-excel`,e,{responseType:"blob",observe:"response"}).pipe(pe(t=>{let c=t.headers.get("Content-Disposition")?.split("filename=")[1]?.replace(/"/g,"")||`purchase_return_export_${e.startDate}_${e.endDate}.xlsx`;return{blob:new Blob([t.body],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),filename:c}}))}static{this.\u0275fac=function(t){return new(t||a)(Le(ve))}}static{this.\u0275prov=Ve({token:a,factory:a.\u0275fac,providedIn:"root"})}}return a})();var ct=()=>({label:"All Customers",value:""});function st(a,m){if(a&1){let e=y();i(0,"div",6)(1,"div",32),u(2,"app-searchable-select",33),i(3,"button",34),P("click",function(){b(e);let n=p();return C(n.refreshCustomers())}),u(4,"i",35),r()()()}if(a&2){let e=p();s(2),d("options",e.customers)("defaultOption",be(5,ct))("searchPlaceholder","Search customers..."),s(),d("disabled",e.isLoadingCustomers),s(),d("ngClass",e.isLoadingCustomers?"fa-spinner fa-spin":"fa-sync-alt")}}function lt(a,m){if(a&1){let e=y();i(0,"button",36),P("click",function(){b(e);let n=p();return C(n.exportExcel())}),u(1,"i",37),o(2," Export "),r()}if(a&2){let e=p();d("disabled",e.isExportButtonDisabled())}}function dt(a,m){if(a&1){let e=y();i(0,"div",38)(1,"button",39),P("click",function(){b(e);let n=p();return C(n.clearLocalStorage())}),u(2,"i",40),o(3," Add Purchase "),r()()}}function ut(a,m){a&1&&(i(0,"th",27),o(1,"Actions"),r())}function pt(a,m){if(a&1){let e=y();i(0,"td",50)(1,"button",51),P("click",function(){b(e);let n=p().$implicit,c=p();return C(c.editPurchase(n.id))})("touchstart",function(n){return b(e),C(n.stopPropagation())}),u(2,"i",52),r(),i(3,"button",53),P("click",function(){b(e);let n=p().$implicit,c=p();return C(c.generatePdf(n.id,n.invoiceNumber))})("touchstart",function(n){return b(e),C(n.stopPropagation())}),u(4,"i",54),r(),i(5,"button",55),P("click",function(){b(e);let n=p().$implicit,c=p();return C(c.openReturn(n.id))})("touchstart",function(n){return b(e),C(n.stopPropagation())}),u(6,"i",56),r(),i(7,"button",57),P("click",function(){b(e);let n=p().$implicit,c=p();return C(c.openQc(n.id))})("touchstart",function(n){return b(e),C(n.stopPropagation())}),u(8,"i",58),r(),i(9,"button",59),P("click",function(){b(e);let n=p().$implicit,c=p();return C(c.deletePurchase(n.id))})("touchstart",function(n){return b(e),C(n.stopPropagation())}),u(10,"i",60),r()()}}function mt(a,m){if(a&1&&(i(0,"tr",41)(1,"td",42),o(2),r(),i(3,"td",43)(4,"strong"),o(5),r()(),i(6,"td",44),o(7),r(),i(8,"td",45),o(9),k(10,"date"),r(),i(11,"td",46)(12,"strong"),o(13),r()(),i(14,"td",47)(15,"span",48),o(16),r()(),_(17,pt,11,0,"td",49),r()),a&2){let e,t=m.$implicit,n=m.index,c=p();s(2),M(c.startIndex+n+1),s(3),M(t.invoiceNumber),s(2),M(t.customerName),s(2),M(I(10,12,t.purchaseDate,"dd-MM-yyyy")),s(4),M((e=t.totalPurchaseAmount)!==null&&e!==void 0?e:0),s(2),w("pass",t.isQcPass)("pending",!t.isQcPass),qe("aria-label",t.isQcPass?"QC Pass":"QC Pending"),s(),S(" ",t.isQcPass?"Pass":"Pending"," "),s(),d("ngIf",c.canManagePurchases)}}function gt(a,m){if(a&1){let e=y();i(0,"app-pagination",61),P("pageChange",function(n){b(e);let c=p();return C(c.onPageChange(n))})("pageSizeChange",function(n){b(e);let c=p();return C(c.onPageSizeChange(n))}),r()}if(a&2){let e=p();d("currentPage",e.currentPage)("pageSize",e.pageSize)("totalElements",e.totalElements)("pageSizeOptions",e.pageSizeOptions)}}function ht(a,m){if(a&1){let e=y();i(0,"app-sale-modal",62),P("saleCreated",function(){b(e);let n=p();return C(n.loadPurchases())}),r()}if(a&2){let e=p();d("purchase",e.selectedPurchase)}}var He=(()=>{class a{constructor(e,t,n,c,l,g,h,v,E,tt,nt,rt){this.purchaseService=e,this.customerService=t,this.fb=n,this.snackbar=c,this.dialog=l,this.modalService=g,this.dateUtils=h,this.cacheService=v,this.encryptionService=E,this.router=tt,this.authService=nt,this.cdr=rt,this.purchases=[],this.isLoading=!1,this.currentPage=0,this.pageSize=10,this.pageSizeOptions=[5,10,25,50,100],this.totalPages=0,this.totalElements=0,this.startIndex=0,this.endIndex=0,this.selectedPurchase=null,this.products=[],this.isLoadingProducts=!1,this.customers=[],this.isLoadingCustomers=!1,this.canManagePurchases=!1,this.destroy$=new F,this.initializeForm()}ngOnInit(){this.canManagePurchases=this.authService.isAdmin()||this.authService.isStaffAdmin(),this.loadPurchases(),this.canManagePurchases&&this.loadCustomers()}initializeForm(){this.searchForm=this.fb.group({search:[""],customerId:[""],startDate:[""],endDate:[""],batchNumber:[""]})}loadPurchases(){this.isLoading=!0;let e=De({currentPage:this.currentPage,perPageRecord:this.pageSize,startDate:this.searchForm.value.startDate?this.dateUtils.formatDate(this.searchForm.value.startDate):"",endDate:this.searchForm.value.endDate?this.dateUtils.formatDate(this.searchForm.value.endDate):""},this.searchForm.value);this.purchaseService.searchPurchases(e).pipe(x(this.destroy$)).subscribe({next:t=>{this.purchases=t.content,this.totalPages=t.totalPages,this.totalElements=t.totalElements,this.startIndex=this.currentPage*this.pageSize,this.endIndex=Math.min((this.currentPage+1)*this.pageSize,this.totalElements),this.isLoading=!1,this.cdr.markForCheck()},error:t=>{this.snackbar.error(t.message||"Failed to load purchases"),this.isLoading=!1,this.cdr.markForCheck()}})}onSearch(){this.currentPage=0,this.loadPurchases()}onPageChange(e){this.currentPage=e,this.loadPurchases()}onPageSizeChange(e){this.pageSize=e,this.currentPage=0,this.loadPurchases()}openSaleModal(e){this.selectedPurchase=e,this.modalService.open("sale")}deletePurchase(e){confirm("Are you sure you want to delete this purchase? This action cannot be undone.")&&(this.isLoading=!0,this.purchaseService.deletePurchase(e).pipe(x(this.destroy$)).subscribe({next:()=>{this.snackbar.success("Purchase deleted successfully"),this.loadPurchases()},error:t=>{this.snackbar.error(t?.error?.message||"Failed to delete purchase"),this.isLoading=!1,this.cdr.markForCheck()}}))}loadCustomers(){this.canManagePurchases&&(this.isLoadingCustomers=!0,this.customerService.getCustomers({status:"A"}).pipe(x(this.destroy$)).subscribe({next:e=>{e.success&&(this.customers=e.data),this.isLoadingCustomers=!1,this.cdr.markForCheck()},error:e=>{this.snackbar.error("Failed to load customers"),this.isLoadingCustomers=!1,this.cdr.markForCheck()}}))}refreshCustomers(){this.canManagePurchases&&(this.isLoadingCustomers=!0,this.customerService.refreshCustomers().pipe(x(this.destroy$)).subscribe({next:e=>{e.success&&(this.customers=e.data,this.snackbar.success("Customers refreshed successfully")),this.isLoadingCustomers=!1,this.cdr.markForCheck()},error:e=>{this.snackbar.error("Failed to refresh customers"),this.isLoadingCustomers=!1,this.cdr.markForCheck()}}))}resetForm(){this.searchForm.reset(),this.currentPage=0,this.loadPurchases()}editPurchase(e){localStorage.setItem("purchaseId",this.encryptionService.encrypt(e.toString())),this.router.navigate(["/purchase/create"])}clearLocalStorage(){localStorage.removeItem("purchaseId"),this.router.navigate(["/purchase/create"])}openReturn(e){let t=this.encryptionService.encrypt(e.toString());this.router.navigate(["/purchase/return",t])}openQc(e){let t=this.encryptionService.encrypt(e.toString());this.router.navigate(["/purchase/qc",t])}generatePdf(e,t){this.purchaseService.generatePdf(e).pipe(x(this.destroy$)).subscribe({next:({blob:n,filename:c})=>{let l="purchase-"+(t?`${t}.pdf`:c),g=window.URL.createObjectURL(n),h=document.createElement("a");h.href=g,h.download=l,document.body.appendChild(h),h.click(),document.body.removeChild(h),window.URL.revokeObjectURL(g),this.snackbar.success("PDF downloaded successfully")},error:n=>{this.snackbar.error(n?.error?.message||"Failed to generate PDF")}})}isExportButtonDisabled(){let e=this.searchForm.get("startDate")?.value,t=this.searchForm.get("endDate")?.value;return!e||!t}exportExcel(){let e=this.searchForm.get("startDate")?.value,t=this.searchForm.get("endDate")?.value;if(!e||!t){this.snackbar.error("Please select both start date and end date to export");return}let n=this.dateUtils.formatDateDDMMYYYY(e),c=this.dateUtils.formatDateDDMMYYYY(t);this.isLoading=!0,this.purchaseService.exportExcel({startDate:n,endDate:c}).pipe(x(this.destroy$)).subscribe({next:({blob:l,filename:g})=>{let h=window.URL.createObjectURL(l),v=document.createElement("a");v.href=h,v.download=g||`purchase_export_${n}_${c}.xlsx`,document.body.appendChild(v),v.click(),document.body.removeChild(v),window.URL.revokeObjectURL(h),this.snackbar.success("Excel file downloaded successfully"),this.isLoading=!1,this.cdr.markForCheck()},error:l=>{this.snackbar.error(l?.error?.message||"Failed to export Excel file"),this.isLoading=!1,this.cdr.markForCheck()}})}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete()}static{this.\u0275fac=function(t){return new(t||a)(f(U),f(ue),f(j),f($),f(Ge),f(Ue),f(ye),f($e),f(Q),f(J),f(Oe),f(Ce))}}static{this.\u0275cmp=A({type:a,selectors:[["app-purchase"]],standalone:!0,features:[Pe],decls:56,vars:9,consts:[[1,"purchase-container"],[3,"show"],["aria-labelledby","search-purchases-heading",1,"search-section","card"],["id","search-purchases-heading"],["role","search","aria-label","Purchase search form",3,"ngSubmit","formGroup"],[1,"search-controls"],[1,"form-group"],["for","invoice-search",1,"sr-only"],["id","invoice-search","type","text","formControlName","search","placeholder","Search by invoice number...","aria-label","Search by invoice number",1,"form-control"],["for","batch-search",1,"sr-only"],["id","batch-search","type","text","formControlName","batchNumber","placeholder","Search by Batch Number...","aria-label","Search by batch number",1,"form-control"],["class","form-group",4,"ngIf"],["for","start-date",1,"sr-only"],["id","start-date","type","date","formControlName","startDate","placeholder","Start Date","aria-label","Start date",1,"form-control",3,"touchstart"],["for","end-date",1,"sr-only"],["id","end-date","type","date","formControlName","endDate","placeholder","End Date","aria-label","End date",1,"form-control",3,"touchstart"],[1,"button-group"],["type","submit",1,"search-btn","btn","btn-sm","btn-primary"],[1,"fas","fa-search"],["type","button",1,"search-btn","btn","btn-sm","btn-secondary",3,"click"],[1,"fas","fa-undo"],["type","button","class","search-btn btn btn-sm btn-success export-btn","title","Export purchases to Excel",3,"disabled","click",4,"ngIf"],["class","action-header",4,"ngIf"],["aria-labelledby","purchases-heading",1,"purchases-list","card"],["id","purchases-heading"],[1,"table-responsive"],["role","table","aria-label","Purchases list",1,"table"],["scope","col"],["scope","col",4,"ngIf"],["role","row",4,"ngFor","ngForOf"],[3,"currentPage","pageSize","totalElements","pageSizeOptions","pageChange","pageSizeChange",4,"ngIf"],[3,"purchase","saleCreated",4,"ngIf"],[1,"product-select-group"],["formControlName","customerId","labelKey","name","valueKey","id",3,"options","defaultOption","searchPlaceholder"],["type","button","title","Refresh Customers",1,"btn","btn-sm","btn-primary","refresh",2,"margin-top","3px",3,"click","disabled"],[1,"fas",3,"ngClass"],["type","button","title","Export purchases to Excel",1,"search-btn","btn","btn-sm","btn-success","export-btn",3,"click","disabled"],[1,"fas","fa-file-excel"],[1,"action-header"],["aria-label","Add new purchase",1,"btn","btn-sm","btn-primary","mb-2",3,"click"],["aria-hidden","true",1,"fas","fa-plus"],["role","row"],["data-label","No"],["data-label","Invoice No."],["data-label","Customer Name"],["data-label","Purchase Date"],["data-label","Total Purchase Amount"],["data-label","QC Status"],[1,"status-chip"],["class","actions","data-label","Actions",4,"ngIf"],["data-label","Actions",1,"actions"],["aria-label","View purchase details",1,"btn-icon","edit",3,"click","touchstart"],["aria-hidden","true",1,"fas","fa-eye"],["aria-label","Export purchase as PDF",1,"btn-icon","pdf",3,"click","touchstart"],["aria-hidden","true",1,"fas","fa-file-pdf"],["aria-label","Add purchase return",1,"btn-icon","add-return",3,"click","touchstart"],["aria-hidden","true",1,"fas","fa-undo"],["aria-label","Purchase quality check",1,"btn-icon","qc",3,"click","touchstart"],["aria-hidden","true",1,"fas","fa-clipboard-check"],["aria-label","Delete purchase",1,"btn-icon","delete",3,"click","touchstart"],["aria-hidden","true",1,"fas","fa-trash"],[3,"pageChange","pageSizeChange","currentPage","pageSize","totalElements","pageSizeOptions"],[3,"saleCreated","purchase"]],template:function(t,n){t&1&&(i(0,"div",0),u(1,"app-loader",1),i(2,"section",2)(3,"h2",3),o(4,"Search Purchases"),r(),i(5,"form",4),P("ngSubmit",function(){return n.onSearch()}),i(6,"div",5)(7,"div",6)(8,"label",7),o(9,"Search by invoice number"),r(),u(10,"input",8),i(11,"label",9),o(12,"Search by batch number"),r(),u(13,"input",10),r(),_(14,st,5,6,"div",11),i(15,"div",6)(16,"label",12),o(17,"Start date"),r(),i(18,"input",13),P("touchstart",function(l){return l.stopPropagation()}),r()(),i(19,"div",6)(20,"label",14),o(21,"End date"),r(),i(22,"input",15),P("touchstart",function(l){return l.stopPropagation()}),r()(),i(23,"div",16)(24,"button",17),u(25,"i",18),o(26," Search "),r(),i(27,"button",19),P("click",function(){return n.resetForm()}),u(28,"i",20),o(29," Reset "),r(),_(30,lt,3,1,"button",21),r()()()(),_(31,dt,4,0,"div",22),i(32,"section",23)(33,"h2",24),o(34,"Purchases"),r(),i(35,"div",25)(36,"table",26)(37,"thead")(38,"tr")(39,"th",27),o(40,"No"),r(),i(41,"th",27),o(42,"Invoice No."),r(),i(43,"th",27),o(44,"Customer Name"),r(),i(45,"th",27),o(46,"Purchase Date"),r(),i(47,"th",27),o(48,"Total Purchase Amount"),r(),i(49,"th",27),o(50,"QC Status"),r(),_(51,ut,2,0,"th",28),r()(),i(52,"tbody"),_(53,mt,18,15,"tr",29),r()()(),_(54,gt,1,4,"app-pagination",30),r()(),_(55,ht,1,1,"app-sale-modal",31)),t&2&&(s(),d("show",n.isLoading),s(4),d("formGroup",n.searchForm),s(9),d("ngIf",n.canManagePurchases),s(16),d("ngIf",n.canManagePurchases),s(),d("ngIf",n.canManagePurchases),s(20),d("ngIf",n.canManagePurchases),s(2),d("ngForOf",n.purchases),s(),d("ngIf",n.totalPages>0),s(),d("ngIf",n.selectedPurchase))},dependencies:[ne,H,N,D,W,ce,L,R,T,V,q,z,Qe,G,Be,Ye,X,Z,le],styles:[".purchase-container[_ngcontent-%COMP%]{padding:2rem;position:relative;min-height:200px;background-color:var(--background)}.purchase-container[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]{background:#fff;border-radius:0;box-shadow:0 2px 4px #0000001a;margin-bottom:20px;padding:20px}.purchase-container[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{margin-bottom:20px;color:var(--text-primary);font-size:1.5rem;font-weight:600}.purchase-container[_ngcontent-%COMP%]   .action-header[_ngcontent-%COMP%]{margin-bottom:1rem}.purchase-container[_ngcontent-%COMP%]   .action-header[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{touch-action:manipulation;-webkit-tap-highlight-color:transparent}.purchase-container[_ngcontent-%COMP%]   .sr-only[_ngcontent-%COMP%]{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border-width:0}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;align-items:flex-start}@media (max-width: 768px){.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]{grid-template-columns:1fr}}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]{margin:0}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]   .form-control[_ngcontent-%COMP%]{height:40px}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]   .product-select-group[_ngcontent-%COMP%]{display:flex;gap:.5rem}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]   .product-select-group[_ngcontent-%COMP%]   app-searchable-select[_ngcontent-%COMP%]{flex:1}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]   .product-select-group[_ngcontent-%COMP%]   .btn-icon[_ngcontent-%COMP%]{width:42px;padding:0;display:flex;align-items:center;justify-content:center;border:1px solid var(--border-color);border-radius:var(--border-radius);background:var(--primary)}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]   .product-select-group[_ngcontent-%COMP%]   .btn-icon[_ngcontent-%COMP%]:hover:not(:disabled){background:var(--primary)}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]   .product-select-group[_ngcontent-%COMP%]   .btn-icon[_ngcontent-%COMP%]:disabled{opacity:.6;cursor:not-allowed}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]{display:flex;gap:.5rem;flex-wrap:wrap}@media (max-width: 768px){.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]{grid-column:1/-1}}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{flex:1;min-width:120px;height:42px;display:flex;align-items:center;justify-content:center;gap:.5rem;transition:all .2s ease;touch-action:manipulation;-webkit-tap-highlight-color:transparent;cursor:pointer}@media (max-width: 576px){.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{min-width:100%;flex:1 1 100%}}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{font-size:1rem}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]   button.export-btn[_ngcontent-%COMP%]{background-color:#28a745;color:#fff;border:1px solid #28a745;font-weight:500}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]   button.export-btn[_ngcontent-%COMP%]:hover:not(:disabled){background-color:#218838;border-color:#1e7e34;transform:translateY(-1px);box-shadow:0 2px 4px #28a7454d}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]   button.export-btn[_ngcontent-%COMP%]:active:not(:disabled), .purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]   button.export-btn[_ngcontent-%COMP%]:focus:not(:disabled){outline:2px solid rgba(40,167,69,.5);outline-offset:2px;transform:translateY(0)}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]   button.export-btn[_ngcontent-%COMP%]:disabled{background-color:#6c757d;border-color:#6c757d;opacity:.6;cursor:not-allowed;transform:none}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]   button.export-btn[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{color:#fff}.purchase-container[_ngcontent-%COMP%]   .purchases-list[_ngcontent-%COMP%]   .table-responsive[_ngcontent-%COMP%]{overflow-x:auto;-webkit-overflow-scrolling:touch}.purchase-container[_ngcontent-%COMP%]   .purchases-list[_ngcontent-%COMP%]   .table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{white-space:nowrap;font-weight:600}.purchase-container[_ngcontent-%COMP%]   .purchases-list[_ngcontent-%COMP%]   .table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{vertical-align:middle}@media (max-width: 768px){.purchase-container[_ngcontent-%COMP%]   .purchases-list[_ngcontent-%COMP%]   .table[_ngcontent-%COMP%]   thead[_ngcontent-%COMP%]{display:none}.purchase-container[_ngcontent-%COMP%]   .purchases-list[_ngcontent-%COMP%]   .table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]{display:block;margin-bottom:1rem;border:1px solid #dee2e6;border-radius:4px;padding:.5rem}.purchase-container[_ngcontent-%COMP%]   .purchases-list[_ngcontent-%COMP%]   .table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;padding:.5rem;border:none;border-bottom:1px solid #f0f0f0}.purchase-container[_ngcontent-%COMP%]   .purchases-list[_ngcontent-%COMP%]   .table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]:before{content:attr(data-label);font-weight:600;color:var(--text-primary)}.purchase-container[_ngcontent-%COMP%]   .purchases-list[_ngcontent-%COMP%]   .table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]:last-child{border-bottom:none}.purchase-container[_ngcontent-%COMP%]   .purchases-list[_ngcontent-%COMP%]   .table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   td.actions[_ngcontent-%COMP%]{justify-content:flex-start;flex-wrap:wrap;gap:.5rem}.purchase-container[_ngcontent-%COMP%]   .purchases-list[_ngcontent-%COMP%]   .table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   td.actions[_ngcontent-%COMP%]:before{display:none}}.purchase-container[_ngcontent-%COMP%]   .table-controls[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}.purchase-container[_ngcontent-%COMP%]   .table-controls[_ngcontent-%COMP%]   .page-size-selector[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem}.purchase-container[_ngcontent-%COMP%]   .table-controls[_ngcontent-%COMP%]   .page-size-selector[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{color:var(--text-secondary);white-space:nowrap}.purchase-container[_ngcontent-%COMP%]   .table-controls[_ngcontent-%COMP%]   .page-size-selector[_ngcontent-%COMP%]   select.form-control[_ngcontent-%COMP%]{width:auto;min-width:80px;padding:.5rem;margin-bottom:0}@media (max-width: 768px){.purchase-container[_ngcontent-%COMP%]{padding:1rem}.purchase-container[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]{flex-direction:column;gap:1rem}.purchase-container[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]{width:100%}.purchase-container[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]   input[type=date][_ngcontent-%COMP%]{touch-action:manipulation;-webkit-appearance:none}.purchase-container[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{width:100%}.purchase-container[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]{padding:1rem}}@media (max-width: 576px){.purchase-container[_ngcontent-%COMP%]{padding:.75rem}.purchase-container[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{font-size:1.25rem}}@media (max-width: 576px){.table-controls[_ngcontent-%COMP%]{flex-direction:column;gap:1rem;align-items:flex-start}.table-controls[_ngcontent-%COMP%]   .page-size-selector[_ngcontent-%COMP%]{width:100%}.table-controls[_ngcontent-%COMP%]   .page-size-selector[_ngcontent-%COMP%]   select.form-control[_ngcontent-%COMP%]{flex:1}}.actions[_ngcontent-%COMP%]{display:flex;gap:.5rem;justify-content:flex-start;flex-wrap:wrap}.actions[_ngcontent-%COMP%]   .btn-icon[_ngcontent-%COMP%]{background:none;border:none;padding:8px;cursor:pointer;border-radius:6px;transition:all .2s ease;display:flex;align-items:center;justify-content:center;touch-action:manipulation;-webkit-tap-highlight-color:transparent;min-width:36px;min-height:36px}.actions[_ngcontent-%COMP%]   .btn-icon.edit[_ngcontent-%COMP%]{color:var(--primary);background-color:#1458811a}.actions[_ngcontent-%COMP%]   .btn-icon.edit[_ngcontent-%COMP%]:hover:not(:disabled){background-color:var(--primary);color:#fff;transform:translateY(-1px)}.actions[_ngcontent-%COMP%]   .btn-icon.edit[_ngcontent-%COMP%]:disabled{color:var(--text-secondary);background-color:#0000000d;cursor:not-allowed}.actions[_ngcontent-%COMP%]   .btn-icon.pdf[_ngcontent-%COMP%]{color:#dc3545;background-color:#dc35451a}.actions[_ngcontent-%COMP%]   .btn-icon.pdf[_ngcontent-%COMP%]:hover:not(:disabled){background-color:#dc3545;color:#fff;transform:translateY(-1px)}.actions[_ngcontent-%COMP%]   .btn-icon.pdf[_ngcontent-%COMP%]:disabled{color:var(--text-secondary);background-color:#0000000d;cursor:not-allowed}.actions[_ngcontent-%COMP%]   .btn-icon.add-return[_ngcontent-%COMP%]{color:#ff9800;background-color:#ff98001a}.actions[_ngcontent-%COMP%]   .btn-icon.add-return[_ngcontent-%COMP%]:hover:not(:disabled){background-color:#ff9800;color:#fff;transform:translateY(-1px)}.actions[_ngcontent-%COMP%]   .btn-icon.add-return[_ngcontent-%COMP%]:disabled{color:var(--text-secondary);background-color:#0000000d;cursor:not-allowed}.actions[_ngcontent-%COMP%]   .btn-icon.qc[_ngcontent-%COMP%]{color:#28a745;background-color:#28a7451a}.actions[_ngcontent-%COMP%]   .btn-icon.qc[_ngcontent-%COMP%]:hover:not(:disabled){background-color:#28a745;color:#fff;transform:translateY(-1px)}.actions[_ngcontent-%COMP%]   .btn-icon.qc[_ngcontent-%COMP%]:disabled{color:var(--text-secondary);background-color:#0000000d;cursor:not-allowed}.actions[_ngcontent-%COMP%]   .btn-icon.sale[_ngcontent-%COMP%]{color:var(--primary);background-color:#fd78231a}.actions[_ngcontent-%COMP%]   .btn-icon.sale[_ngcontent-%COMP%]:hover:not(:disabled){background-color:var(--primary);color:#fff;transform:translateY(-1px)}.actions[_ngcontent-%COMP%]   .btn-icon.sale[_ngcontent-%COMP%]:disabled{color:var(--text-secondary);background-color:#0000000d;cursor:not-allowed}.actions[_ngcontent-%COMP%]   .btn-icon.delete[_ngcontent-%COMP%]{color:#dc3545;background-color:#dc35451a}.actions[_ngcontent-%COMP%]   .btn-icon.delete[_ngcontent-%COMP%]:hover{background-color:#dc3545;color:#fff;transform:translateY(-1px)}.actions[_ngcontent-%COMP%]   .btn-icon[_ngcontent-%COMP%]:active{transform:translateY(0)}.actions[_ngcontent-%COMP%]   .btn-icon[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{font-size:16px}@media (max-width: 768px){.actions[_ngcontent-%COMP%]   .btn-icon[_ngcontent-%COMP%]{padding:6px}.actions[_ngcontent-%COMP%]   .btn-icon[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{font-size:14px}}.status-chip[_ngcontent-%COMP%]{display:inline-flex;align-items:center;justify-content:center;padding:.25rem .75rem;border-radius:999px;font-size:.8rem;font-weight:600;letter-spacing:.02em;text-transform:uppercase;white-space:nowrap}.status-chip.pass[_ngcontent-%COMP%]{background-color:#28a74526;color:#28a745}.status-chip.pending[_ngcontent-%COMP%]{background-color:#ffc10726;color:#ffc107}  .custom-snackbar.success{background-color:var(--accent2)}  .custom-snackbar.error{background-color:#dc3545}  .custom-snackbar .snackbar-message{display:flex;align-items:center;gap:.5rem;color:#fff}  .custom-snackbar .snackbar-message i{font-size:1.2rem}.loading-overlay[_ngcontent-%COMP%]{position:absolute;inset:0;background:#fffc;display:flex;justify-content:center;align-items:center;z-index:1000}.loading-overlay[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{font-size:2rem;color:var(--primary)}.product-select-group[_ngcontent-%COMP%]{display:flex;gap:.5rem;align-items:flex-start}.product-select-group[_ngcontent-%COMP%]   app-searchable-select[_ngcontent-%COMP%]{flex:1}.product-select-group[_ngcontent-%COMP%]   .btn-icon.refresh[_ngcontent-%COMP%]{background-color:var(--background);color:#fff;margin-top:3px;width:42px;height:42px;border-radius:6px;transition:all .2s ease}.product-select-group[_ngcontent-%COMP%]   .btn-icon.refresh[_ngcontent-%COMP%]:hover:not(:disabled){background-color:var(--primary);color:#fff;transform:translateY(-1px)}.product-select-group[_ngcontent-%COMP%]   .btn-icon.refresh[_ngcontent-%COMP%]:disabled{opacity:.7;cursor:not-allowed}.product-select-group[_ngcontent-%COMP%]   .btn-icon.refresh[_ngcontent-%COMP%]:active{transform:translateY(0)}"],changeDetection:0})}}return a})();function ft(a,m){a&1&&(i(0,"div",46),o(1," Customer is required "),r())}function _t(a,m){a&1&&(i(0,"div",46),o(1," Purchase date is required "),r())}function Pt(a,m){a&1&&(i(0,"div",46),o(1," Invoice number is required "),r())}function bt(a,m){a&1&&(i(0,"div",46),o(1," Packaging and forwarding charges is required and must be 0 or greater "),r())}function Ct(a,m){a&1&&(i(0,"div",46),o(1," Please select a product "),r())}function vt(a,m){a&1&&(i(0,"div",46),o(1," Quantity must be 1 or greater "),r())}function xt(a,m){a&1&&(i(0,"div",46),o(1," Double quotes are not allowed "),r())}function Mt(a,m){a&1&&(i(0,"div",46),o(1," Unit price must be greater than 0 "),r())}function Ot(a,m){if(a&1){let e=y();i(0,"tr",47)(1,"td")(2,"div",48)(3,"div",14),u(4,"app-searchable-select",49),i(5,"button",50),P("click",function(){b(e);let n=p();return C(n.refreshProducts())}),u(6,"i",17),r()(),_(7,Ct,2,0,"div",18),r()(),i(8,"td")(9,"div",48),u(10,"input",51),_(11,vt,2,0,"div",18),r()(),i(12,"td")(13,"div",48),u(14,"input",52),_(15,xt,2,0,"div",18),r()(),i(16,"td")(17,"div",48)(18,"div",27),u(19,"input",53),r(),_(20,Mt,2,0,"div",18),r()(),i(21,"td")(22,"div",27),u(23,"input",54),r()(),i(24,"td")(25,"div",27),u(26,"input",55),r()(),i(27,"td")(28,"div",48),u(29,"input",56),r()(),i(30,"td")(31,"button",57),P("click",function(){let n=b(e).index,c=p();return C(c.removeProduct(n))}),u(32,"i",58),r()()()}if(a&2){let e,t=m.index,n=p();d("formGroupName",t),s(4),w("is-invalid",n.isProductFieldInvalid(t,"productId")),d("focusWidthPx",600)("options",n.products)("placeholder","Select Product")("searchPlaceholder","Search products..."),s(),d("disabled",n.isLoadingProducts),s(),d("ngClass",n.isLoadingProducts?"fa-spinner fa-spin":"fa-sync-alt"),s(),d("ngIf",n.isProductFieldInvalid(t,"productId")),s(3),w("is-invalid",n.isProductFieldInvalid(t,"quantity")),s(),d("ngIf",n.isProductFieldInvalid(t,"quantity")),s(3),w("is-invalid",n.isProductFieldInvalid(t,"batchNumber")),s(),d("ngIf",(e=n.productsFormArray.at(t).get("batchNumber"))==null||e.errors==null?null:e.errors.doubleQuotes),s(4),w("is-invalid",n.isProductFieldInvalid(t,"unitPrice")),s(),d("ngIf",n.isProductFieldInvalid(t,"unitPrice")),s(3),d("value",n.getFormattedPrice(t)),s(3),d("value",n.getFormattedTaxAmount(t)),s(5),d("disabled",n.productsFormArray.length===1)}}function yt(a,m){a&1&&u(0,"app-loader")}var Ne=(()=>{class a{get productsFormArray(){return this.purchaseForm.get("products")}trackByProductIndex(e,t){return t}constructor(e,t,n,c,l,g,h,v,E){this.fb=e,this.productService=t,this.customerService=n,this.purchaseService=c,this.snackbar=l,this.http=g,this.router=h,this.encryptionService=v,this.cdr=E,this.products=[],this.customers=[],this.loading=!1,this.isLoadingProducts=!1,this.isLoadingCustomers=!1,this.isEdit=!1,this.destroy$=new F,this.productSubscriptions=[],this.totalAmount=0,this.totalTaxAmount=0,this.grandTotal=0,this.productMap=new Map,this.initForm()}ngOnInit(){this.loadProducts(),this.loadCustomers();let e=localStorage.getItem("purchaseId");if(e){let t=this.encryptionService.decrypt(e);t&&this.fetchPurchaseDetails(Number(t))}}ngOnDestroy(){this.productSubscriptions.forEach(e=>{e&&!e.closed&&e.unsubscribe()}),this.productSubscriptions=[],this.destroy$.next(),this.destroy$.complete(),this.products=[],this.customers=[],this.productMap.clear(),this.purchaseForm&&this.purchaseForm.reset()}initForm(){this.purchaseForm=this.fb.group({id:[null],customerId:["",O.required],purchaseDate:[K(new Date,"yyyy-MM-dd","en"),O.required],invoiceNumber:["",O.required],packagingAndForwadingCharges:[0,[O.required,O.min(0)]],products:this.fb.array([])}),this.purchaseForm.get("packagingAndForwadingCharges")?.valueChanges.pipe(x(this.destroy$),Fe(150)).subscribe(()=>{let e=Number(this.purchaseForm.get("packagingAndForwadingCharges")?.value||0);this.grandTotal=this.totalAmount+this.totalTaxAmount+e,this.cdr.markForCheck()}),this.addProduct()}createProductFormGroup(){return this.fb.group({id:[null],productId:["",O.required],quantity:["",[O.required,O.min(1)]],batchNumber:["",[this.noDoubleQuotesValidator()]],unitPrice:["",[O.required,O.min(.01)]],price:[{value:0,disabled:!0}],taxPercentage:[{value:0,disabled:!0}],taxAmount:[{value:0,disabled:!0}],remarks:[null,[]]})}addProduct(){let e=this.createProductFormGroup(),t=this.setupProductCalculations(e);this.productSubscriptions.push(t),this.productsFormArray.push(e)}removeProduct(e){this.productsFormArray.length!==1&&(this.productSubscriptions[e]&&(this.productSubscriptions[e].unsubscribe(),this.productSubscriptions.splice(e,1)),this.productsFormArray.removeAt(e),this.calculateTotalAmount())}setupProductCalculations(e){let t=new Re,n=e.get("productId")?.valueChanges.pipe(x(this.destroy$),Te()).subscribe(l=>{if(l){let g=this.productMap.get(l);if(g){let h=g.taxPercentage||0,v=g.purchaseAmount||0;e.patchValue({taxPercentage:h,unitPrice:v},{emitEvent:!1}),this.calculateProductPrice(e)}}});n&&t.add(n);let c=e.valueChanges.pipe(x(this.destroy$),Fe(150)).subscribe(()=>{this.calculateProductPrice(e)});return t.add(c),t}calculateProductPrice(e){if(!e)return;let t=Number(e.get("quantity")?.value||0),n=Number(e.get("unitPrice")?.value||0),c=Number(e.get("taxPercentage")?.value||0),l=Number((t*n).toFixed(2)),g=Number((l*c/100).toFixed(2));e.patchValue({price:l,taxAmount:g},{emitEvent:!1}),this.calculateTotalAmount()}getTotalAmount(){return this.productsFormArray.controls.reduce((e,t)=>e+(t.get("price").value||0),0)}getTotalTaxAmount(){return this.productsFormArray.controls.reduce((e,t)=>e+(t.get("taxAmount").value||0),0)}getGrandTotal(){let e=Number(this.purchaseForm.get("packagingAndForwadingCharges")?.value||0);return this.getTotalAmount()+this.getTotalTaxAmount()+e}loadProducts(){this.isLoadingProducts=!0,this.productService.getProducts({status:"A"}).pipe(x(this.destroy$)).subscribe({next:e=>{e.success&&(this.products=e.data,this.buildProductMap()),this.isLoadingProducts=!1,this.cdr.markForCheck()},error:e=>{this.snackbar.error("Failed to load products"),this.isLoadingProducts=!1,this.cdr.markForCheck()}})}buildProductMap(){this.productMap.clear();for(let e of this.products)this.productMap.set(e.id,e)}refreshProducts(){this.isLoadingProducts=!0,this.productService.refreshProducts().pipe(x(this.destroy$)).subscribe({next:e=>{e.success&&(this.products=e.data,this.buildProductMap(),this.snackbar.success("Products refreshed successfully")),this.isLoadingProducts=!1,this.cdr.markForCheck()},error:e=>{this.snackbar.error("Failed to refresh products"),this.isLoadingProducts=!1,this.cdr.markForCheck()}})}loadCustomers(){this.isLoadingCustomers=!0,this.customerService.getCustomers({status:"A"}).pipe(x(this.destroy$)).subscribe({next:e=>{e.success&&(this.customers=e.data),this.isLoadingCustomers=!1,this.cdr.markForCheck()},error:e=>{this.snackbar.error("Failed to load customers"),this.isLoadingCustomers=!1,this.cdr.markForCheck()}})}refreshCustomers(){this.isLoadingCustomers=!0,this.customerService.refreshCustomers().pipe(x(this.destroy$)).subscribe({next:e=>{e.success&&(this.customers=e.data),this.snackbar.success("Customers refreshed successfully"),this.isLoadingCustomers=!1,this.cdr.markForCheck()},error:e=>{this.snackbar.error("Failed to load customers"),this.isLoadingCustomers=!1,this.cdr.markForCheck()}})}isFieldInvalid(e){let t=this.purchaseForm.get(e);return t?t.invalid&&t.touched:!1}isProductFieldInvalid(e,t){let n=this.productsFormArray.at(e).get(t);if(!n)return!1;if(n.invalid&&(n.dirty||n.touched)){let l=n.errors;if(l&&(l.required||l.min&&t==="quantity"||l.min&&t==="unitPrice"||l.min||l.max||l.min))return!0}return!1}resetForm(){this.isEdit=!1,this.purchaseForm.patchValue({id:null}),this.initForm()}onSubmit(){if(this.markFormGroupTouched(this.purchaseForm),this.purchaseForm.valid){this.loading=!0;let e=this.preparePurchaseData();(this.isEdit?this.purchaseService.updatePurchase(e):this.purchaseService.createPurchase(e)).pipe(x(this.destroy$)).subscribe({next:n=>{n?.success&&(this.snackbar.success(`Purchase ${this.isEdit?"updated":"created"} successfully`),localStorage.removeItem("purchaseId"),this.router.navigate(["/purchase"])),this.loading=!1},error:n=>{this.snackbar.error(n?.error?.message||`Failed to ${this.isEdit?"update":"create"} purchase`),this.loading=!1}})}else{let e=document.querySelector(".is-invalid");e&&e.scrollIntoView({behavior:"smooth",block:"center"})}}preparePurchaseData(){let e=this.purchaseForm.value,t={purchaseDate:K(e.purchaseDate,"dd-MM-yyyy","en"),customerId:e.customerId,invoiceNumber:e.invoiceNumber,price:this.getTotalAmount(),taxAmount:this.getTotalTaxAmount(),packagingAndForwadingCharges:Number(e.packagingAndForwadingCharges||0),products:e.products.map((n,c)=>{let l=this.productsFormArray.at(c).get("id")?.value,g={productId:n.productId,quantity:n.quantity,batchNumber:n.batchNumber,unitPrice:n.unitPrice,price:this.productsFormArray.at(c).get("price")?.value,taxPercentage:this.productsFormArray.at(c).get("taxPercentage")?.value,taxAmount:this.productsFormArray.at(c).get("taxAmount")?.value,remarks:n.remarks};return this.isEdit&&l&&(g.id=l),g})};return this.isEdit&&e.id&&(t.id=e.id),t}markFormGroupTouched(e){Object.values(e.controls).forEach(t=>{t instanceof ze||t instanceof je?this.markFormGroupTouched(t):(t.markAsTouched(),t.markAsDirty())})}calculateTotalAmount(){this.totalAmount=this.productsFormArray.controls.reduce((t,n)=>t+(n.get("price").value||0),0),this.totalTaxAmount=this.productsFormArray.controls.reduce((t,n)=>t+(n.get("taxAmount").value||0),0);let e=Number(this.purchaseForm.get("packagingAndForwadingCharges")?.value||0);this.grandTotal=this.totalAmount+this.totalTaxAmount+e,this.purchaseForm.patchValue({price:this.totalAmount,taxAmount:this.totalTaxAmount,totalAmount:this.totalAmount+this.totalTaxAmount},{emitEvent:!1}),this.cdr.markForCheck()}noDoubleQuotesValidator(){return e=>e.value&&e.value.includes('"')?{doubleQuotes:!0}:null}getFormattedPrice(e){let t=this.productsFormArray.at(e).get("price")?.value;return t?t.toFixed(2):"0.00"}getFormattedTaxAmount(e){let t=this.productsFormArray.at(e).get("taxAmount")?.value;return t?t.toFixed(2):"0.00"}fetchPurchaseDetails(e){this.purchaseService.getPurchaseDetails(e).pipe(x(this.destroy$)).subscribe({next:t=>{t.id&&(this.isEdit=!0,this.populateForm(t))},error:t=>{this.snackbar.error(t?.error?.message||"Failed to load purchase details")}})}populateForm(e){this.productSubscriptions.forEach(t=>{t&&!t.closed&&t.unsubscribe()}),this.productSubscriptions=[],this.purchaseForm.patchValue({customerId:e.customerId,id:e.id,purchaseDate:K(new Date(e.purchaseDate),"yyyy-MM-dd","en"),invoiceNumber:e.invoiceNumber,packagingAndForwadingCharges:e.packagingAndForwadingCharges||0}),this.productsFormArray.clear(),e.items.forEach(t=>{let n=this.createProductFormGroup(),c=this.setupProductCalculations(n);this.productSubscriptions.push(c),n.patchValue({id:t.id,productId:t.productId,quantity:t.quantity,unitPrice:t.unitPrice,price:t.price,taxPercentage:t.taxPercentage,taxAmount:t.taxAmount,batchNumber:t.batchNumber,remarks:t.remarks},{emitEvent:!1}),this.productsFormArray.push(n)}),this.calculateTotalAmount(),this.isEdit=!0}static{this.\u0275fac=function(t){return new(t||a)(f(j),f(de),f(ue),f(U),f($),f(ve),f(J),f(Q),f(Ce))}}static{this.\u0275cmp=A({type:a,selectors:[["app-add-purchase"]],standalone:!0,features:[Pe],decls:121,vars:41,consts:[[1,"add-purchase-container"],["routerLink","/purchase",1,"btn","btn-sm","btn-secondary","back-btn"],[1,"fas","fa-arrow-left"],[1,"form-card"],[1,"card-header"],[1,"form-title"],[1,"fas","fa-cart-plus"],[1,"purchase-form",3,"ngSubmit","formGroup"],[1,"header-section"],[1,"form-row"],[1,"form-group"],["for","customerId"],[1,"fas","fa-user"],[1,"required"],[1,"select-group"],["formControlName","customerId","labelKey","name","valueKey","id",3,"options","placeholder","searchPlaceholder"],["type","button","title","Refresh Customers",1,"btn","btn-sm","btn-primary","refresh",3,"click","disabled"],[1,"fas",3,"ngClass"],["class","invalid-feedback",4,"ngIf"],["for","purchaseDate"],[1,"fas","fa-calendar"],["type","date","id","purchaseDate","formControlName","purchaseDate",1,"form-control"],["for","invoiceNumber"],[1,"fas","fa-file-invoice"],["type","text","id","invoiceNumber","formControlName","invoiceNumber",1,"form-control"],["for","packagingAndForwadingCharges"],[1,"fas","fa-box"],[1,"input-group"],[1,"input-group-text"],["type","number","id","packagingAndForwadingCharges","formControlName","packagingAndForwadingCharges","min","0","step","0.01","placeholder","Enter packaging and forwarding charges",1,"form-control"],["formArrayName","products",1,"products-section"],[1,"products-header"],[1,"fas","fa-boxes"],["type","button",1,"btn","btn-sm","btn-primary",3,"click"],[1,"fas","fa-plus"],[1,"table-responsive"],[1,"table","products-table"],[3,"formGroupName",4,"ngFor","ngForOf"],[1,"purchase-summary"],[1,"summary-item"],[1,"summary-item","total"],[1,"form-actions"],["type","button",1,"btn","btn-sm","btn-secondary",3,"click","disabled"],[1,"fas","fa-undo"],["type","submit",1,"btn","btn-sm","btn-primary",3,"disabled"],[4,"ngIf"],[1,"invalid-feedback"],[3,"formGroupName"],[1,"form-field-container"],["formControlName","productId","labelKey","name","valueKey","id",3,"focusWidthPx","options","placeholder","searchPlaceholder"],["type","button","title","Refresh Products",1,"btn","btn-sm","btn-primary","refresh",3,"click","disabled"],["type","number","formControlName","quantity","placeholder","Qty","min","1",1,"form-control"],["type","text","formControlName","batchNumber","placeholder","Batch Number",1,"form-control"],["type","number","formControlName","unitPrice","placeholder","Price","min","0.01","step","0.01",1,"form-control"],["type","number","formControlName","price","readonly","",1,"form-control",3,"value"],["type","number","formControlName","taxAmount","readonly","",1,"form-control",3,"value"],["type","text","formControlName","remarks","placeholder","Remarks",1,"form-control"],["type","button","title","Remove Product",1,"btn","btn-sm","btn-danger",3,"click","disabled"],[1,"fas","fa-trash"]],template:function(t,n){if(t&1&&(i(0,"div",0)(1,"button",1),u(2,"i",2),o(3," Back to Purchases "),r(),i(4,"div",3)(5,"div",4)(6,"h2",5),u(7,"i",6),o(8," Add New Purchase "),r()(),i(9,"form",7),P("ngSubmit",function(){return n.onSubmit()}),i(10,"div",8)(11,"div",9)(12,"div",10)(13,"label",11),u(14,"i",12),o(15," Select Customer "),i(16,"span",13),o(17,"*"),r()(),i(18,"div",14),u(19,"app-searchable-select",15),i(20,"button",16),P("click",function(){return n.refreshCustomers()}),u(21,"i",17),r()(),_(22,ft,2,0,"div",18),r(),i(23,"div",10)(24,"label",19),u(25,"i",20),o(26," Purchase Date "),i(27,"span",13),o(28,"*"),r()(),u(29,"input",21),_(30,_t,2,0,"div",18),r(),i(31,"div",10)(32,"label",22),u(33,"i",23),o(34," Invoice Number "),i(35,"span",13),o(36,"*"),r()(),u(37,"input",24),_(38,Pt,2,0,"div",18),r(),i(39,"div",10)(40,"label",25),u(41,"i",26),o(42," Packaging & Forwarding Charges "),i(43,"span",13),o(44,"*"),r()(),i(45,"div",27)(46,"span",28),o(47,"\u20B9"),r(),u(48,"input",29),r(),_(49,bt,2,0,"div",18),r()()(),i(50,"div",30)(51,"div",31)(52,"h3"),u(53,"i",32),o(54," Products"),r(),i(55,"button",33),P("click",function(){return n.addProduct()}),u(56,"i",34),o(57," Add Product "),r()(),i(58,"div",35)(59,"table",36)(60,"thead")(61,"tr")(62,"th"),o(63,"Product Name"),r(),i(64,"th"),o(65,"Quantity"),r(),i(66,"th"),o(67,"Batch Number"),r(),i(68,"th"),o(69,"Rate"),r(),i(70,"th"),o(71,"Price"),r(),i(72,"th"),o(73,"Tax Amount"),r(),i(74,"th"),o(75,"Remarks"),r(),i(76,"th"),o(77,"Actions"),r()()(),i(78,"tbody"),_(79,Ot,33,22,"tr",37),r()()()(),i(80,"button",33),P("click",function(){return n.addProduct()}),u(81,"i",34),o(82," Add Product "),r(),i(83,"div",38)(84,"div",39)(85,"span"),o(86,"Total Products:"),r(),i(87,"strong"),o(88),r()(),i(89,"div",39)(90,"span"),o(91,"Total Price:"),r(),i(92,"strong"),o(93),k(94,"number"),r()(),i(95,"div",39)(96,"span"),o(97,"Total Tax Amount:"),r(),i(98,"strong"),o(99),k(100,"number"),r()(),i(101,"div",39)(102,"span"),o(103,"Packaging & Forwarding Charges:"),r(),i(104,"strong"),o(105),k(106,"number"),r()(),i(107,"div",40)(108,"span"),o(109,"Grand Total:"),r(),i(110,"strong"),o(111),k(112,"number"),r()()(),i(113,"div",41)(114,"button",42),P("click",function(){return n.resetForm()}),u(115,"i",43),o(116," Reset "),r(),i(117,"button",44),u(118,"i",17),o(119),r()()()()(),_(120,yt,1,0,"app-loader",45)),t&2){let c;s(9),d("formGroup",n.purchaseForm),s(10),w("is-invalid",n.isFieldInvalid("customerId")),d("options",n.customers)("placeholder","Select Customer")("searchPlaceholder","Search customers..."),s(),d("disabled",n.isLoadingCustomers),s(),d("ngClass",n.isLoadingCustomers?"fa-spinner fa-spin":"fa-sync-alt"),s(),d("ngIf",n.isFieldInvalid("customerId")),s(7),w("is-invalid",n.isFieldInvalid("purchaseDate")),s(),d("ngIf",n.isFieldInvalid("purchaseDate")),s(7),w("is-invalid",n.isFieldInvalid("invoiceNumber")),s(),d("ngIf",n.isFieldInvalid("invoiceNumber")),s(10),w("is-invalid",n.isFieldInvalid("packagingAndForwadingCharges")),s(),d("ngIf",n.isFieldInvalid("packagingAndForwadingCharges")),s(30),d("ngForOf",n.productsFormArray.controls),s(9),M(n.productsFormArray.length),s(5),S("\u20B9",I(94,29,n.totalAmount,"1.2-2"),""),s(6),S("\u20B9",I(100,32,n.totalTaxAmount,"1.2-2"),""),s(6),S("\u20B9",I(106,35,((c=n.purchaseForm.get("packagingAndForwadingCharges"))==null?null:c.value)||0,"1.2-2"),""),s(6),S("\u20B9",I(112,38,n.grandTotal,"1.2-2"),""),s(3),d("disabled",n.loading),s(3),d("disabled",n.purchaseForm.invalid||n.loading),s(),d("ngClass",n.loading?"fa-spinner fa-spin":"fa-save"),s(),S(" ",n.loading?"Saving...":"Save Purchase"," "),s(),d("ngIf",n.loading)}},dependencies:[ne,H,N,D,te,ce,L,R,re,T,V,ae,q,z,ie,oe,G,se,X,Z],styles:[".add-purchase-container[_ngcontent-%COMP%]{padding:2rem;margin:0 auto}@media (max-width: 768px){.add-purchase-container[_ngcontent-%COMP%]{padding:1rem}}.select-group[_ngcontent-%COMP%]{position:relative;display:flex;align-items:center;gap:.5rem;width:100%;overflow:visible}.select-group[_ngcontent-%COMP%]   app-searchable-select[_ngcontent-%COMP%]{display:block;flex:1;position:relative;z-index:100;overflow:visible}.select-group[_ngcontent-%COMP%]   app-searchable-select.custom-width[_ngcontent-%COMP%]{position:absolute;z-index:1000;left:0}.select-group[_ngcontent-%COMP%]   app-searchable-select[_ngcontent-%COMP%]:focus-within{z-index:1000;position:relative}.select-group[_ngcontent-%COMP%]   app-searchable-select[_ngcontent-%COMP%]:focus-within     .select-dropdown{z-index:1001!important;position:absolute!important}.select-group[_ngcontent-%COMP%]   app-searchable-select[_ngcontent-%COMP%]     .select-dropdown{z-index:1001!important;position:absolute!important}.select-group[_ngcontent-%COMP%]   .refresh[_ngcontent-%COMP%]{flex-shrink:0;margin-top:0;height:40px;min-width:40px;display:flex;align-items:center;justify-content:center;position:relative;z-index:1;border:1px solid var(--supporting);border-radius:8px;background:#fff;transition:all .3s ease;color:var(--primary);touch-action:manipulation}.select-group[_ngcontent-%COMP%]   .refresh[_ngcontent-%COMP%]:hover:not(:disabled){background:var(--primary);color:#fff}.select-group[_ngcontent-%COMP%]   .refresh[_ngcontent-%COMP%]:disabled{opacity:.6;cursor:not-allowed}.select-group[_ngcontent-%COMP%]   .refresh[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{font-size:1rem}.form-control[_ngcontent-%COMP%]{height:40px}.back-btn[_ngcontent-%COMP%]{margin-bottom:1rem}.form-card[_ngcontent-%COMP%]{background:#fff;border-radius:var(--border-radius);box-shadow:var(--card-shadow);overflow:hidden}.card-header[_ngcontent-%COMP%]{background-color:var(--primary);padding:1.5rem}.card-header[_ngcontent-%COMP%]   .form-title[_ngcontent-%COMP%]{color:#fff;margin:0;font-size:1.5rem;font-weight:500;display:flex;align-items:center;gap:.5rem}.purchase-form[_ngcontent-%COMP%]{padding:2rem}@media (max-width: 768px){.purchase-form[_ngcontent-%COMP%]{padding:1rem}}.header-section[_ngcontent-%COMP%]{background-color:var(--background-light);border-radius:var(--border-radius);padding:1.5rem;margin-bottom:2rem;position:relative}.header-section[_ngcontent-%COMP%]   .form-row[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1.5rem}@media (max-width: 768px){.header-section[_ngcontent-%COMP%]   .form-row[_ngcontent-%COMP%]{grid-template-columns:1fr}}.products-section[_ngcontent-%COMP%]{background-color:#fff;border-radius:var(--border-radius);padding:1.5rem;margin-top:2rem;border:1px solid var(--primary)}.products-section[_ngcontent-%COMP%]   .products-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem}.products-section[_ngcontent-%COMP%]   .products-header[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0;color:var(--text-primary);font-size:1.25rem;display:flex;align-items:center;gap:.5rem}.products-section[_ngcontent-%COMP%]   .products-header[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{color:var(--primary)}.product-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:2fr 1fr 1fr 1fr 1fr 1fr auto;gap:1rem;align-items:start}@media (max-width: 1200px){.product-grid[_ngcontent-%COMP%]{grid-template-columns:repeat(3,1fr)}}@media (max-width: 768px){.product-grid[_ngcontent-%COMP%]{grid-template-columns:1fr}}.remove-product[_ngcontent-%COMP%]{background-color:var(--danger-light);color:var(--danger);border:none;width:36px;height:36px;border-radius:var(--border-radius);display:flex;align-items:center;justify-content:center;transition:all .3s ease}.remove-product[_ngcontent-%COMP%]:hover:not(:disabled){background-color:var(--danger);color:#fff;transform:translateY(-1px)}.remove-product[_ngcontent-%COMP%]:disabled{opacity:.5;cursor:not-allowed}@media (max-width: 768px){.remove-product[_ngcontent-%COMP%]{position:absolute;top:1rem;right:1rem}}.form-group[_ngcontent-%COMP%]{margin-bottom:1rem;position:relative}.form-group[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem;color:var(--text-primary);font-weight:500}.form-group[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{color:var(--primary)}.form-group[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]   .required[_ngcontent-%COMP%]{color:var(--danger);margin-left:4px}.input-group[_ngcontent-%COMP%]{display:flex;align-items:stretch}.input-group[_ngcontent-%COMP%]   .input-group-text[_ngcontent-%COMP%]{background-color:var(--background);border:1px solid var(--border-color);border-right:none;border-radius:var(--border-radius) 0 0 var(--border-radius);height:38px;color:var(--text-secondary);min-width:40px;display:flex;align-items:center;justify-content:center}.input-group[_ngcontent-%COMP%]   .form-control[_ngcontent-%COMP%]{border-radius:0 var(--border-radius) var(--border-radius) 0;flex:1}.purchase-summary[_ngcontent-%COMP%]{background-color:var(--background-light);border-radius:var(--border-radius);padding:1.5rem;margin-top:2rem;display:flex;justify-content:flex-end;gap:2rem;flex-wrap:wrap}.purchase-summary[_ngcontent-%COMP%]   .summary-item[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.75rem}.purchase-summary[_ngcontent-%COMP%]   .summary-item[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{color:var(--text-secondary);font-size:.875rem}.purchase-summary[_ngcontent-%COMP%]   .summary-item[_ngcontent-%COMP%]   strong[_ngcontent-%COMP%]{color:var(--text-primary);font-size:1.25rem;font-weight:600}.form-actions[_ngcontent-%COMP%]{display:flex;justify-content:space-between;gap:1rem;margin-top:2rem;padding-top:1.5rem;border-top:1px solid var(--border-color)}@media (max-width: 576px){.form-actions[_ngcontent-%COMP%]{flex-direction:column}.form-actions[_ngcontent-%COMP%]   .btn[_ngcontent-%COMP%]{width:100%}}.table-responsive[_ngcontent-%COMP%]{margin:0 -1.5rem;padding:0 1.5rem;overflow-x:auto;min-height:400px;-webkit-overflow-scrolling:touch}@media (max-width: 768px){.table-responsive[_ngcontent-%COMP%]{margin:0 -1rem;padding:0 1rem}}.products-table[_ngcontent-%COMP%]{width:100%;margin-bottom:0;background:#fff;border-collapse:separate;border-spacing:0}.products-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{background-color:var(--background-light);color:var(--text-primary);font-weight:600;padding:1rem;white-space:nowrap;border-bottom:2px solid var(--border-color)}.products-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]:first-child{width:30%;min-width:300px}.products-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]:nth-child(4){width:10%;max-width:120px}.products-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{padding:.75rem 1rem;vertical-align:middle;border-bottom:1px solid var(--border-color)}.products-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]   .form-control[_ngcontent-%COMP%]{min-width:80px}.products-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]:first-child{width:30%;min-width:300px}.products-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]:first-child   .form-control[_ngcontent-%COMP%]{min-width:300px}.products-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]:nth-child(4){width:10%;max-width:120px}.products-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]:nth-child(4)   .form-control[_ngcontent-%COMP%]{min-width:100px;max-width:120px}.products-table[_ngcontent-%COMP%]   .input-group[_ngcontent-%COMP%]{flex-wrap:nowrap}.products-table[_ngcontent-%COMP%]   .btn-icon[_ngcontent-%COMP%]{margin:0 auto}@media (max-width: 768px){.products-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%], .products-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{padding:.5rem}}.form-field-container[_ngcontent-%COMP%]{position:relative;margin-bottom:1rem;overflow:visible}.form-field-container[_ngcontent-%COMP%]   .form-control.is-invalid[_ngcontent-%COMP%], .form-field-container[_ngcontent-%COMP%]   .input-group.is-invalid[_ngcontent-%COMP%]{border-color:var(--danger);background-image:url(data:image/svg+xml,...)}.products-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{padding-bottom:1.5rem;vertical-align:top}.invalid-feedback[_ngcontent-%COMP%]{color:var(--danger);font-size:.75rem;margin-top:.25rem;animation:_ngcontent-%COMP%_fadeIn .3s ease-in}@keyframes _ngcontent-%COMP%_fadeIn{0%{opacity:0;transform:translateY(-5px)}to{opacity:1;transform:translateY(0)}}"],changeDetection:0})}}return a})();function St(a,m){if(a&1&&(i(0,"div",14)(1,"div",15)(2,"span"),o(3,"Invoice"),r(),i(4,"strong"),o(5),r()(),i(6,"div",15)(7,"span"),o(8,"Purchase Date"),r(),i(9,"strong"),o(10),k(11,"date"),r()(),i(12,"div",15)(13,"span"),o(14,"Total Amount"),r(),i(15,"strong"),o(16),k(17,"number"),r()()()),a&2){let e=p();s(5),M(e.purchaseDetails.invoiceNumber),s(5),M(I(11,3,e.purchaseDetails.purchaseDate,"dd-MM-yyyy")),s(6),M(I(17,6,e.purchaseDetails.totalAmount,"1.2-2"))}}function wt(a,m){if(a&1&&(i(0,"div",39),o(1),r()),a&2){let e,t=p().$implicit;s(),S(" QC pass must be between 0 and ",(e=t.get("quantity"))==null?null:e.value," ")}}function kt(a,m){a&1&&(i(0,"span",40),u(1,"i",41),r())}function It(a,m){if(a&1){let e=y();i(0,"tr",28)(1,"td"),o(2),r(),i(3,"td")(4,"div",29)(5,"div",30),o(6),r()()(),i(7,"td")(8,"span",31),o(9),r()(),i(10,"td")(11,"span",32),o(12),r()(),i(13,"td")(14,"div",33)(15,"input",34),P("blur",function(){let n=b(e).index,c=p(4);return C(c.onQcPassBlur(n))})("keydown",function(n){let c=b(e).index,l=p(4);return C(l.onQcPassKeydown(n,c))}),r(),_(16,wt,2,1,"div",35),r()(),i(17,"td")(18,"div",36),o(19),r()(),i(20,"td")(21,"div",37)(22,"span",21),o(23),r(),_(24,kt,2,0,"span",38),r()()()}if(a&2){let e,t,n,c,l,g,h=m.$implicit,v=m.index,E=p(4);d("formGroupName",v),s(2),M(v+1),s(4),S(" ",((e=h.get("productName"))==null?null:e.value)||"N/A"," "),s(3),M((t=h.get("quantity"))==null?null:t.value),s(3),M(((n=h.get("batchNumber"))==null?null:n.value)||"-"),s(3),d("max",(c=h.get("quantity"))==null?null:c.value),s(),d("ngIf",E.isQcPassInvalid(v)),s(3),S(" ",((l=h.get("remarks"))==null?null:l.value)||"-"," "),s(3),w("pass",E.isItemQcPassed(h))("pending",!E.isItemQcPassed(h)),s(),S(" ",E.isItemQcPassed(h)?"Pass":"Pending"," "),s(),d("ngIf",E.savingItemId===((g=h.get("purchaseItemId"))==null?null:g.value))}}function Et(a,m){if(a&1&&(i(0,"div",24)(1,"div",25)(2,"table",26)(3,"thead")(4,"tr")(5,"th"),o(6,"No"),r(),i(7,"th"),o(8,"Product Name"),r(),i(9,"th"),o(10,"Quantity"),r(),i(11,"th"),o(12,"Batch Number"),r(),i(13,"th"),o(14,"QC Pass"),r(),i(15,"th"),o(16,"Remarks"),r(),i(17,"th"),o(18,"Status"),r()()(),i(19,"tbody"),_(20,It,25,14,"tr",27),r()()()()),a&2){let e=p(3);s(20),d("ngForOf",e.itemsFormArray.controls)}}function Ft(a,m){a&1&&(i(0,"div",42),u(1,"i",43),i(2,"p"),o(3,"No items found for this purchase."),r()())}function At(a,m){if(a&1){let e=y();i(0,"div",17)(1,"div",18)(2,"div",19)(3,"div",20)(4,"span"),o(5,"Total Items"),r(),i(6,"strong"),o(7),r()(),i(8,"div",20)(9,"span"),o(10,"QC Status"),r(),i(11,"span",21),o(12),r()()()(),i(13,"form",22),P("ngSubmit",function(n){b(e);let c=p(2);return C(c.onFormSubmit(n))}),_(14,Et,21,1,"div",23)(15,Ft,4,0,"ng-template",null,2,Y),r()()}if(a&2){let e=B(16),t=p(2);s(7),M(t.itemsFormArray.length),s(4),w("pass",t.isAllQcPassed)("pending",!t.isAllQcPassed),s(),S(" ",t.isAllQcPassed?"All Passed":"Pending"," "),s(),d("formGroup",t.qcForm),s(),d("ngIf",t.itemsFormArray.length>0)("ngIfElse",e)}}function Nt(a,m){if(a&1&&(fe(0),_(1,At,17,9,"div",16),_e()),a&2){let e=p(),t=B(17);s(),d("ngIf",e.purchaseDetails)("ngIfElse",t)}}function Dt(a,m){a&1&&(i(0,"div",44),u(1,"i",41),i(2,"span"),o(3,"Loading purchase details..."),r()())}function Rt(a,m){a&1&&(i(0,"div",42),u(1,"i",45),i(2,"p"),o(3,"Purchase details not available."),r()())}var Je=(()=>{class a{constructor(e,t,n,c,l,g){this.fb=e,this.route=t,this.purchaseService=n,this.productService=c,this.snackbar=l,this.encryptionService=g,this.isLoading=!1,this.isSaving=!1,this.products=[],this.savingItemId=null,this.destroy$=new F,this.qcForm=this.fb.group({items:this.fb.array([])})}get itemsFormArray(){return this.qcForm.get("items")}ngOnInit(){let e=this.route.snapshot.paramMap.get("id");if(!e){this.snackbar.error("Invalid purchase id");return}let t=this.encryptionService.decrypt(e),n=t?Number(t):NaN;if(!n||isNaN(n)){this.snackbar.error("Invalid purchase id");return}this.loadProducts(),this.loadPurchaseDetails(n)}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete()}loadProducts(){this.productService.getProducts({status:"A"}).pipe(x(this.destroy$)).subscribe({next:e=>{e?.success&&e.data&&(this.products=e.data.content||e.data),this.mapProductNames()},error:()=>{this.snackbar.error("Failed to load products")}})}loadPurchaseDetails(e){this.isLoading=!0,this.purchaseService.getPurchaseDetails(e).pipe(x(this.destroy$)).subscribe({next:t=>{this.purchaseDetails=t;let n=t.items||[];this.buildItemsForm(n),this.isLoading=!1},error:t=>{this.snackbar.error(t?.error?.message||"Failed to load purchase details"),this.isLoading=!1}})}buildItemsForm(e){this.itemsFormArray.clear(),e.forEach(t=>{let n=this.fb.group({purchaseItemId:[t.id],productId:[t.productId],productName:[null],quantity:[t.quantity],batchNumber:[t.batchNumber],qcPass:[t.qcPass,[O.min(0),O.max(t.quantity)]],remarks:[t.remarks]});this.itemsFormArray.push(n)}),this.mapProductNames()}mapProductNames(){!this.products||this.products.length===0||this.itemsFormArray.controls.forEach(e=>{let t=e.get("productId")?.value;if(t){let n=this.products.find(c=>c.id===t);n&&e.get("productName")?.setValue(n.name,{emitEvent:!1})}})}get isAllQcPassed(){return!this.itemsFormArray||this.itemsFormArray.length===0?!1:this.itemsFormArray.controls.every(e=>{let t=Number(e.get("quantity")?.value||0),c=e.get("qcPass")?.value;if(c===null||c==="")return!1;let l=Number(c);return!isNaN(l)&&l<=t})}isItemQcPassed(e){if(!e)return!1;let t=Number(e.get("quantity")?.value||0),c=e.get("qcPass")?.value;if(c===null||c==="")return!1;let l=Number(c);return!isNaN(l)&&l<=t}isQcPassInvalid(e){let t=this.itemsFormArray.at(e).get("qcPass");return!!(t&&t.invalid&&(t.dirty||t.touched))}onQcPassBlur(e){this.updateQcPass(e)}onQcPassKeydown(e,t){e.key==="Enter"&&(e.preventDefault(),this.updateQcPass(t))}onFormSubmit(e){e.preventDefault()}updateQcPass(e){let t=this.itemsFormArray.at(e),n=t.get("purchaseItemId")?.value,c=Number(t.get("quantity")?.value||0),l=t.get("qcPass"),g=l?.value;if(!n){this.snackbar.error("purchaseItemId is required");return}if(g===null||g===""||g===void 0){if(this.savingItemId===n)return;this.isSaving=!0,this.savingItemId=n,this.purchaseService.updateQcPass({purchaseItemId:n,qcPass:null}).pipe(x(this.destroy$)).subscribe({next:v=>{v?.success?this.snackbar.success(v.message||"QC pass updated successfully"):this.snackbar.error(v?.message||"Failed to update QC pass"),this.isSaving=!1,this.savingItemId=null},error:v=>{let E=v?.error?.message||"Failed to update QC pass";this.snackbar.error(E),this.isSaving=!1,this.savingItemId=null}});return}let h=Number(g);if(isNaN(h)||h<0){this.snackbar.error("QC pass quantity cannot be negative"),l?.setValue(null);return}if(h>c){this.snackbar.error("QC pass quantity cannot exceed ordered quantity"),l?.setValue(c);return}this.savingItemId!==n&&(this.isSaving=!0,this.savingItemId=n,this.purchaseService.updateQcPass({purchaseItemId:n,qcPass:h}).pipe(x(this.destroy$)).subscribe({next:v=>{v?.success?this.snackbar.success(v.message||"QC pass updated successfully"):this.snackbar.error(v?.message||"Failed to update QC pass"),this.isSaving=!1,this.savingItemId=null},error:v=>{let E=v?.error?.message||"Failed to update QC pass";this.snackbar.error(E),this.isSaving=!1,this.savingItemId=null}}))}static{this.\u0275fac=function(t){return new(t||a)(f(j),f(Me),f(U),f(de),f($),f(Q))}}static{this.\u0275cmp=A({type:a,selectors:[["app-qc-purchase"]],decls:18,vars:8,consts:[["loadingTpl",""],["emptyPurchaseTpl",""],["noItemsTpl",""],[1,"qc-purchase-container"],["routerLink","/purchase",1,"btn","btn-sm","btn-secondary","back-btn"],[1,"fas","fa-arrow-left"],[1,"form-card"],[1,"card-header"],[1,"header-main"],[1,"form-title"],[1,"fas","fa-clipboard-check"],[1,"status-chip","header-status"],["class","purchase-meta",4,"ngIf"],[4,"ngIf","ngIfElse"],[1,"purchase-meta"],[1,"meta-item"],["class","qc-content",4,"ngIf","ngIfElse"],[1,"qc-content"],[1,"qc-summary"],[1,"summary-row"],[1,"summary-item"],[1,"status-chip"],["novalidate","",1,"qc-form",3,"ngSubmit","formGroup"],["class","products-section","formArrayName","items",4,"ngIf","ngIfElse"],["formArrayName","items",1,"products-section"],[1,"table-responsive"],[1,"table","products-table"],[3,"formGroupName",4,"ngFor","ngForOf"],[3,"formGroupName"],[1,"product-cell"],[1,"product-name"],[1,"quantity"],[1,"batch"],[1,"form-field-container"],["type","number","formControlName","qcPass","min","0","step","0.01","inputmode","decimal",1,"form-control",3,"blur","keydown","max"],["class","invalid-feedback",4,"ngIf"],[1,"remarks-cell"],[1,"status-cell"],["class","saving-indicator",4,"ngIf"],[1,"invalid-feedback"],[1,"saving-indicator"],[1,"fas","fa-spinner","fa-spin"],[1,"empty-state"],[1,"fas","fa-box-open"],[1,"loading-state"],[1,"fas","fa-file-invoice"]],template:function(t,n){if(t&1&&(i(0,"div",3)(1,"button",4),u(2,"i",5),o(3," Back to Purchases "),r(),i(4,"div",6)(5,"div",7)(6,"div",8)(7,"h2",9),u(8,"i",10),o(9," Purchase QC "),r(),i(10,"span",11),o(11),r()(),_(12,St,18,9,"div",12),r(),_(13,Nt,2,2,"ng-container",13),r()(),_(14,Dt,4,0,"ng-template",null,0,Y)(16,Rt,4,0,"ng-template",null,1,Y)),t&2){let c=B(15);s(10),w("pass",n.isAllQcPassed)("pending",!n.isAllQcPassed),s(),S(" ",n.isAllQcPassed?"All Passed":"Pending"," "),s(),d("ngIf",n.purchaseDetails),s(),d("ngIf",!n.isLoading)("ngIfElse",c)}},dependencies:[N,D,L,R,re,T,V,ae,xe,q,z,ie,oe,se,te,W],styles:[".qc-purchase-container[_ngcontent-%COMP%]{padding:2rem;margin:0 auto}@media (max-width: 768px){.qc-purchase-container[_ngcontent-%COMP%]{padding:1rem}}.back-btn[_ngcontent-%COMP%]{margin-bottom:1rem}.form-card[_ngcontent-%COMP%]{background:#fff;border-radius:var(--border-radius);box-shadow:var(--card-shadow);overflow:hidden}.card-header[_ngcontent-%COMP%]{background-color:var(--primary);padding:1.5rem;display:flex;flex-direction:column;gap:.75rem}.card-header[_ngcontent-%COMP%]   .header-main[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:space-between;gap:1rem}.card-header[_ngcontent-%COMP%]   .form-title[_ngcontent-%COMP%]{color:#fff;margin:0;font-size:1.5rem;font-weight:500;display:flex;align-items:center;gap:.5rem}.card-header[_ngcontent-%COMP%]   .form-title[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{color:#fff}.card-header[_ngcontent-%COMP%]   .purchase-meta[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap;gap:1.5rem}.card-header[_ngcontent-%COMP%]   .purchase-meta[_ngcontent-%COMP%]   .meta-item[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.25rem}.card-header[_ngcontent-%COMP%]   .purchase-meta[_ngcontent-%COMP%]   .meta-item[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{color:#fffc;font-size:.85rem}.card-header[_ngcontent-%COMP%]   .purchase-meta[_ngcontent-%COMP%]   .meta-item[_ngcontent-%COMP%]   strong[_ngcontent-%COMP%]{color:#fff;font-size:1rem}.qc-content[_ngcontent-%COMP%]{padding:1.5rem 2rem 2rem}@media (max-width: 768px){.qc-content[_ngcontent-%COMP%]{padding:1rem}}.qc-summary[_ngcontent-%COMP%]{background-color:var(--background-light);border-radius:var(--border-radius);padding:1rem 1.5rem;margin-bottom:1.5rem}.qc-summary[_ngcontent-%COMP%]   .summary-row[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap;gap:1.5rem;align-items:center}.qc-summary[_ngcontent-%COMP%]   .summary-row[_ngcontent-%COMP%]   .summary-item[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.75rem}.qc-summary[_ngcontent-%COMP%]   .summary-row[_ngcontent-%COMP%]   .summary-item[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]:first-child{color:var(--text-secondary);font-size:.9rem}.qc-summary[_ngcontent-%COMP%]   .summary-row[_ngcontent-%COMP%]   .summary-item[_ngcontent-%COMP%]   strong[_ngcontent-%COMP%]{color:var(--text-primary);font-size:1.1rem;font-weight:600}.status-chip[_ngcontent-%COMP%]{display:inline-flex;align-items:center;justify-content:center;padding:.25rem .75rem;border-radius:999px;font-size:.8rem;font-weight:600;letter-spacing:.02em;text-transform:uppercase}.status-chip.header-status[_ngcontent-%COMP%]{background-color:#ffffff26;color:#fff}.status-chip.pass[_ngcontent-%COMP%]{background-color:#28a74526;color:#28a745}.status-chip.pending[_ngcontent-%COMP%]{background-color:#ffc10726;color:#ffc107}.qc-form[_ngcontent-%COMP%]{width:100%}.products-section[_ngcontent-%COMP%]{background-color:#fff;border-radius:var(--border-radius);padding:1.5rem 1.5rem 1rem;border:1px solid var(--primary)}.table-responsive[_ngcontent-%COMP%]{margin:0 -1.5rem;padding:0 1.5rem;overflow-x:auto;min-height:300px;-webkit-overflow-scrolling:touch}@media (max-width: 768px){.table-responsive[_ngcontent-%COMP%]{margin:0 -1rem;padding:0 1rem}}.products-table[_ngcontent-%COMP%]{width:100%;margin-bottom:0;background:#fff;border-collapse:separate;border-spacing:0}.products-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{background-color:var(--background-light);color:var(--text-primary);font-weight:600;padding:.75rem 1rem;white-space:nowrap;border-bottom:2px solid var(--border-color)}.products-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{padding:.75rem 1rem;vertical-align:middle;border-bottom:1px solid var(--border-color)}.products-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]:first-child{white-space:nowrap;width:1%}@media (max-width: 768px){.products-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%], .products-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{padding:.5rem}}.product-cell[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.15rem}.product-cell[_ngcontent-%COMP%]   .product-name[_ngcontent-%COMP%]{font-weight:500;color:var(--text-primary)}.product-cell[_ngcontent-%COMP%]   .product-id[_ngcontent-%COMP%]{font-size:.75rem;color:var(--text-secondary)}.quantity[_ngcontent-%COMP%], .batch[_ngcontent-%COMP%]{font-weight:500;color:var(--text-primary)}.remarks-cell[_ngcontent-%COMP%]{max-width:220px;font-size:.9rem;color:var(--text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.form-field-container[_ngcontent-%COMP%]{position:relative}.form-field-container[_ngcontent-%COMP%]   .form-control[_ngcontent-%COMP%]{height:40px;min-width:120px}.form-field-container[_ngcontent-%COMP%]   .invalid-feedback[_ngcontent-%COMP%]{color:var(--danger);font-size:.75rem;margin-top:.25rem}.status-cell[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem}.status-cell[_ngcontent-%COMP%]   .saving-indicator[_ngcontent-%COMP%]{color:var(--primary);font-size:.9rem}.loading-state[_ngcontent-%COMP%], .empty-state[_ngcontent-%COMP%]{padding:2rem;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:.75rem;color:var(--text-secondary);text-align:center}.loading-state[_ngcontent-%COMP%]   i[_ngcontent-%COMP%], .empty-state[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{font-size:2rem;color:var(--primary)}@media (max-width: 576px){.card-header[_ngcontent-%COMP%]{padding:1.25rem}.card-header[_ngcontent-%COMP%]   .header-main[_ngcontent-%COMP%]{flex-direction:column;align-items:flex-start;gap:.5rem}.products-section[_ngcontent-%COMP%]{padding:1rem 1rem .75rem}.form-field-container[_ngcontent-%COMP%]   .form-control[_ngcontent-%COMP%]{min-width:100px}}"]})}}return a})();function Tt(a,m){if(a&1&&(i(0,"div",13)(1,"div",14)(2,"span"),o(3,"Invoice"),r(),i(4,"strong"),o(5),r()(),i(6,"div",14)(7,"span"),o(8,"Purchase Date"),r(),i(9,"strong"),o(10),k(11,"date"),r()(),i(12,"div",14)(13,"span"),o(14,"Customer"),r(),i(15,"strong"),o(16),r()()()),a&2){let e=p();s(5),M(e.purchaseDetails.invoiceNumber),s(5),M(I(11,3,e.purchaseDetails.purchaseDate,"dd-MM-yyyy")),s(6),M(e.purchaseDetails.customerName)}}function Vt(a,m){a&1&&(i(0,"div",40),o(1," Packaging and forwarding charges is required and must be 0 or greater "),r())}function Lt(a,m){if(a&1&&(i(0,"div",40),o(1),r()),a&2){let e=p().$implicit,t=p(4);s(),S(" Return quantity must be between 0 and ",t.getMaxReturnQuantity(e)," ")}}function qt(a,m){a&1&&(i(0,"div",40),o(1," Return not allowed: available return quantity is 0 "),r())}function zt(a,m){if(a&1&&(i(0,"tr",45)(1,"td"),o(2),r(),i(3,"td")(4,"div",46)(5,"div",47),o(6),r()()(),i(7,"td")(8,"span",48),o(9),r()(),i(10,"td")(11,"span",49),o(12),r()(),i(13,"td")(14,"span",48),o(15),r()(),i(16,"td")(17,"div",50),u(18,"input",51),_(19,Lt,2,1,"div",33)(20,qt,2,0,"div",33),r()(),i(21,"td")(22,"div",50),u(23,"input",52),r()()()),a&2){let e,t,n,c,l=m.$implicit,g=m.index,h=p(4);d("formGroupName",g),s(2),M(g+1),s(4),S(" ",((e=l.get("productName"))==null?null:e.value)||"N/A"," "),s(3),M((t=l.get("quantity"))==null?null:t.value),s(3),M(((n=l.get("batchNumber"))==null?null:n.value)||"-"),s(3),M((c=(c=l.get("qcPass"))==null?null:c.value)!==null&&c!==void 0?c:0),s(3),d("max",h.getMaxReturnQuantity(l))("disabled",h.getMaxReturnQuantity(l)<=0),s(),d("ngIf",h.isReturnQuantityInvalid(g)),s(),d("ngIf",h.getMaxReturnQuantity(l)<=0)}}function jt(a,m){if(a&1&&(i(0,"div",41)(1,"div",42)(2,"table",43)(3,"thead")(4,"tr")(5,"th"),o(6,"No"),r(),i(7,"th"),o(8,"Product Name"),r(),i(9,"th"),o(10,"Quantity"),r(),i(11,"th"),o(12,"Batch Number"),r(),i(13,"th"),o(14,"QC Pass"),r(),i(15,"th"),o(16,"Purchase Return Quantity"),r(),i(17,"th"),o(18,"Remarks"),r()()(),i(19,"tbody"),_(20,zt,24,10,"tr",44),r()()()()),a&2){let e=p(3);s(20),d("ngForOf",e.itemsFormArray.controls)}}function Qt(a,m){a&1&&(i(0,"div",53),u(1,"i",54),i(2,"p"),o(3,"No items found for this purchase."),r()())}function $t(a,m){if(a&1){let e=y();i(0,"div",16)(1,"form",17),P("ngSubmit",function(){b(e);let n=p(2);return C(n.onSubmit())}),i(2,"div",18)(3,"div",19)(4,"div",20)(5,"label",21),u(6,"i",22),o(7," Purchase Return Date "),r(),u(8,"input",23),r(),i(9,"div",20)(10,"label",24),u(11,"i",25),o(12," Return Invoice Number "),r(),u(13,"input",26),r(),i(14,"div",20)(15,"label",27),u(16,"i",28),o(17," Packaging & Forwarding Charges "),i(18,"span",29),o(19,"*"),r()(),i(20,"div",30)(21,"span",31),o(22,"\u20B9"),r(),u(23,"input",32),r(),_(24,Vt,2,0,"div",33),r()()(),_(25,jt,21,1,"div",34)(26,Qt,4,0,"ng-template",null,2,Y),i(28,"div",35)(29,"div",36)(30,"span"),o(31,"Total Return Quantity"),r(),i(32,"strong"),o(33),k(34,"number"),r()()(),i(35,"div",37)(36,"button",38),u(37,"i",39),o(38),r()()()()}if(a&2){let e,t,n=B(27),c=p(2);s(),d("formGroup",c.returnForm),s(22),w("is-invalid",((e=c.returnForm.get("packagingAndForwadingCharges"))==null?null:e.invalid)&&((e=c.returnForm.get("packagingAndForwadingCharges"))==null?null:e.touched)),s(),d("ngIf",((t=c.returnForm.get("packagingAndForwadingCharges"))==null?null:t.invalid)&&((t=c.returnForm.get("packagingAndForwadingCharges"))==null?null:t.touched)),s(),d("ngIf",c.itemsFormArray.length>0)("ngIfElse",n),s(8),M(I(34,10,c.getTotalReturnQuantity(),"1.2-2")),s(3),d("disabled",c.returnForm.invalid||c.isSaving),s(),d("ngClass",c.isSaving?"fa-spinner fa-spin":"fa-save"),s(),S(" ",c.isSaving?"Saving...":"Save Purchase Return"," ")}}function Ut(a,m){if(a&1&&(fe(0),_(1,$t,39,13,"div",15),_e()),a&2){let e=p(),t=B(15);s(),d("ngIf",e.purchaseDetails)("ngIfElse",t)}}function Gt(a,m){a&1&&(i(0,"div",55),u(1,"i",56),i(2,"span"),o(3,"Loading purchase details..."),r()())}function Bt(a,m){a&1&&(i(0,"div",53),u(1,"i",25),i(2,"p"),o(3,"Purchase details not available."),r()())}var Xe=(()=>{class a{constructor(e,t,n,c,l,g,h){this.fb=e,this.route=t,this.router=n,this.purchaseService=c,this.productService=l,this.snackbar=g,this.encryptionService=h,this.isLoading=!1,this.isSaving=!1,this.products=[],this.destroy$=new F,this.returnForm=this.fb.group({purchaseId:[null],customerId:[null],purchaseReturnDate:[K(new Date,"yyyy-MM-dd","en"),O.required],invoiceNumber:[""],packagingAndForwadingCharges:[0,[O.required,O.min(0)]],items:this.fb.array([])})}get itemsFormArray(){return this.returnForm.get("items")}ngOnInit(){let e=this.route.snapshot.paramMap.get("id");if(!e){this.snackbar.error("Invalid purchase id");return}let t=this.encryptionService.decrypt(e),n=t?Number(t):NaN;if(!n||isNaN(n)){this.snackbar.error("Invalid purchase id");return}this.loadProducts(),this.loadPurchaseDetails(n)}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete(),this.products=[],this.purchaseDetails=null,this.returnForm&&this.returnForm.reset()}loadProducts(){this.productService.getProducts({status:"A"}).pipe(x(this.destroy$)).subscribe({next:e=>{e?.success&&e.data&&(this.products=e.data.content||e.data),this.mapProductNames()},error:()=>{this.snackbar.error("Failed to load products")}})}getMaxReturnQuantity(e){let t=Number(e.get("quantity")?.value||0),n=Number(e.get("qcPass")?.value||0),c=t-n;return isNaN(c)||c<0?0:c}loadPurchaseDetails(e){this.isLoading=!0,this.purchaseService.getPurchaseDetails(e,!0).pipe(x(this.destroy$)).subscribe({next:t=>{this.purchaseDetails=t,this.returnForm.patchValue({purchaseId:t.id,customerId:t.customerId,invoiceNumber:t.invoiceNumber?`PR-${t.invoiceNumber}`:"",isPurchaseReturn:!0,packagingAndForwadingCharges:t.packagingAndForwadingCharges||0});let n=t.items||[];this.buildItemsForm(n),t.purchaseReturns&&this.applyExistingPurchaseReturns(t.purchaseReturns),this.isLoading=!1},error:t=>{this.snackbar.error(t?.error?.message||"Failed to load purchase details"),this.isLoading=!1}})}buildItemsForm(e){this.itemsFormArray.clear(),e.forEach(t=>{let n=Number(t.quantity||0),c=Number(t.qcPass||0),l=Math.max(0,n-c),g=this.fb.group({purchaseItemId:[t.id],productId:[t.productId],productName:[null],quantity:[n],batchNumber:[t.batchNumber],qcPass:[c],unitPrice:[t.unitPrice],returnQuantity:[{value:null,disabled:l<=0},[O.min(0),O.max(l)]],remarks:[null]});this.itemsFormArray.push(g)}),this.mapProductNames()}applyExistingPurchaseReturns(e){if(!e)return;if(e.purchaseReturnDate){let n=K(e.purchaseReturnDate,"yyyy-MM-dd","en");this.returnForm.get("purchaseReturnDate")?.setValue(n)}e.invoiceNumber&&this.returnForm.get("invoiceNumber")?.setValue(e.invoiceNumber),e.packagingAndForwadingCharges!=null&&this.returnForm.get("packagingAndForwadingCharges")?.setValue(e.packagingAndForwadingCharges);let t=new Map;(e.items||[]).forEach(n=>{n&&n.purchaseItemId!=null&&t.set(n.purchaseItemId,n)}),this.itemsFormArray.controls.forEach(n=>{let c=n.get("purchaseItemId")?.value;if(!c)return;let l=t.get(c);l&&(l.quantity!=null&&n.get("returnQuantity")?.setValue(l.quantity,{emitEvent:!1}),l.unitPrice!=null&&n.get("unitPrice")?.setValue(l.unitPrice,{emitEvent:!1}),l.remarks!=null&&n.get("remarks")?.setValue(l.remarks,{emitEvent:!1}))})}mapProductNames(){!this.products||this.products.length===0||this.itemsFormArray.controls.forEach(e=>{let t=e.get("productId")?.value;if(t){let n=this.products.find(c=>c.id===t);n&&(e.get("productName")?.setValue(n.name,{emitEvent:!1}),!e.get("unitPrice")?.value&&n.unitPrice!=null&&e.get("unitPrice")?.setValue(n.unitPrice,{emitEvent:!1}))}})}isReturnQuantityInvalid(e){let t=this.itemsFormArray.at(e).get("returnQuantity");return!t||t.disabled?!1:!!t.invalid}getTotalReturnQuantity(){return this.itemsFormArray.controls.reduce((e,t)=>{let n=t.get("returnQuantity");if(!n||n.disabled)return e;let c=Number(n.value||0);return e+(isNaN(c)?0:c)},0)}onSubmit(){if(!this.purchaseDetails){this.snackbar.error("Purchase details not loaded");return}if(this.returnForm.invalid){this.returnForm.markAllAsTouched();return}let e=this.returnForm.getRawValue(),t=(e.items||[]).filter(l=>{let g=Number(l.returnQuantity||0);return!isNaN(g)&&g>0}).map(l=>({purchaseItemId:l.purchaseItemId,productId:l.productId,quantity:Number(l.returnQuantity),unitPrice:l.unitPrice,remarks:l.remarks}));if(!t.length){this.snackbar.error("Please enter at least one return quantity greater than 0");return}let c={id:this.purchaseDetails?.purchaseReturns?.id??null,purchaseId:e.purchaseId,customerId:e.customerId,purchaseReturnDate:K(e.purchaseReturnDate,"dd-MM-yyyy","en"),invoiceNumber:e.invoiceNumber,packagingAndForwadingCharges:Number(e.packagingAndForwadingCharges||0),products:t};this.isSaving=!0,this.purchaseService.createPurchaseReturn(c).pipe(x(this.destroy$)).subscribe({next:l=>{l?.success?(this.snackbar.success(l.message||"Purchase return created successfully"),this.router.navigate(["purchase/return"])):this.snackbar.error(l?.message||"Failed to create purchase return"),this.isSaving=!1},error:l=>{let g=l?.error?.message||"Failed to create purchase return";this.snackbar.error(g),this.isSaving=!1}})}static{this.\u0275fac=function(t){return new(t||a)(f(j),f(Me),f(J),f(U),f(de),f($),f(Q))}}static{this.\u0275cmp=A({type:a,selectors:[["app-add-purchase-return"]],decls:16,vars:3,consts:[["loadingTpl",""],["emptyPurchaseTpl",""],["noItemsTpl",""],[1,"add-purchase-container"],["routerLink","/purchase",1,"btn","btn-sm","btn-secondary","back-btn"],[1,"fas","fa-arrow-left"],[1,"form-card"],[1,"card-header"],[1,"header-main"],[1,"form-title"],[1,"fas","fa-undo-alt"],["class","purchase-meta",4,"ngIf"],[4,"ngIf","ngIfElse"],[1,"purchase-meta"],[1,"meta-item"],["class","qc-content",4,"ngIf","ngIfElse"],[1,"qc-content"],["novalidate","",1,"purchase-form",3,"ngSubmit","formGroup"],[1,"header-section"],[1,"form-row"],[1,"form-group"],["for","purchaseReturnDate"],[1,"fas","fa-calendar"],["type","date","id","purchaseReturnDate","formControlName","purchaseReturnDate",1,"form-control"],["for","invoiceNumber"],[1,"fas","fa-file-invoice"],["type","text","id","invoiceNumber","formControlName","invoiceNumber","placeholder","Enter return invoice number","readonly","",1,"form-control"],["for","packagingAndForwadingCharges"],[1,"fas","fa-box"],[1,"required"],[1,"input-group"],[1,"input-group-text"],["type","number","id","packagingAndForwadingCharges","formControlName","packagingAndForwadingCharges","min","0","step","0.01","placeholder","Enter packaging and forwarding charges",1,"form-control"],["class","invalid-feedback",4,"ngIf"],["class","products-section","formArrayName","items",4,"ngIf","ngIfElse"],[1,"purchase-summary"],[1,"summary-item"],[1,"form-actions"],["type","submit",1,"btn","btn-sm","btn-primary",3,"disabled"],[1,"fas",3,"ngClass"],[1,"invalid-feedback"],["formArrayName","items",1,"products-section"],[1,"table-responsive"],[1,"table","products-table"],[3,"formGroupName",4,"ngFor","ngForOf"],[3,"formGroupName"],[1,"product-cell"],[1,"product-name"],[1,"quantity"],[1,"batch"],[1,"form-field-container"],["type","number","formControlName","returnQuantity","min","0","step","0.01","inputmode","decimal",1,"form-control",3,"max","disabled"],["type","text","formControlName","remarks","placeholder","Remarks",1,"form-control"],[1,"empty-state"],[1,"fas","fa-box-open"],[1,"loading-state"],[1,"fas","fa-spinner","fa-spin"]],template:function(t,n){if(t&1&&(i(0,"div",3)(1,"button",4),u(2,"i",5),o(3," Back to Purchases "),r(),i(4,"div",6)(5,"div",7)(6,"div",8)(7,"h2",9),u(8,"i",10),o(9," Purchase Return "),r(),_(10,Tt,17,6,"div",11),r()(),_(11,Ut,2,2,"ng-container",12),r()(),_(12,Gt,4,0,"ng-template",null,0,Y)(14,Bt,4,0,"ng-template",null,1,Y)),t&2){let c=B(13);s(10),d("ngIf",n.purchaseDetails),s(),d("ngIf",!n.isLoading)("ngIfElse",c)}},dependencies:[H,N,D,L,R,re,T,V,ae,xe,q,z,ie,oe,se,te,W],styles:[".add-purchase-container[_ngcontent-%COMP%]{padding:1.5rem 2rem}.back-btn[_ngcontent-%COMP%]{margin-bottom:.75rem}.form-card[_ngcontent-%COMP%]{background:#fff;border-radius:var(--border-radius);box-shadow:var(--card-shadow);overflow:hidden}.card-header[_ngcontent-%COMP%]{background-color:var(--primary);padding:1rem 1.5rem}.card-header[_ngcontent-%COMP%]   .header-main[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:space-between;gap:1rem}.card-header[_ngcontent-%COMP%]   .form-title[_ngcontent-%COMP%]{margin:0;color:#fff;font-size:1.5rem;font-weight:500;display:flex;align-items:center;gap:.5rem}.card-header[_ngcontent-%COMP%]   .form-title[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{color:#fff}.card-header[_ngcontent-%COMP%]   .purchase-meta[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap;gap:1.5rem}.card-header[_ngcontent-%COMP%]   .purchase-meta[_ngcontent-%COMP%]   .meta-item[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.15rem}.card-header[_ngcontent-%COMP%]   .purchase-meta[_ngcontent-%COMP%]   .meta-item[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{font-size:.8rem;color:#ffffffd9}.card-header[_ngcontent-%COMP%]   .purchase-meta[_ngcontent-%COMP%]   .meta-item[_ngcontent-%COMP%]   strong[_ngcontent-%COMP%]{color:#fff;font-size:.98rem}.purchase-form[_ngcontent-%COMP%]{padding:1.5rem 1.5rem 2rem}.header-section[_ngcontent-%COMP%]{background-color:var(--background-light);border-radius:var(--border-radius);padding:1rem 1.25rem;margin-bottom:1.25rem}.header-section[_ngcontent-%COMP%]   .form-row[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1.25rem}.form-group[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{display:inline-flex;align-items:center;gap:.4rem;margin-bottom:.4rem;font-weight:500;color:var(--text-primary)}.form-group[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{color:var(--primary)}.products-section[_ngcontent-%COMP%]{border-radius:var(--border-radius);border:1px solid var(--border-color);padding:1rem .75rem .5rem;background-color:#fff}.table-responsive[_ngcontent-%COMP%]{overflow-x:auto}.products-table[_ngcontent-%COMP%]{width:100%;border-collapse:collapse}.products-table[_ngcontent-%COMP%]   thead[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{background-color:var(--background-light);color:#000;padding:.6rem .75rem;font-weight:600;font-size:.9rem;white-space:nowrap}.products-table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{padding:.5rem .75rem;vertical-align:middle;border-top:1px solid var(--border-color)}.product-cell[_ngcontent-%COMP%]   .product-name[_ngcontent-%COMP%]{font-weight:500;color:var(--text-primary)}.quantity[_ngcontent-%COMP%], .batch[_ngcontent-%COMP%]{color:var(--text-primary)}.form-field-container[_ngcontent-%COMP%]   .form-control[_ngcontent-%COMP%]{height:34px}.form-field-container[_ngcontent-%COMP%]   .invalid-feedback[_ngcontent-%COMP%]{margin-top:.15rem;font-size:.75rem;color:var(--danger)}.purchase-summary[_ngcontent-%COMP%]{margin-top:1rem;padding:.75rem 1rem;background-color:var(--background-light);border-radius:var(--border-radius);display:flex;justify-content:flex-end}.purchase-summary[_ngcontent-%COMP%]   .summary-item[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem}.purchase-summary[_ngcontent-%COMP%]   .summary-item[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{font-size:.85rem;color:var(--text-secondary)}.purchase-summary[_ngcontent-%COMP%]   .summary-item[_ngcontent-%COMP%]   strong[_ngcontent-%COMP%]{font-size:1rem;font-weight:600;color:var(--text-primary)}.form-actions[_ngcontent-%COMP%]{margin-top:.75rem;display:flex;justify-content:flex-start}.form-actions[_ngcontent-%COMP%]   .btn[_ngcontent-%COMP%]{min-width:180px;display:inline-flex;align-items:center;justify-content:center;gap:.4rem}.loading-state[_ngcontent-%COMP%], .empty-state[_ngcontent-%COMP%]{padding:2rem 1rem;text-align:center;color:var(--text-secondary)}.loading-state[_ngcontent-%COMP%]   i[_ngcontent-%COMP%], .empty-state[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{font-size:1.8rem;color:var(--primary);margin-bottom:.5rem}@media (max-width: 768px){.add-purchase-container[_ngcontent-%COMP%]{padding:1rem}.card-header[_ngcontent-%COMP%]   .header-main[_ngcontent-%COMP%]{flex-direction:column;align-items:flex-start}.form-actions[_ngcontent-%COMP%]   .btn[_ngcontent-%COMP%]{width:100%}}"]})}}return a})();var Yt=()=>({label:"All Customers",value:""});function Kt(a,m){if(a&1){let e=y();i(0,"div",6)(1,"div",30),u(2,"app-searchable-select",31),i(3,"button",32),P("click",function(){b(e);let n=p();return C(n.refreshCustomers())}),u(4,"i",33),r()()()}if(a&2){let e=p();s(2),d("options",e.customers)("defaultOption",be(5,Yt))("searchPlaceholder","Search customers..."),s(),d("disabled",e.isLoadingCustomers),s(),d("ngClass",e.isLoadingCustomers?"fa-spinner fa-spin":"fa-sync-alt")}}function Ht(a,m){if(a&1){let e=y();i(0,"button",34),P("click",function(){b(e);let n=p();return C(n.exportExcel())}),u(1,"i",35),o(2," Export "),r()}if(a&2){let e=p();d("disabled",e.isExportButtonDisabled())}}function Wt(a,m){a&1&&(i(0,"th",26),o(1,"Actions"),r())}function Jt(a,m){if(a&1){let e=y();i(0,"td",43)(1,"button",44),P("click",function(){b(e);let n=p().$implicit,c=p();return C(c.generatePdf(n.id,n.invoiceNumber))})("touchstart",function(n){return b(e),C(n.stopPropagation())}),u(2,"i",45),r(),i(3,"button",46),P("click",function(){b(e);let n=p().$implicit,c=p();return C(c.viewDetails(n.purchaseId))})("touchstart",function(n){return b(e),C(n.stopPropagation())}),u(4,"i",47),r(),i(5,"button",48),P("click",function(){b(e);let n=p().$implicit,c=p();return C(c.deletePurchaseReturn(n.id))})("touchstart",function(n){return b(e),C(n.stopPropagation())}),u(6,"i",49),r()()}}function Xt(a,m){if(a&1&&(i(0,"tr",36)(1,"td",37),o(2),r(),i(3,"td",38)(4,"strong"),o(5),r()(),i(6,"td",39),o(7),r(),i(8,"td",40),o(9),k(10,"date"),r(),i(11,"td",41)(12,"strong"),o(13),r()(),_(14,Jt,7,0,"td",42),r()),a&2){let e=m.$implicit,t=m.index,n=p();s(2),M(n.startIndex+t+1),s(3),M(e.invoiceNumber),s(2),M(e.customerName),s(2),M(I(10,6,e.purchaseReturnDate,"dd-MM-yyyy")),s(4),M(e.totalPurchaseAmount),s(),d("ngIf",n.canManagePurchases)}}function Zt(a,m){if(a&1){let e=y();i(0,"app-pagination",50),P("pageChange",function(n){b(e);let c=p();return C(c.onPageChange(n))})("pageSizeChange",function(n){b(e);let c=p();return C(c.onPageSizeChange(n))}),r()}if(a&2){let e=p();d("currentPage",e.currentPage)("pageSize",e.pageSize)("totalElements",e.totalElements)("pageSizeOptions",e.pageSizeOptions)}}var Ze=(()=>{class a{constructor(e,t,n,c,l,g,h,v){this.purchaseService=e,this.customerService=t,this.fb=n,this.snackbar=c,this.dateUtils=l,this.encryptionService=g,this.router=h,this.authService=v,this.purchaseReturns=[],this.isLoading=!1,this.currentPage=0,this.pageSize=10,this.pageSizeOptions=[5,10,25,50,100],this.totalPages=0,this.totalElements=0,this.startIndex=0,this.endIndex=0,this.customers=[],this.isLoadingCustomers=!1,this.canManagePurchases=!1,this.clientId=1,this.destroy$=new F,this.initializeForm()}ngOnInit(){this.canManagePurchases=this.authService.isAdmin()||this.authService.isStaffAdmin(),this.loadPurchaseReturns(),this.canManagePurchases&&this.loadCustomers()}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete()}initializeForm(){this.searchForm=this.fb.group({search:[""],batchNumber:[""],customerId:[""],startDate:[""],endDate:[""]})}loadPurchaseReturns(){this.isLoading=!0;let e=this.searchForm.value,t={currentPage:this.currentPage,perPageRecord:this.pageSize,clientId:this.clientId,search:e.search?.trim()||void 0,customerId:this.canManagePurchases&&e.customerId?Number(e.customerId):void 0,startDate:e.startDate?this.dateUtils.formatDate(e.startDate):void 0,endDate:e.endDate?this.dateUtils.formatDate(e.endDate):void 0};Object.keys(t).forEach(n=>{t[n]===void 0&&delete t[n]}),this.purchaseService.searchPurchaseReturn(t).pipe(x(this.destroy$)).subscribe({next:n=>{this.purchaseReturns=n.content||[],this.totalPages=n.totalPages||0,this.totalElements=n.totalElements||0,this.updatePaginationIndexes(),this.isLoading=!1},error:n=>{this.snackbar.error(n?.error?.message||"Failed to load purchase returns"),this.isLoading=!1}})}updatePaginationIndexes(){this.startIndex=this.currentPage*this.pageSize,this.endIndex=Math.min((this.currentPage+1)*this.pageSize,this.totalElements)}onSearch(e){e&&(e.preventDefault(),e.stopPropagation()),this.currentPage=0,this.loadPurchaseReturns()}resetForm(){this.searchForm.reset(),this.currentPage=0,this.loadPurchaseReturns()}onPageChange(e){this.currentPage=e,this.loadPurchaseReturns()}onPageSizeChange(e){this.pageSize=e,this.currentPage=0,this.loadPurchaseReturns()}loadCustomers(){this.canManagePurchases&&(this.isLoadingCustomers=!0,this.customerService.getCustomers({status:"A"}).pipe(x(this.destroy$)).subscribe({next:e=>{e?.success&&e.data&&(this.customers=e.data),this.isLoadingCustomers=!1},error:()=>{this.snackbar.error("Failed to load customers"),this.isLoadingCustomers=!1}}))}refreshCustomers(){this.canManagePurchases&&(this.isLoadingCustomers=!0,this.customerService.refreshCustomers().pipe(x(this.destroy$)).subscribe({next:e=>{e?.success&&e.data&&(this.customers=e.data,this.snackbar.success("Customers refreshed successfully")),this.isLoadingCustomers=!1},error:()=>{this.snackbar.error("Failed to refresh customers"),this.isLoadingCustomers=!1}}))}viewDetails(e){let t=this.encryptionService.encrypt(e.toString());this.router.navigate(["/purchase/return",t])}deletePurchaseReturn(e){confirm("Are you sure you want to delete this purchase return? This action cannot be undone.")&&(this.isLoading=!0,this.purchaseService.deletePurchaseReturn(e).pipe(x(this.destroy$)).subscribe({next:t=>{t?.success?(this.snackbar.success(t.message||"Purchase return deleted successfully"),this.loadPurchaseReturns()):(this.snackbar.error(t?.message||"Failed to delete purchase return"),this.isLoading=!1)},error:t=>{this.snackbar.error(t?.error?.message||"Failed to delete purchase return"),this.isLoading=!1}}))}generatePdf(e,t){this.purchaseService.generatePurchaseReturnPdf(e).pipe(x(this.destroy$)).subscribe({next:({blob:n,filename:c})=>{let l="purchase-return-"+(t?`${t}.pdf`:c),g=window.URL.createObjectURL(n),h=document.createElement("a");h.href=g,h.download=l,document.body.appendChild(h),h.click(),document.body.removeChild(h),window.URL.revokeObjectURL(g),this.snackbar.success("PDF downloaded successfully")},error:n=>{this.snackbar.error(n?.error?.message||"Failed to generate PDF")}})}isExportButtonDisabled(){let e=this.searchForm.get("startDate")?.value,t=this.searchForm.get("endDate")?.value;return!e||!t}exportExcel(){let e=this.searchForm.get("startDate")?.value,t=this.searchForm.get("endDate")?.value;if(!e||!t){this.snackbar.error("Please select both start date and end date to export");return}let n=this.dateUtils.formatDateDDMMYYYY(e),c=this.dateUtils.formatDateDDMMYYYY(t);this.isLoading=!0,this.purchaseService.exportPurchaseReturnExcel({startDate:n,endDate:c}).pipe(x(this.destroy$)).subscribe({next:({blob:l,filename:g})=>{let h=window.URL.createObjectURL(l),v=document.createElement("a");v.href=h,v.download=g||`purchase_return_export_${n}_${c}.xlsx`,document.body.appendChild(v),v.click(),document.body.removeChild(v),window.URL.revokeObjectURL(h),this.snackbar.success("Excel file downloaded successfully"),this.isLoading=!1},error:l=>{this.snackbar.error(l?.error?.message||"Failed to export Excel file"),this.isLoading=!1}})}static{this.\u0275fac=function(t){return new(t||a)(f(U),f(ue),f(j),f($),f(ye),f(Q),f(J),f(Oe))}}static{this.\u0275cmp=A({type:a,selectors:[["app-purchase-return-list"]],decls:52,vars:7,consts:[[1,"purchase-container"],[3,"show"],["aria-labelledby","search-purchase-returns-heading",1,"search-section","card"],["id","search-purchase-returns-heading"],["role","search","aria-label","Purchase return search form",3,"ngSubmit","formGroup"],[1,"search-controls"],[1,"form-group"],["for","invoice-search",1,"sr-only"],["id","invoice-search","type","text","formControlName","search","placeholder","Search by invoice number...","aria-label","Search by invoice number",1,"form-control"],["for","batch-search",1,"sr-only"],["id","batch-search","type","text","formControlName","batchNumber","placeholder","Search by Batch Number...","aria-label","Search by batch number",1,"form-control"],["class","form-group",4,"ngIf"],["for","start-date",1,"sr-only"],["id","start-date","type","date","formControlName","startDate","placeholder","Start Date","aria-label","Start date",1,"form-control",3,"touchstart"],["for","end-date",1,"sr-only"],["id","end-date","type","date","formControlName","endDate","placeholder","End Date","aria-label","End date",1,"form-control",3,"touchstart"],[1,"button-group"],["type","submit",1,"search-btn","btn","btn-sm","btn-primary"],[1,"fas","fa-search"],["type","button",1,"search-btn","btn","btn-sm","btn-secondary",3,"click"],[1,"fas","fa-undo"],["type","button","class","search-btn btn btn-sm btn-success export-btn","title","Export purchase returns to Excel",3,"disabled","click",4,"ngIf"],["aria-labelledby","purchase-returns-heading",1,"purchases-list","card"],["id","purchase-returns-heading"],[1,"table-responsive"],["role","table","aria-label","Purchase returns list",1,"table"],["scope","col"],["scope","col",4,"ngIf"],["role","row",4,"ngFor","ngForOf"],[3,"currentPage","pageSize","totalElements","pageSizeOptions","pageChange","pageSizeChange",4,"ngIf"],[1,"product-select-group"],["formControlName","customerId","labelKey","name","valueKey","id",3,"options","defaultOption","searchPlaceholder"],["type","button","title","Refresh Customers",1,"btn","btn-sm","btn-primary","refresh",2,"margin-top","3px",3,"click","disabled"],[1,"fas",3,"ngClass"],["type","button","title","Export purchase returns to Excel",1,"search-btn","btn","btn-sm","btn-success","export-btn",3,"click","disabled"],[1,"fas","fa-file-excel"],["role","row"],["data-label","No"],["data-label","Invoice No."],["data-label","Customer Name"],["data-label","Purchase Return Date"],["data-label","Total Amount"],["class","actions","data-label","Actions",4,"ngIf"],["data-label","Actions",1,"actions"],["aria-label","Export purchase return as PDF",1,"btn-icon","pdf",3,"click","touchstart"],["aria-hidden","true",1,"fas","fa-file-pdf"],["aria-label","View purchase return details",1,"btn-icon","edit",3,"click","touchstart"],["aria-hidden","true",1,"fas","fa-eye"],["aria-label","Delete purchase return",1,"btn-icon","delete",3,"click","touchstart"],["aria-hidden","true",1,"fas","fa-trash"],[3,"pageChange","pageSizeChange","currentPage","pageSize","totalElements","pageSizeOptions"]],template:function(t,n){t&1&&(i(0,"div",0),u(1,"app-loader",1),i(2,"section",2)(3,"h2",3),o(4,"Search Purchase Returns"),r(),i(5,"form",4),P("ngSubmit",function(l){return n.onSearch(l)}),i(6,"div",5)(7,"div",6)(8,"label",7),o(9,"Search by invoice number"),r(),u(10,"input",8),i(11,"label",9),o(12,"Search by batch number"),r(),u(13,"input",10),r(),_(14,Kt,5,6,"div",11),i(15,"div",6)(16,"label",12),o(17,"Start date"),r(),i(18,"input",13),P("touchstart",function(l){return l.stopPropagation()}),r()(),i(19,"div",6)(20,"label",14),o(21,"End date"),r(),i(22,"input",15),P("touchstart",function(l){return l.stopPropagation()}),r()(),i(23,"div",16)(24,"button",17),u(25,"i",18),o(26," Search "),r(),i(27,"button",19),P("click",function(){return n.resetForm()}),u(28,"i",20),o(29," Reset "),r(),_(30,Ht,3,1,"button",21),r()()()(),i(31,"section",22)(32,"h2",23),o(33,"Purchase Returns"),r(),i(34,"div",24)(35,"table",25)(36,"thead")(37,"tr")(38,"th",26),o(39,"No"),r(),i(40,"th",26),o(41,"Invoice No."),r(),i(42,"th",26),o(43,"Customer Name"),r(),i(44,"th",26),o(45,"Purchase Return Date"),r(),i(46,"th",26),o(47,"Total Amount"),r(),_(48,Wt,2,0,"th",27),r()(),i(49,"tbody"),_(50,Xt,15,9,"tr",28),r()()(),_(51,Zt,1,4,"app-pagination",29),r()()),t&2&&(s(),d("show",n.isLoading),s(4),d("formGroup",n.searchForm),s(9),d("ngIf",n.canManagePurchases),s(16),d("ngIf",n.canManagePurchases),s(18),d("ngIf",n.canManagePurchases),s(2),d("ngForOf",n.purchaseReturns),s(),d("ngIf",n.totalPages>0))},dependencies:[H,N,D,L,R,T,V,q,z,X,Z,le,W],styles:[".purchase-container[_ngcontent-%COMP%]{padding:2rem;position:relative;min-height:200px;background-color:var(--background)}.purchase-container[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]{background:#fff;border-radius:0;box-shadow:0 2px 4px #0000001a;margin-bottom:20px;padding:20px}.purchase-container[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{margin-bottom:20px;color:var(--text-primary);font-size:1.5rem;font-weight:600}.purchase-container[_ngcontent-%COMP%]   .sr-only[_ngcontent-%COMP%]{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border-width:0}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;align-items:flex-start}@media (max-width: 768px){.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]{grid-template-columns:1fr}}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]{margin:0}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]   .form-control[_ngcontent-%COMP%]{height:40px}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]   .product-select-group[_ngcontent-%COMP%]{display:flex;gap:.5rem}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]   .product-select-group[_ngcontent-%COMP%]   app-searchable-select[_ngcontent-%COMP%]{flex:1}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]   .product-select-group[_ngcontent-%COMP%]   .btn-icon[_ngcontent-%COMP%]{width:42px;padding:0;display:flex;align-items:center;justify-content:center;border:1px solid var(--border-color);border-radius:var(--border-radius);background:var(--primary)}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]   .product-select-group[_ngcontent-%COMP%]   .btn-icon[_ngcontent-%COMP%]:hover:not(:disabled){background:var(--primary)}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]   .product-select-group[_ngcontent-%COMP%]   .btn-icon[_ngcontent-%COMP%]:disabled{opacity:.6;cursor:not-allowed}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]{display:flex;gap:.5rem;flex-wrap:wrap}@media (max-width: 768px){.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]{grid-column:1/-1}}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{flex:1;min-width:120px;height:42px;display:flex;align-items:center;justify-content:center;gap:.5rem;transition:all .2s ease;touch-action:manipulation;-webkit-tap-highlight-color:transparent;cursor:pointer}@media (max-width: 576px){.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{min-width:100%;flex:1 1 100%}}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{font-size:1rem}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]   button.export-btn[_ngcontent-%COMP%]{background-color:#28a745;color:#fff;border:1px solid #28a745;font-weight:500}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]   button.export-btn[_ngcontent-%COMP%]:hover:not(:disabled){background-color:#218838;border-color:#1e7e34;transform:translateY(-1px);box-shadow:0 2px 4px #28a7454d}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]   button.export-btn[_ngcontent-%COMP%]:active:not(:disabled), .purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]   button.export-btn[_ngcontent-%COMP%]:focus:not(:disabled){outline:2px solid rgba(40,167,69,.5);outline-offset:2px;transform:translateY(0)}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]   button.export-btn[_ngcontent-%COMP%]:disabled{background-color:#6c757d;border-color:#6c757d;opacity:.6;cursor:not-allowed;transform:none}.purchase-container[_ngcontent-%COMP%]   .search-section[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .button-group[_ngcontent-%COMP%]   button.export-btn[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{color:#fff}.purchase-container[_ngcontent-%COMP%]   .purchases-list[_ngcontent-%COMP%]   .table-responsive[_ngcontent-%COMP%]{overflow-x:auto;-webkit-overflow-scrolling:touch}.purchase-container[_ngcontent-%COMP%]   .purchases-list[_ngcontent-%COMP%]   .table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{white-space:nowrap;font-weight:600}.purchase-container[_ngcontent-%COMP%]   .purchases-list[_ngcontent-%COMP%]   .table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{vertical-align:middle}@media (max-width: 768px){.purchase-container[_ngcontent-%COMP%]   .purchases-list[_ngcontent-%COMP%]   .table[_ngcontent-%COMP%]   thead[_ngcontent-%COMP%]{display:none}.purchase-container[_ngcontent-%COMP%]   .purchases-list[_ngcontent-%COMP%]   .table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]{display:block;margin-bottom:1rem;border:1px solid #dee2e6;border-radius:4px;padding:.5rem}.purchase-container[_ngcontent-%COMP%]   .purchases-list[_ngcontent-%COMP%]   .table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;padding:.5rem;border:none;border-bottom:1px solid #f0f0f0}.purchase-container[_ngcontent-%COMP%]   .purchases-list[_ngcontent-%COMP%]   .table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]:before{content:attr(data-label);font-weight:600;color:var(--text-primary)}.purchase-container[_ngcontent-%COMP%]   .purchases-list[_ngcontent-%COMP%]   .table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]:last-child{border-bottom:none}.purchase-container[_ngcontent-%COMP%]   .purchases-list[_ngcontent-%COMP%]   .table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   td.actions[_ngcontent-%COMP%]{justify-content:flex-start;flex-wrap:wrap;gap:.5rem}.purchase-container[_ngcontent-%COMP%]   .purchases-list[_ngcontent-%COMP%]   .table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   td.actions[_ngcontent-%COMP%]:before{display:none}}.purchase-container[_ngcontent-%COMP%]   .table-controls[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}.purchase-container[_ngcontent-%COMP%]   .table-controls[_ngcontent-%COMP%]   .page-size-selector[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem}.purchase-container[_ngcontent-%COMP%]   .table-controls[_ngcontent-%COMP%]   .page-size-selector[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{color:var(--text-secondary);white-space:nowrap}.purchase-container[_ngcontent-%COMP%]   .table-controls[_ngcontent-%COMP%]   .page-size-selector[_ngcontent-%COMP%]   select.form-control[_ngcontent-%COMP%]{width:auto;min-width:80px;padding:.5rem;margin-bottom:0}@media (max-width: 768px){.purchase-container[_ngcontent-%COMP%]{padding:1rem}.purchase-container[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]{flex-direction:column;gap:1rem}.purchase-container[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]{width:100%}.purchase-container[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]   input[type=date][_ngcontent-%COMP%]{touch-action:manipulation;-webkit-appearance:none}.purchase-container[_ngcontent-%COMP%]   .search-controls[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{width:100%}.purchase-container[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]{padding:1rem}}@media (max-width: 576px){.purchase-container[_ngcontent-%COMP%]{padding:.75rem}.purchase-container[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{font-size:1.25rem}}@media (max-width: 576px){.table-controls[_ngcontent-%COMP%]{flex-direction:column;gap:1rem;align-items:flex-start}.table-controls[_ngcontent-%COMP%]   .page-size-selector[_ngcontent-%COMP%]{width:100%}.table-controls[_ngcontent-%COMP%]   .page-size-selector[_ngcontent-%COMP%]   select.form-control[_ngcontent-%COMP%]{flex:1}}.actions[_ngcontent-%COMP%]{display:flex;gap:.5rem;justify-content:flex-start;flex-wrap:wrap}.actions[_ngcontent-%COMP%]   .btn-icon[_ngcontent-%COMP%]{background:none;border:none;padding:8px;cursor:pointer;border-radius:6px;transition:all .2s ease;display:flex;align-items:center;justify-content:center;touch-action:manipulation;-webkit-tap-highlight-color:transparent;min-width:36px;min-height:36px}.actions[_ngcontent-%COMP%]   .btn-icon.edit[_ngcontent-%COMP%]{color:var(--primary);background-color:#1458811a}.actions[_ngcontent-%COMP%]   .btn-icon.edit[_ngcontent-%COMP%]:hover:not(:disabled){background-color:var(--primary);color:#fff;transform:translateY(-1px)}.actions[_ngcontent-%COMP%]   .btn-icon.edit[_ngcontent-%COMP%]:disabled{color:var(--text-secondary);background-color:#0000000d;cursor:not-allowed}.actions[_ngcontent-%COMP%]   .btn-icon.return[_ngcontent-%COMP%]{color:#ff9800;background-color:#ff98001a}.actions[_ngcontent-%COMP%]   .btn-icon.return[_ngcontent-%COMP%]:hover:not(:disabled){background-color:#ff9800;color:#fff;transform:translateY(-1px)}.actions[_ngcontent-%COMP%]   .btn-icon.return[_ngcontent-%COMP%]:disabled{color:var(--text-secondary);background-color:#0000000d;cursor:not-allowed}.actions[_ngcontent-%COMP%]   .btn-icon.sale[_ngcontent-%COMP%]{color:var(--primary);background-color:#fd78231a}.actions[_ngcontent-%COMP%]   .btn-icon.sale[_ngcontent-%COMP%]:hover:not(:disabled){background-color:var(--primary);color:#fff;transform:translateY(-1px)}.actions[_ngcontent-%COMP%]   .btn-icon.sale[_ngcontent-%COMP%]:disabled{color:var(--text-secondary);background-color:#0000000d;cursor:not-allowed}.actions[_ngcontent-%COMP%]   .btn-icon.pdf[_ngcontent-%COMP%]{color:#dc3545;background-color:#dc35451a}.actions[_ngcontent-%COMP%]   .btn-icon.pdf[_ngcontent-%COMP%]:hover:not(:disabled){background-color:#dc3545;color:#fff;transform:translateY(-1px)}.actions[_ngcontent-%COMP%]   .btn-icon.pdf[_ngcontent-%COMP%]:disabled{color:var(--text-secondary);background-color:#0000000d;cursor:not-allowed}.actions[_ngcontent-%COMP%]   .btn-icon.delete[_ngcontent-%COMP%]{color:#dc3545;background-color:#dc35451a}.actions[_ngcontent-%COMP%]   .btn-icon.delete[_ngcontent-%COMP%]:hover{background-color:#dc3545;color:#fff;transform:translateY(-1px)}.actions[_ngcontent-%COMP%]   .btn-icon[_ngcontent-%COMP%]:active{transform:translateY(0)}.actions[_ngcontent-%COMP%]   .btn-icon[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{font-size:16px}@media (max-width: 768px){.actions[_ngcontent-%COMP%]   .btn-icon[_ngcontent-%COMP%]{padding:6px}.actions[_ngcontent-%COMP%]   .btn-icon[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{font-size:14px}}  .custom-snackbar.success{background-color:var(--accent2)}  .custom-snackbar.error{background-color:#dc3545}  .custom-snackbar .snackbar-message{display:flex;align-items:center;gap:.5rem;color:#fff}  .custom-snackbar .snackbar-message i{font-size:1.2rem}.loading-overlay[_ngcontent-%COMP%]{position:absolute;inset:0;background:#fffc;display:flex;justify-content:center;align-items:center;z-index:1000}.loading-overlay[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{font-size:2rem;color:var(--primary)}.product-select-group[_ngcontent-%COMP%]{display:flex;gap:.5rem;align-items:flex-start}.product-select-group[_ngcontent-%COMP%]   app-searchable-select[_ngcontent-%COMP%]{flex:1}.product-select-group[_ngcontent-%COMP%]   .btn-icon.refresh[_ngcontent-%COMP%]{background-color:var(--background);color:#fff;margin-top:3px;width:42px;height:42px;border-radius:6px;transition:all .2s ease}.product-select-group[_ngcontent-%COMP%]   .btn-icon.refresh[_ngcontent-%COMP%]:hover:not(:disabled){background-color:var(--primary);color:#fff;transform:translateY(-1px)}.product-select-group[_ngcontent-%COMP%]   .btn-icon.refresh[_ngcontent-%COMP%]:disabled{opacity:.7;cursor:not-allowed}.product-select-group[_ngcontent-%COMP%]   .btn-icon.refresh[_ngcontent-%COMP%]:active{transform:translateY(0)}"]})}}return a})();var en=[{path:"",component:He},{path:"create",component:Ne},{path:"edit/:id",component:Ne},{path:"qc/:id",component:Je},{path:"return/:id",component:Xe},{path:"return",component:Ze}],et=(()=>{class a{static{this.\u0275fac=function(t){return new(t||a)}}static{this.\u0275mod=he({type:a})}static{this.\u0275inj=ge({imports:[G.forChild(en),G]})}}return a})();var sr=(()=>{class a{static{this.\u0275fac=function(t){return new(t||a)}}static{this.\u0275mod=he({type:a})}static{this.\u0275inj=ge({imports:[ne,ce,G,et,X,Z,le]})}}return a})();export{sr as PurchaseModule};
