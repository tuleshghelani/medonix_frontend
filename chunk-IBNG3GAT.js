import{a as W}from"./chunk-W3BS3QOV.js";import{C as N,Db as Y,Eb as G,Fa as A,G as S,Ga as q,H as g,Hb as Q,I as p,Kb as K,N as y,Pb as B,Sa as E,Sb as U,Ta as L,U as a,Ub as H,V as O,Va as $,_a as T,a as P,aa as h,b as F,ca as s,ea as M,f as x,ha as o,ia as c,ja as d,ma as k,mb as R,nb as w,pa as f,pb as C,qa as m,rb as I,u as b,wa as l,wb as z,xb as _,ya as V,yb as D,zb as j,zc as J}from"./chunk-RL35WT5O.js";var ee=()=>({label:"Create new Purchase (auto)",value:null});function te(i,u){if(i&1){let e=k();o(0,"div",8)(1,"label"),d(2,"i",19),l(3," Purchase (optional) "),c(),o(4,"div",20),d(5,"app-searchable-select",21),o(6,"button",22),f("click",function(){g(e);let n=m(2);return p(n.refreshPurchases())}),d(7,"i",18),c()(),o(8,"small",23),l(9," Purchases shown are from the last 6 months. Leave blank to create a new Purchase automatically; select one to append items into an existing Purchase. "),c()()}if(i&2){let e=m(2);a(5),s("options",e.purchaseOptions)("defaultOption",q(5,ee))("searchPlaceholder","Search purchases by invoice/customer..."),a(),s("disabled",e.isLoadingPurchases),a(),s("ngClass",e.isLoadingPurchases?"fa-spinner fa-spin":"fa-sync-alt")}}function ne(i,u){i&1&&(o(0,"span",11),l(1,"*"),c())}function ie(i,u){i&1&&(o(0,"div",28),l(1," Invoice number is required "),c())}function re(i,u){if(i&1&&(o(0,"div",8)(1,"label",24),d(2,"i",25),l(3," Invoice Number "),h(4,ne,2,0,"span",26),c(),d(5,"input",27),h(6,ie,2,0,"div",13),c()),i&2){let e,t,n=m(2);a(4),s("ngIf",n.isInvoiceRequired()),a(),M("is-invalid",((e=n.chargesForm.get("invoiceNumber"))==null?null:e.invalid)&&((e=n.chargesForm.get("invoiceNumber"))==null?null:e.touched)),a(),s("ngIf",(t=n.chargesForm.get("invoiceNumber"))==null||t.errors==null?null:t.errors.required)}}function oe(i,u){i&1&&(o(0,"div",28),l(1," Packaging and forwarding charges is required "),c())}function ae(i,u){i&1&&(o(0,"div",28),l(1," Charges must be 0 or greater "),c())}function se(i,u){if(i&1){let e=k();o(0,"div",1),f("click",function(){g(e);let n=m();return p(n.onCancel())}),o(1,"div",2),f("click",function(n){return g(e),p(n.stopPropagation())}),o(2,"div",3)(3,"h3"),d(4,"i",4),l(5," Packaging & Forwarding Charges"),c()(),o(6,"form",5),f("ngSubmit",function(){g(e);let n=m();return p(n.onSubmit())}),o(7,"div",6),h(8,te,10,6,"div",7)(9,re,7,4,"div",7),o(10,"div",8)(11,"label",9),d(12,"i",10),l(13," Packaging & Forwarding Charges "),o(14,"span",11),l(15,"*"),c()(),d(16,"input",12),h(17,oe,2,0,"div",13)(18,ae,2,0,"div",13),c()(),o(19,"div",14)(20,"button",15),f("click",function(){g(e);let n=m();return p(n.onCancel())}),d(21,"i",16),l(22," Cancel "),c(),o(23,"button",17),d(24,"i",18),l(25),c()()()()()}if(i&2){let e,t,n,r=m();a(),s("@modalAnimation",void 0),a(5),s("formGroup",r.chargesForm),a(2),s("ngIf",r.openedFromPurchaseOrder),a(),s("ngIf",r.requireInvoiceNumber),a(7),M("is-invalid",((e=r.chargesForm.get("packagingAndForwadingCharges"))==null?null:e.invalid)&&((e=r.chargesForm.get("packagingAndForwadingCharges"))==null?null:e.touched)),a(),s("ngIf",(t=r.chargesForm.get("packagingAndForwadingCharges"))==null||t.errors==null?null:t.errors.required),a(),s("ngIf",(n=r.chargesForm.get("packagingAndForwadingCharges"))==null||n.errors==null?null:n.errors.min),a(5),s("disabled",r.chargesForm.invalid||r.isLoading),a(),s("ngClass",r.isLoading?"fa-spinner fa-spin":"fa-check"),a(),V(" ",r.isLoading?"Creating...":"Create Sale"," ")}}var xe=(()=>{class i{constructor(e,t){this.fb=e,this.purchaseService=t,this.show=!1,this.defaultCharges=0,this.requireInvoiceNumber=!1,this.openedFromPurchaseOrder=!1,this.confirm=new y,this.cancel=new y,this.isLoading=!1,this.isLoadingPurchases=!1,this.purchaseOptions=[],this.purchaseOptionsRaw=[],this.destroy$=new x,this.open$=new x,this.chargesForm=this.fb.group({invoiceNumber:[""],purchaseId:[null],packagingAndForwadingCharges:[0,[_.required,_.min(0)]]})}ngOnChanges(){this.show&&(this.open$.next(),this.updateInvoiceNumberValidators(),this.chargesForm.patchValue({packagingAndForwadingCharges:this.defaultCharges!==void 0?this.defaultCharges:0,invoiceNumber:"",purchaseId:null}),this.chargesForm.get("purchaseId")?.valueChanges.pipe(b(this.destroy$),b(this.open$)).subscribe(()=>{this.updateInvoiceNumberValidators()}),this.openedFromPurchaseOrder&&this.loadPurchases())}isInvoiceRequired(){if(!this.requireInvoiceNumber)return!1;if(this.openedFromPurchaseOrder){let e=this.chargesForm.get("purchaseId")?.value;return e==null||e===""}return!0}updateInvoiceNumberValidators(){let e=this.chargesForm.get("invoiceNumber");if(e){if(!this.requireInvoiceNumber){e.clearValidators(),e.updateValueAndValidity({emitEvent:!1});return}if(this.openedFromPurchaseOrder){this.isInvoiceRequired()?e.setValidators([_.required]):e.clearValidators(),e.updateValueAndValidity({emitEvent:!1});return}e.setValidators([_.required]),e.updateValueAndValidity({emitEvent:!1})}}refreshPurchases(){this.loadPurchases(!0)}loadPurchases(e=!1){if(!e&&this.purchaseOptionsRaw.length>0){this.updatePurchaseOptions();return}this.isLoadingPurchases=!0,this.purchaseService.getPurchasesLast6Months().pipe(b(this.destroy$)).subscribe({next:t=>{t?.success?(this.purchaseOptionsRaw=Array.isArray(t.data)?t.data:[],this.updatePurchaseOptions()):(this.purchaseOptionsRaw=[],this.purchaseOptions=[]),this.isLoadingPurchases=!1},error:()=>{this.purchaseOptionsRaw=[],this.purchaseOptions=[],this.isLoadingPurchases=!1}})}updatePurchaseOptions(){let e=this.customerId,t=e==null||e===""?null:Number(e),n=[...this.purchaseOptionsRaw].sort((r,v)=>{if(!t)return 0;let X=Number(r.customerId)===t?0:1,Z=Number(v.customerId)===t?0:1;return X-Z});this.purchaseOptions=n.map(r=>F(P({},r),{displayLabel:this.formatPurchaseLabel(r)}))}formatPurchaseLabel(e){let t=e.purchaseDate?E(new Date(e.purchaseDate),"dd-MM-yyyy","en"):"-",n=typeof e.totalPurchaseAmount=="number"?e.totalPurchaseAmount:Number(e.totalPurchaseAmount||0),r=Number.isFinite(n)?n.toFixed(2):"0.00",v=e.isQcPass?"QC Pass":"QC Pending";return`${e.invoiceNumber} \u2022 ${e.customerName} \u2022 ${t} \u2022 \u20B9${r} \u2022 Items: ${e.numberOfItems} \u2022 ${v} \u2022 #${e.id}`}onCancel(){this.cancel.emit()}onSubmit(){if(this.chargesForm.valid){let e=Number(this.chargesForm.get("packagingAndForwadingCharges")?.value||0),t=this.chargesForm.get("purchaseId")?.value,n=t==null||t===""?null:Number(t);if(this.requireInvoiceNumber&&this.orderId!==void 0&&this.orderId!==null){let r=this.chargesForm.get("invoiceNumber")?.value||"";this.confirm.emit(P({id:this.orderId,invoiceNumber:r,packagingAndForwadingCharges:e},this.openedFromPurchaseOrder?{purchaseId:n}:{}))}else this.confirm.emit(e)}else this.chargesForm.markAllAsTouched()}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete(),this.open$.next(),this.open$.complete(),this.confirm&&typeof this.confirm.complete=="function"&&this.confirm.complete(),this.cancel&&typeof this.cancel.complete=="function"&&this.cancel.complete(),this.chargesForm&&this.chargesForm.reset()}static{this.\u0275fac=function(t){return new(t||i)(O(U),O(W))}}static{this.\u0275cmp=N({type:i,selectors:[["app-packaging-charges-modal"]],inputs:{show:"show",defaultCharges:"defaultCharges",requireInvoiceNumber:"requireInvoiceNumber",orderId:"orderId",openedFromPurchaseOrder:"openedFromPurchaseOrder",customerId:"customerId"},outputs:{confirm:"confirm",cancel:"cancel"},standalone:!0,features:[S,A],decls:1,vars:1,consts:[["class","modal-overlay",3,"click",4,"ngIf"],[1,"modal-overlay",3,"click"],[1,"modal-content",3,"click"],[1,"modal-header"],[1,"fas","fa-box"],[3,"ngSubmit","formGroup"],[1,"modal-body"],["class","form-group",4,"ngIf"],[1,"form-group"],["for","packagingAndForwadingCharges"],[1,"fas","fa-rupee-sign"],[1,"required"],["type","number","id","packagingAndForwadingCharges","formControlName","packagingAndForwadingCharges","min","0","step","0.01","placeholder","Enter packaging and forwarding charges",1,"form-control"],["class","invalid-feedback",4,"ngIf"],[1,"modal-actions"],["type","button",1,"btn","btn-secondary",3,"click"],[1,"fas","fa-times"],["type","submit",1,"btn","btn-primary",3,"disabled"],[1,"fas",3,"ngClass"],[1,"fas","fa-link"],[1,"select-group"],["formControlName","purchaseId","labelKey","displayLabel","valueKey","id",3,"options","defaultOption","searchPlaceholder"],["type","button","title","Refresh Purchases",1,"btn","btn-sm","btn-primary","refresh",3,"click","disabled"],[1,"text-muted"],["for","invoiceNumber"],[1,"fas","fa-file-invoice"],["class","required",4,"ngIf"],["type","text","id","invoiceNumber","formControlName","invoiceNumber","placeholder","Enter invoice number",1,"form-control"],[1,"invalid-feedback"]],template:function(t,n){t&1&&h(0,se,26,11,"div",0),t&2&&s("ngIf",n.show)},dependencies:[T,L,$,H,Y,z,G,D,j,B,Q,K,J],styles:[".modal-overlay[_ngcontent-%COMP%]{position:fixed;inset:0;background-color:#00000080;-webkit-backdrop-filter:blur(4px);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:1000}.modal-content[_ngcontent-%COMP%]{background:#fff;border-radius:8px;width:90%;max-width:500px;box-shadow:0 4px 6px #0000001a;animation:_ngcontent-%COMP%_modalIn .2s ease-out}.modal-header[_ngcontent-%COMP%]{padding:1rem 1.5rem;border-bottom:1px solid #dee2e6;background-color:var(--secondary, #17a3df);color:#fff;border-radius:8px 8px 0 0}.modal-header[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0;display:flex;align-items:center;gap:.5rem;font-size:1.25rem;font-weight:600}.modal-header[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{font-size:1.1rem}.modal-body[_ngcontent-%COMP%]{padding:1.5rem}.modal-body[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]{margin-bottom:0}.modal-body[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{display:block;margin-bottom:.5rem;color:var(--text-primary, #2c3e50);font-weight:500;font-size:14px}.modal-body[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{margin-right:6px;color:var(--primary, #145881)}.modal-body[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]   .required[_ngcontent-%COMP%]{color:#dc3545}.modal-body[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]   .form-control[_ngcontent-%COMP%]{width:100%;padding:10px;border:1px solid var(--supporting, #90a4ae);border-radius:4px;font-size:14px;transition:all .3s ease;box-sizing:border-box}.modal-body[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]   .form-control[_ngcontent-%COMP%]:focus{outline:none;border-color:var(--primary, #145881);box-shadow:0 0 0 3px #1458811a}.modal-body[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]   .form-control.is-invalid[_ngcontent-%COMP%]{border-color:#dc3545}.modal-body[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]   .invalid-feedback[_ngcontent-%COMP%]{color:#dc3545;font-size:12px;margin-top:4px;display:block}.modal-body[_ngcontent-%COMP%]   .select-group[_ngcontent-%COMP%]{display:flex;align-items:center;gap:10px}.modal-body[_ngcontent-%COMP%]   .select-group[_ngcontent-%COMP%]   app-searchable-select[_ngcontent-%COMP%]{flex:1 1 auto;min-width:0}.modal-body[_ngcontent-%COMP%]   .select-group[_ngcontent-%COMP%]   .refresh[_ngcontent-%COMP%]{flex:0 0 auto;height:40px;display:inline-flex;align-items:center;justify-content:center;white-space:nowrap}.modal-body[_ngcontent-%COMP%]   small.text-muted[_ngcontent-%COMP%]{display:block;margin-top:6px;font-size:12px;color:var(--text-secondary, #6c757d)}.modal-actions[_ngcontent-%COMP%]{padding:1rem 1.5rem;border-top:1px solid #dee2e6;display:flex;justify-content:flex-end;gap:1rem}.modal-actions[_ngcontent-%COMP%]   .btn[_ngcontent-%COMP%]{padding:10px 20px;border:none;border-radius:4px;cursor:pointer;font-weight:500;display:flex;align-items:center;gap:6px;transition:all .3s ease;font-size:14px}.modal-actions[_ngcontent-%COMP%]   .btn[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{font-size:14px}.modal-actions[_ngcontent-%COMP%]   .btn[_ngcontent-%COMP%]:disabled{opacity:.6;cursor:not-allowed}.modal-actions[_ngcontent-%COMP%]   .btn.btn-secondary[_ngcontent-%COMP%]{background-color:var(--secondary, #17a3df);color:#fff}.modal-actions[_ngcontent-%COMP%]   .btn.btn-secondary[_ngcontent-%COMP%]:hover:not(:disabled){background-color:#1281b1}.modal-actions[_ngcontent-%COMP%]   .btn.btn-primary[_ngcontent-%COMP%]{background-color:var(--primary, #145881);color:#fff}.modal-actions[_ngcontent-%COMP%]   .btn.btn-primary[_ngcontent-%COMP%]:hover:not(:disabled){background-color:#0d3a55}@keyframes _ngcontent-%COMP%_modalIn{0%{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}@media (max-width: 576px){.modal-content[_ngcontent-%COMP%]{width:95%;max-width:95%}.modal-body[_ngcontent-%COMP%]   .select-group[_ngcontent-%COMP%]{flex-direction:column;align-items:stretch}.modal-body[_ngcontent-%COMP%]   .select-group[_ngcontent-%COMP%]   .refresh[_ngcontent-%COMP%]{width:100%}}"],data:{animation:[R("modalAnimation",[I(":enter",[C({opacity:0,transform:"translateY(-20px)"}),w("200ms ease-out",C({opacity:1,transform:"translateY(0)"}))]),I(":leave",[w("150ms ease-in",C({opacity:0,transform:"translateY(-20px)"}))])])]}})}}return i})();export{xe as a};
